<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CCB | Contagem EnR | Login</title>

  <!-- Official CDNs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#f3f3f4;
      --muted:#7b8a97;
      --primary:#1ab394;
      --primary-dark:#18a689;
      --border:#e7eaec;
      --icon:#8a95a6;
    }
    html,body{height:100%}
    body{background:var(--bg);display:grid;place-items:center;margin:0}
    .login-wrap{width:min(440px,92vw);padding:10px 16px 28px}
    .logo-black{display:block;margin:6px auto 6px auto;width:240px;height:auto}
    h3{font-weight:700;margin:10px 0 8px 0;text-align:center}
    .lead-text{color:var(--muted);text-align:center;max-width:36rem;margin:0 auto 6px auto;line-height:1.35}
    .sub-text{color:var(--muted);text-align:center;margin:8px 0 14px 0}
    /* Inputs */
    .input-group .input-group-text{
      background:#fff;border-color:var(--border);color:var(--icon);
      border-right:0;
      padding:8px 10px;
    }
    .form-control, .form-select{
      border-color:var(--border);padding:10px 12px;border-left:0;
    }
    .input-group:has(.form-control:focus), .input-group:has(.form-select:focus){
      outline:0; box-shadow:0 0 0 3px rgba(59,130,246,.12);
      border-radius:.375rem;
    }
    .fa-fw{width:1.1rem;text-align:center;font-size:.95rem} /* icons a bit smaller & gray */
    .password-container{position:relative}
    .toggle-password{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--icon);
      cursor:pointer;z-index:2;
    }
    .toggle-password:hover{color:var(--primary-dark)}
    .btn-login{background:var(--primary);border-color:var(--primary);width:100%}
    .btn-login:hover{background:var(--primary-dark);border-color:var(--primary-dark)}
    .btn-primary{background:var(--primary) !important;border-color:var(--primary) !important}
    .btn-primary:hover{background:var(--primary-dark) !important;border-color:var(--primary-dark) !important}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .muted{color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .card-pad{padding:0 6px}
    .link-primary{color:var(--primary);text-decoration:none}
    .link-primary:hover{color:var(--primary-dark);text-decoration:underline}
    .btn-white{background:#fff;border:1px solid var(--border);color:var(--muted)}
    .btn-white:hover{background:var(--bg);border-color:var(--primary);color:var(--primary)}
    @media (max-width:420px){
      .logo-black{width:200px}
      .login-wrap{padding:8px 10px 22px}
    }

    /* ===== ESTILOS SWEETALERT2 MODERNOS ===== */
    .swal2-popup-modern {
      border-radius: 16px !important;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
      border: none !important;
      overflow: hidden !important;
      position: relative !important;
    }

    /* Sombras espec√≠ficas por tipo de toast */
    .swal2-popup-modern[style*="background: linear-gradient(135deg, #10b981"] {
      box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.3), 0 10px 10px -5px rgba(16, 185, 129, 0.1) !important;
    }

    .swal2-popup-modern[style*="background: linear-gradient(135deg, #ef4444"] {
      box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.3), 0 10px 10px -5px rgba(239, 68, 68, 0.1) !important;
    }

    .swal2-popup-modern[style*="background: linear-gradient(135deg, #f59e0b"] {
      box-shadow: 0 20px 25px -5px rgba(245, 158, 11, 0.3), 0 10px 10px -5px rgba(245, 158, 11, 0.1) !important;
    }

    .swal2-popup-modern[style*="background: linear-gradient(135deg, #3b82f6"] {
      box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.3), 0 10px 10px -5px rgba(59, 130, 246, 0.1) !important;
    }

    .swal2-popup-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      pointer-events: none;
      z-index: 1;
    }

    .swal2-title-modern {
      font-size: 18px !important;
      font-weight: 700 !important;
      margin-bottom: 8px !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      z-index: 2 !important;
    }

    .swal2-content-modern {
      font-size: 14px !important;
      font-weight: 500 !important;
      opacity: 0.95 !important;
      margin-top: 0 !important;
      position: relative !important;
      z-index: 2 !important;
    }

    .swal2-icon-modern {
      width: 32px !important;
      height: 32px !important;
      border: 3px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 50% !important;
      position: relative !important;
      z-index: 2 !important;
    }

    .swal2-timer-progress-bar-modern {
      height: 4px !important;
      background: rgba(255, 255, 255, 0.3) !important;
      border-radius: 0 0 16px 16px !important;
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      z-index: 3 !important;
    }

    .swal2-timer-progress-bar-modern .swal2-timer-progress-bar-fill {
      background: rgba(255, 255, 255, 0.8) !important;
      border-radius: 0 0 16px 16px !important;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
    }

    /* Bot√£o de fechar moderno */
    .swal2-close {
      color: rgba(255, 255, 255, 0.8) !important;
      font-size: 20px !important;
      font-weight: 600 !important;
      top: 16px !important;
      right: 16px !important;
      width: 32px !important;
      height: 32px !important;
      border-radius: 50% !important;
      background: rgba(255, 255, 255, 0.1) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      z-index: 2 !important;
    }

    .swal2-close:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      color: #ffffff !important;
      transform: scale(1.1) !important;
    }

    /* Anima√ß√µes modernas */
    .swal2-toast {
      animation: swal2-toast-show 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    @keyframes swal2-toast-show {
      0% {
        transform: translateX(100%) scale(0.8) !important;
        opacity: 0 !important;
      }
      60% {
        transform: translateX(-10px) scale(1.02) !important;
        opacity: 1 !important;
      }
      100% {
        transform: translateX(0) scale(1) !important;
        opacity: 1 !important;
      }
    }

    /* Efeito de brilho sutil no hover */
    .swal2-popup-modern:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
  </style>
</head>
<body class="gray-bg">
  <div class="animate__animated animate__fadeInDown login-wrap">
    <div class="text-center mb-2">
      <a href="./index.html"><img class="logo-black" src="https://congregacaocristanobrasil.org.br/assets/images/logo-ccb-light.png" alt="CONGREGA√á√ÉO CRIST√É NO BRASIL"></a>
    </div>

    <h3 class="text-center">Bem-vindos ao SAC</h3>
    <p class="lead-text">Sistema Administrativo de Contagem, criado para facilitar a administra√ß√£o Musical da Congrega√ß√£o Crist√£ no Brasil 
      <br> <strong>Regional Itapevi</strong>.</p>
    <p class="sub-text">Fa√ßa o login para acessar o Sistema</p>

    <form id="loginForm" method="POST" action="/" class="card-pad" autocomplete="on">
      <input type="hidden" name="csrf_token" value="ImY3ODA4MzljODM1N2NlZDEyMjdkMmNjOTliYzkzZTkyNmQ4Njk3MjYi.aOf3Cg.p4Eq9lP1esfWvgOrnqWzEXzlfyk">
      
      <!-- Username -->
      <div class="form-group mb-2">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-envelope fa-fw"></i></span>
          <input type="text" class="form-control" name="username" id="username" placeholder="Nome de usu√°rio" required>
        </div>
      </div>

      <!-- Senha -->
      <div class="form-group password-container mb-2">
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-lock fa-fw"></i></span>
          <input type="password" class="form-control" name="senha" id="password" placeholder="Senha" required>
          <span class="toggle-password" id="togglePassword" onclick="togglePassword()" title="Mostrar/ocultar senha">
            <i class="fa fa-eye"></i>
          </span>
        </div>
      </div>

      <!-- Local do Ensaio -->
      <div class="form-group mb-3">
        <div class="input-group">
          <span class="input-group-text"><i class="fa-solid fa-location-dot fa-fw"></i></span>
          <select class="form-select" id="localEnsaio" required>
            <option value="">Local do Ensaio</option>
            <option value="Cotia">Cotia</option>
            <option value="Caucaia do Alto">Caucaia do Alto</option>
            <option value="Fazendinha">Fazendinha</option>
            <option value="Itapevi">Itapevi</option>
            <option value="Jandira">Jandira</option>
            <option value="Pirapora">Pirapora</option>
            <option value="Vargem Grande">Vargem Grande</option>
          </select>
        </div>
      </div>

      <button type="submit" class="btn btn-primary d-block w-100 mb-2">Login</button>

      <div class="text-center">        
        <p class="text-muted text-center"><small>N√£o tem uma conta?</small></p>
        <div class="d-grid">
          <a class="btn btn-sm btn-white btn-block" href="./register.html">Criar conta</a>
        </div>
      </div>
    </form>

    <div class="footer">
      <small><strong>¬©</strong> Aplicativo de Contagem v1.1.2  
        <br> <a class="link-primary" href="https://congregacaocristanobrasil.org.br/" target="_blank" rel="noopener">Congrega√ß√£o Crist√£ no Brasil</a> 
        <br> <span class="fw-bold">Regional Itapevi</span></small>
    </div>
  </div>

  <!-- Official CDNs JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== CONFIGURE AQUI ======
    const SUPABASE_URL = "https://wfqehmdawhfjqbqpjapp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmcWVobWRhd2hmanFicXBqYXBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NDI0ODIsImV4cCI6MjA3MzAxODQ4Mn0.lFfEZKIVS7dqk48QFW4IvpRcJsgQnMjYE3iUqsrXsFg";
    const REDIRECT_AFTER_LOGIN = "./index.html";
    const REDIRECT_REGISTER = "./register.html";
    // ============================

    // Detectar se √© mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // Fun√ß√£o para mostrar toast moderno
    function showToast(type, title, message = '', duration = 3000) {
      if (typeof Swal !== 'undefined') {
        const config = {
          toast: true,
          position: isMobile ? 'top' : 'top-end',
          showConfirmButton: false,
          timer: duration,
          timerProgressBar: true,
          width: isMobile ? '90%' : '400px',
          padding: isMobile ? '1rem' : '1.5rem',
          didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
            
            // Adicionar anima√ß√£o de entrada suave
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            setTimeout(() => {
              toast.style.transform = 'translateX(0)';
            }, 10);
          },
          willClose: (toast) => {
            toast.style.transform = 'translateX(100%)';
          }
        };

        // Configura√ß√µes espec√≠ficas por tipo com design moderno
        const typeConfigs = {
          success: {
            icon: 'success',
            iconColor: '#ffffff',
            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            color: '#ffffff'
          },
          error: {
            icon: 'error',
            iconColor: '#ffffff',
            background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
            color: '#ffffff'
          },
          warning: {
            icon: 'warning',
            iconColor: '#ffffff',
            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            color: '#ffffff'
          },
          info: {
            icon: 'info',
            iconColor: '#ffffff',
            background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
            color: '#ffffff'
          }
        };

        const typeConfig = typeConfigs[type] || typeConfigs.success;

        Swal.fire({
          ...config,
          ...typeConfig,
          title: title,
          text: message,
          customClass: {
            popup: 'swal2-popup-modern',
            title: 'swal2-title-modern',
            content: 'swal2-content-modern',
            timerProgressBar: 'swal2-timer-progress-bar-modern',
            icon: 'swal2-icon-modern'
          }
        });
      } else {
        // Fallback para alert nativo
        alert(`${title}: ${message}`);
      }
    }

    // Traduz mensagens comuns de erro de autentica√ß√£o do Supabase para pt-BR
    function translateSupabaseErrorMessage(originalMessage) {
      if (!originalMessage) return 'Ocorreu um erro ao realizar o login.';
      const msg = String(originalMessage);

      // Mapeamentos espec√≠ficos
      if (msg.includes('Invalid login credentials')) return 'Credenciais de login inv√°lidas.';
      if (msg.includes('Email not confirmed')) return 'E-mail n√£o confirmado. Verifique sua caixa de entrada.';
      if (msg.includes('User not found')) return 'Usu√°rio n√£o encontrado.';
      if (msg.includes('Invalid email or password')) return 'E-mail ou senha inv√°lidos.';
      if (msg.includes('JWT expired')) return 'Sess√£o expirada. Fa√ßa login novamente.';
      if (msg.includes('rate limit') || msg.includes('Rate limit')) return 'Muitas tentativas. Tente novamente em instantes.';

      // Falhas gen√©ricas de rede/servidor
      if (msg.includes('Network') || msg.includes('Failed to fetch')) return 'Falha de rede. Verifique sua conex√£o.';
      if (msg.includes('FetchError') || msg.includes('timeout')) return 'Tempo de resposta esgotado. Tente novamente.';

      // Retorno padr√£o caso n√£o haja mapeamento
      return msg;
    }

    // Elemento 'year' n√£o existe no HTML - linha removida

    // Fun√ß√£o para mostrar/ocultar senha
    function togglePassword() {
      const input = document.getElementById('password');
      const icon = document.querySelector('#togglePassword i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    }

    // Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Login + leitura do role em 'profiles' (user/master)
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const localEnsaio = document.getElementById('localEnsaio').value;

      if (!email || !password || !localEnsaio) {
        showToast('warning', 'Campos obrigat√≥rios', 'Preencha e-mail, senha e Local do Ensaio.');
        return;
      }

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        showToast('error', 'Falha no login', translateSupabaseErrorMessage(error.message || String(error)));
        return;
      }

      const user = data.user;
      let role = 'user';
      // busca na tabela profiles (SQL fornecido anteriormente)
      const { data: prof, error: errProf } = await supabase
        .from('profiles')
        .select('role, name')
        .eq('id', user.id)
        .single();

      if (!errProf && prof?.role) role = prof.role;
      
      // Debug para verificar o que est√° sendo retornado
      console.log('üîç Dados do perfil:', prof);

      // Persist√™ncia local para o restante da aplica√ß√£o
      localStorage.setItem('session_user', user?.email || email);
      localStorage.setItem('session_role', role);
      localStorage.setItem('session_local', localEnsaio);
      localStorage.setItem('session_classe_organista', ''); // Campo removido do banco
      localStorage.setItem('session_time', String(Date.now()));
      
      // Salvar nome do perfil se dispon√≠vel
      if (prof?.name) {
        localStorage.setItem('session_name', prof.name);
        console.log('‚úÖ Nome do perfil salvo:', prof.name);
      } else {
        console.warn('‚ö†Ô∏è Nome do perfil n√£o encontrado');
      }

      window.location.href = REDIRECT_AFTER_LOGIN;
    });

    // Rotas auxiliares - elementos n√£o existem no HTML atual
    // document.getElementById('registerBtn') - elemento n√£o existe
    // document.getElementById('forgotLink') - elemento n√£o existe
  </script>
</body>
</html>
