<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Criar UsuÃ¡rios CCB - Supabase</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style> body{padding:20px} code{user-select:all} </style>
</head>
<body>
  <div class="container">
    <h1 class="h4 mb-3">ğŸ”§ Criar UsuÃ¡rios CCB no Supabase</h1>
    <p class="text-muted">Cria os usuÃ¡rios que foram deletados acidentalmente.</p>

    <div class="alert alert-info">
      <b>ğŸ“‹ UsuÃ¡rios que serÃ£o criados:</b>
      <ul class="mb-0">
        <li>Ricardo Grangeiro - ricardograngeiro@gmail.com (master)</li>
        <li>Secretaria Musical Itapevi - secretariaregionalitapevi1@gmail.com (master)</li>
        <li>Eduardo Oliveira - eduardooliveira@gmail.com (master)</li>
      </ul>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">SUPABASE_URL</label>
        <input id="url" class="form-control" placeholder="https://xxxxx.supabase.co">
      </div>
      <div class="col-md-6">
        <label class="form-label">SUPABASE_ANON_KEY</label>
        <input id="anon" class="form-control" placeholder="eyJhbGciOi...">
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="btnCriarTodos" class="btn btn-success">ğŸš€ Criar Todos os UsuÃ¡rios</button>
      <button id="btnVerificar" class="btn btn-info">ğŸ” Verificar UsuÃ¡rios</button>
      <button id="btnReenviarEmail" class="btn btn-warning">ğŸ“§ Reenviar Email ConfirmaÃ§Ã£o</button>
      <button id="btnLimpar" class="btn btn-secondary">ğŸ§¹ Limpar Log</button>
    </div>

    <pre id="out" class="mt-3 bg-light p-3 border rounded" style="min-height:140px;white-space:pre-wrap"></pre>
  </div>

<script>
const out = document.getElementById('out');
const log = (msg)=> out.textContent += (msg + "\\n");

// Lista de usuÃ¡rios para criar
const usuarios = [
    {
        nome: 'Ricardo Grangeiro',
        email: 'ricardograngeiro@gmail.com',
        senha: 'admin123',
        nivel: 'master'
    },
    {
        nome: 'Secretaria Musical Itapevi',
        email: 'secretariaregionalitapevi1@gmail.com',
        senha: 'admin123',
        nivel: 'master'
    },
    {
        nome: 'Eduardo Oliveira',
        email: 'eduardooliveira@gmail.com',
        senha: 'admin123',
        nivel: 'master'
    }
];

function getClient(){
  const url = document.getElementById('url').value.trim();
  const anon = document.getElementById('anon').value.trim();
  if(!url || !anon){ alert('Preencha SUPABASE_URL e ANON_KEY'); throw new Error('missing keys'); }
  return window.supabase.createClient(url, anon);
}

// FunÃ§Ã£o para criar um usuÃ¡rio especÃ­fico
async function criarUsuario(usuario) {
    try {
        log(`â†’ Criando usuÃ¡rio: ${usuario.nome} (${usuario.email})`);
        
        const sb = getClient();
        
        // 1. Criar usuÃ¡rio na autenticaÃ§Ã£o
        const { data: authData, error: authError } = await sb.auth.signUp({ 
            email: usuario.email, 
            password: usuario.senha 
        });
        
        if (authError) {
            log(`âŒ Erro ao criar usuÃ¡rio ${usuario.email}: ${authError.message}`);
            return false;
        }
        
        if (!authData.user) {
            log(`âš ï¸ UsuÃ¡rio ${usuario.email} requer confirmaÃ§Ã£o de email`);
            log(`ğŸ“§ Email de confirmaÃ§Ã£o enviado para ${usuario.email}`);
            log(`ğŸ’¡ Verifique a caixa de entrada e clique no link de confirmaÃ§Ã£o`);
            return false;
        }
        
        log(`âœ… UsuÃ¡rio ${usuario.email} criado com ID: ${authData.user.id}`);
        
        // 2. Criar perfil na tabela profiles
        const { error: profileError } = await sb
            .from('profiles')
            .upsert({
                id: authData.user.id,
                email: usuario.email,
                role: usuario.nivel
            }, { onConflict: 'id' });
        
        if (profileError) {
            log(`âŒ Erro ao criar perfil para ${usuario.email}: ${profileError.message}`);
            return false;
        }
        
        log(`âœ… Perfil criado para ${usuario.email} com role: ${usuario.nivel}`);
        return true;
        
    } catch (error) {
        log(`âŒ Erro geral ao criar usuÃ¡rio ${usuario.email}: ${error.message}`);
        return false;
    }
}

// FunÃ§Ã£o para criar todos os usuÃ¡rios
async function criarTodosUsuarios() {
    log('ğŸš€ Iniciando criaÃ§Ã£o de usuÃ¡rios...');
    
    let sucessos = 0;
    let falhas = 0;
    
    for (const usuario of usuarios) {
        const sucesso = await criarUsuario(usuario);
        if (sucesso) {
            sucessos++;
        } else {
            falhas++;
        }
        
        // Pequena pausa entre criaÃ§Ãµes
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    log(`\\nğŸ“Š Resumo:`);
    log(`âœ… Sucessos: ${sucessos}`);
    log(`âŒ Falhas: ${falhas}`);
    log(`ğŸ“ Total: ${usuarios.length}`);
}

// FunÃ§Ã£o para verificar usuÃ¡rios existentes
async function verificarUsuarios() {
    try {
        log('ğŸ” Verificando usuÃ¡rios existentes...');
        
        const sb = getClient();
        const emails = usuarios.map(u => u.email);
        
        const { data, error } = await sb
            .from('profiles')
            .select('email, role')
            .in('email', emails);
        
        if (error) {
            log(`âŒ Erro ao verificar usuÃ¡rios: ${error.message}`);
            return;
        }
        
        log('ğŸ“‹ UsuÃ¡rios encontrados:');
        data.forEach(user => {
            log(`  - ${user.email} (${user.role})`);
        });
        
        const usuariosNaoEncontrados = emails.filter(email => 
            !data.some(user => user.email === email)
        );
        
        if (usuariosNaoEncontrados.length > 0) {
            log('\\nâŒ UsuÃ¡rios nÃ£o encontrados:');
            usuariosNaoEncontrados.forEach(email => {
                log(`  - ${email}`);
            });
        }
        
    } catch (error) {
        log(`âŒ Erro ao verificar usuÃ¡rios: ${error.message}`);
    }
}

// FunÃ§Ã£o para reenviar email de confirmaÃ§Ã£o
async function reenviarEmailConfirmacao() {
    try {
        log('ğŸ“§ Reenviando emails de confirmaÃ§Ã£o...');
        
        const sb = getClient();
        
        for (const usuario of usuarios) {
            log(`â†’ Reenviando email para: ${usuario.email}`);
            
            const { error } = await sb.auth.resend({
                type: 'signup',
                email: usuario.email
            });
            
            if (error) {
                log(`âŒ Erro ao reenviar email para ${usuario.email}: ${error.message}`);
            } else {
                log(`âœ… Email de confirmaÃ§Ã£o reenviado para ${usuario.email}`);
            }
        }
        
        log('\\nğŸ’¡ Verifique as caixas de entrada dos emails!');
        
    } catch (error) {
        log(`âŒ Erro ao reenviar emails: ${error.message}`);
    }
}

// Event listeners
document.getElementById('btnCriarTodos').addEventListener('click', criarTodosUsuarios);
document.getElementById('btnVerificar').addEventListener('click', verificarUsuarios);
document.getElementById('btnReenviarEmail').addEventListener('click', reenviarEmailConfirmacao);
document.getElementById('btnLimpar').addEventListener('click', () => {
    out.textContent = 'Log limpo...\\n';
});

// Log inicial
log('ğŸ”§ Sistema de criaÃ§Ã£o de usuÃ¡rios carregado');
log('ğŸ“ Preencha as credenciais do Supabase e clique em "Criar Todos os UsuÃ¡rios"');
</script>
</body>
</html>
