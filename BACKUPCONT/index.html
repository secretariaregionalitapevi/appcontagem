<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CCB | Contagem EnR">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="msapplication-TileColor" content="#1a1a1a">
  <meta name="msapplication-navbutton-color" content="#1a1a1a">
  <meta name="HandheldFriendly" content="true">
  <meta name="MobileOptimized" content="width">
  <title>CCB | Contagem EnR</title>
  
  <!-- üé® Favicon e √çcones PWA -->
  <link rel="icon" type="image/png" href="ccb.png">
  <link rel="shortcut icon" type="image/png" href="ccb.png">
  <link rel="apple-touch-icon" href="ccb.png">
  <link rel="apple-touch-icon" sizes="180x180" href="ccb.png">
  <link rel="icon" type="image/png" sizes="32x32" href="ccb.png">
  <link rel="icon" type="image/png" sizes="16x16" href="ccb.png">
  <link rel="mask-icon" href="ccb.png" color="#1a1a1a">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- üöÄ OTIMIZA√á√ÉO: Removido carregamento duplicado do SweetAlert2 - ser√° carregado mais abaixo -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/db01130de2.js" crossorigin="anonymous"></script>
  
  <!-- Configura√ß√µes Centralizadas -->
  <script src="config.js"></script>
  
  <!-- CSS para garantir que SweetAlert2 seja sempre vis√≠vel e centralizado -->
  <style>
    /* üöÄ CORRE√á√ÉO: Garantir que o modal seja interativo no ambiente online */
    .modal {
      pointer-events: auto !important;
      z-index: 1055 !important;
    }
    
    .modal-dialog {
      pointer-events: auto !important;
      max-width: 90vw !important;
      margin: 1rem auto !important;
    }
    
    .modal-content {
      pointer-events: auto !important;
      border: none !important;
      border-radius: 0.5rem !important;
    }
    
    .modal input,
    .modal select,
    .modal textarea {
      pointer-events: auto !important;
      font-size: 16px !important; /* Previne zoom no mobile */
    }
    
    .modal-backdrop {
      pointer-events: none !important; /* CORRE√á√ÉO: Backdrop n√£o deve bloquear cliques */
      z-index: 1040 !important;
      background-color: rgba(0, 0, 0, 0.5) !important;
    }
    
    /* CORRE√á√ÉO: Garantir que o backdrop n√£o apare√ßa quando n√£o deveria */
    .modal-backdrop.show {
      opacity: 0.5 !important;
    }
    
    /* CORRE√á√ÉO: Garantir que n√£o haja backdrop duplicado */
    .modal-backdrop + .modal-backdrop {
      display: none !important;
    }

    body.modal-open {
      overflow: hidden !important;
      /* CORRE√á√ÉO MOBILE: Permitir scroll dentro do modal */
      touch-action: pan-y !important;
    }
    
    /* CORRE√á√ÉO MOBILE: Permitir scroll no modal */
    .modal.inmodal .modal-body {
      overflow-y: auto !important;
      max-height: 70vh !important;
      -webkit-overflow-scrolling: touch !important;
    }
    
    .modal.inmodal .modal-content {
      max-height: 80vh !important;
      overflow: hidden !important;
    }


    
    /* CORRE√á√ÉO: Garantir que o modal seja totalmente interativo */
    .modal.inmodal .modal-content {
      pointer-events: auto !important;
    }
    
    .modal.inmodal .modal-content * {
      pointer-events: auto !important;
    }
    
    .modal.show {
      pointer-events: auto !important;
    }
    
    /* CORRE√á√ÉO CR√çTICA: Evitar piscar do modal na recarga da p√°gina */
    /* Garantir que o modal esteja oculto desde o in√≠cio, antes do JavaScript executar */
    #modalNovaComum {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
    
    /* CORRE√á√ÉO ADICIONAL: Garantir que o modal n√£o apare√ßa durante carregamento */
    #modalNovaComum:not(.show) {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
    
    /* Permitir que o modal apare√ßa apenas quando explicitamente aberto via Bootstrap */
    #modalNovaComum.show {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out !important;
    }
    
    /* Fallback: garantir que mesmo sem classe show, o modal esteja oculto */
    .modal.inmodal:not(.show) {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }
    
    .modal.inmodal.show {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out !important;
    }
    
    /* Corre√ß√µes espec√≠ficas para mobile */
    @media (max-width: 768px) {
      .modal-dialog {
        max-width: 95vw !important;
        margin: 0.5rem auto !important;
        max-height: 90vh !important;
        display: flex !important;
        flex-direction: column !important;
        padding: 0 1rem !important; /* CORRE√á√ÉO: Padding lateral para celulares */
      }
      
      /* CORRE√á√ÉO: Padding espec√≠fico para diferentes tamanhos de tela */
      @media (max-width: 320px) {
        .modal-dialog {
          padding: 0 0.5rem !important; /* Padding m√≠nimo para telas muito pequenas */
        }
      }
      
      @media (min-width: 321px) and (max-width: 480px) {
        .modal-dialog {
          padding: 0 0.75rem !important; /* Padding menor para telas pequenas */
        }
      }
      
      @media (min-width: 481px) and (max-width: 768px) {
        .modal-dialog {
          padding: 0 1.25rem !important; /* Maior padding para telas m√©dias */
        }
      }
      
      /* CORRE√á√ÉO: Padding para tablets em modo retrato */
      @media (min-width: 769px) and (max-width: 1024px) {
        .modal-dialog {
          padding: 0 2rem !important; /* Padding maior para tablets */
        }
      }
      
      .modal-content {
        border-radius: 0.5rem !important; /* CORRE√á√ÉO: Border radius maior para melhor apar√™ncia */
        max-height: 90vh !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important; /* CORRE√á√ÉO: Sombra mais suave */
      }
      
      .modal-header {
        padding: 0.75rem 1rem !important;
        flex-shrink: 0 !important;
      }
      
      /* CORRE√á√ÉO: Padding do modal-header para diferentes tamanhos */
      @media (max-width: 320px) {
        .modal-header {
          padding: 0.375rem 0.5rem !important; /* Padding m√≠nimo para telas muito pequenas */
        }
      }
      
      @media (min-width: 321px) and (max-width: 480px) {
        .modal-header {
          padding: 0.5rem 0.75rem !important; /* Padding menor para telas pequenas */
        }
      }
      
      @media (min-width: 481px) and (max-width: 768px) {
        .modal-header {
          padding: 1rem 1.25rem !important; /* Padding maior para telas m√©dias */
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .modal-header {
          padding: 1.25rem 1.5rem !important; /* Padding maior para tablets */
        }
      }
      
      .modal-body {
        padding: 1rem !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
        flex: 1 !important;
        min-height: 0 !important;
      }
      
      /* CORRE√á√ÉO: Padding do modal-body para diferentes tamanhos */
      @media (max-width: 320px) {
        .modal-body {
          padding: 0.5rem !important; /* Padding m√≠nimo para telas muito pequenas */
        }
      }
      
      @media (min-width: 321px) and (max-width: 480px) {
        .modal-body {
          padding: 0.75rem !important; /* Padding menor para telas pequenas */
        }
      }
      
      @media (min-width: 481px) and (max-width: 768px) {
        .modal-body {
          padding: 1.25rem !important; /* Padding maior para telas m√©dias */
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .modal-body {
          padding: 1.5rem !important; /* Padding maior para tablets */
        }
      }
      
      .modal-footer {
        flex-shrink: 0 !important;
        padding: 0.75rem 1rem !important;
      }
      
      /* CORRE√á√ÉO: Padding do modal-footer para diferentes tamanhos */
      @media (max-width: 320px) {
        .modal-footer {
          padding: 0.375rem 0.5rem !important; /* Padding m√≠nimo para telas muito pequenas */
        }
      }
      
      @media (min-width: 321px) and (max-width: 480px) {
        .modal-footer {
          padding: 0.5rem 0.75rem !important; /* Padding menor para telas pequenas */
        }
      }
      
      @media (min-width: 481px) and (max-width: 768px) {
        .modal-footer {
          padding: 1rem 1.25rem !important; /* Padding maior para telas m√©dias */
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .modal-footer {
          padding: 1.25rem 1.5rem !important; /* Padding maior para tablets */
        }
      }
      
      /* CORRE√á√ÉO: Permitir scroll suave no mobile */
      .modal.inmodal {
        touch-action: pan-y !important;
      }
      
      .modal.inmodal .modal-body {
        touch-action: pan-y !important;
      }
    }
    /* üö® CORRE√á√ÉO: Remover estilos CSS personalizados que quebram a renderiza√ß√£o do SweetAlert2 */
    /* O SweetAlert2 tem seus pr√≥prios estilos padr√£o que funcionam corretamente */
    /* Apenas garantir z-index m√≠nimo para n√£o ficar atr√°s de outros elementos */
    .swal2-container {
      z-index: 999999 !important;
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* CSS espec√≠fico para alerta de duplicidade */
    .swal-duplicity-popup {
      z-index: 1000000 !important;
      position: relative !important;
      margin: 0 !important;
      width: 500px !important;
      max-width: 90vw !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* üîß CORRE√á√ÉO EST√âTICA: Bot√µes ajustados ao tamanho do texto (compacto) */
    .swal-duplicity-confirm,
    .swal-duplicity-cancel {
      padding: 0.5rem 1rem !important;
      margin: 0.25rem !important;
      font-size: 1rem !important;
      font-weight: 500 !important;
      border-radius: 0.5rem !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.2s ease !important;
      min-width: unset !important;
      width: auto !important;
      white-space: nowrap !important;
      box-sizing: border-box !important;
    }
    
    .swal-duplicity-confirm i,
    .swal-duplicity-cancel i {
      margin-right: 0.375rem !important;
      font-size: 1rem !important;
      flex-shrink: 0 !important;
    }
    
    .swal-duplicity-confirm:hover,
    .swal-duplicity-cancel:hover {
      transform: translateY(-1px) !important;
    }
    
    .swal-duplicity-confirm:hover {
      box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3) !important;
    }
    
    .swal-duplicity-cancel:hover {
      box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3) !important;
    }
    
    /* üîß CSS espec√≠fico para alerta de nova vers√£o */
    .swal-version-popup {
      z-index: 1000000 !important;
      position: relative !important;
      margin: 0 !important;
      width: 500px !important;
      max-width: 90vw !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    .swal-version-confirm,
    .swal-version-cancel,
    .swal2-confirm,
    .swal2-cancel {
      width: 100% !important;
      min-width: 100% !important;
      padding: 0.75rem 1.5rem !important;
      margin: 0.25rem 0 !important;
      font-size: 1rem !important;
      font-weight: 500 !important;
      border-radius: 0.5rem !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.2s ease !important;
    }
    
    .swal-version-confirm i,
    .swal-version-cancel i,
    .swal2-confirm i,
    .swal2-cancel i {
      margin-right: 0.5rem !important;
      font-size: 1rem !important;
    }
    
    .swal-version-confirm:hover,
    .swal2-confirm:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3) !important;
    }
    
    .swal-version-cancel:hover,
    .swal2-cancel:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3) !important;
    }
    
    /* üîß CORRE√á√ÉO MOBILE: Garantir que o alerta de duplicidade apare√ßa no mobile */
    @media (max-width: 768px) {
      .swal2-container {
        z-index: 999999 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 1rem !important;
      }
      
      .swal-duplicity-popup {
        width: 90% !important;
        max-width: 90vw !important;
        margin: 0 !important;
        padding: 1.5rem !important;
      }
      
      /* üîß CORRE√á√ÉO EST√âTICA MOBILE: Bot√µes ajustados ao tamanho do texto no mobile (compacto) */
      .swal-duplicity-confirm,
      .swal-duplicity-cancel {
        padding: 0.5rem 0.875rem !important;
        font-size: 0.95rem !important;
        margin: 0.25rem !important;
        min-width: unset !important;
        width: auto !important;
        white-space: nowrap !important;
        box-sizing: border-box !important;
      }
      
      .swal2-actions {
        gap: 0.5rem !important;
        justify-content: center !important;
      }
      
      /* üîß CORRE√á√ÉO MOBILE: Alerta de vers√£o no mobile */
      .swal-version-popup {
        width: 90% !important;
        max-width: 90vw !important;
        margin: 0 !important;
        padding: 1.5rem !important;
      }
      
      .swal-version-confirm,
      .swal-version-cancel,
      .swal2-confirm,
      .swal2-cancel {
        width: 100% !important;
        min-width: 100% !important;
        padding: 0.875rem 1.25rem !important;
        font-size: 0.95rem !important;
      }
      
      .swal2-backdrop {
        z-index: 999998 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        display: block !important;
        visibility: visible !important;
        opacity: 0.4 !important;
      }
    }
    /* Corre√ß√£o forte para mobile: manter a√ß√µes dentro da faixa do header */
    @media (max-width: 768px) {
      .header {
        padding-bottom: 8px !important; /* cria espa√ßo para a segunda linha */
      }
      .header-content {
        height: auto !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        row-gap: 6px !important;
      }
      .header-actions {
        position: relative !important;
        width: 100% !important;
        order: 3 !important;
        justify-content: flex-end !important;
        margin-top: 0 !important;
      }
    }

    /* Telas estreitas (iPhone SE/8/XS) */
    @media (max-width: 375px) {
      .header { padding-bottom: 6px !important; }
      .header-content { row-gap: 4px !important; }
      .header-actions {
        gap: 4px !important;
        justify-content: flex-end !important;
        order: 3 !important;
      }
      .action-btn { width: 26px !important; height: 26px !important; }
    }

    /* Telas muito estreitas (‚â§360px) */
    @media (max-width: 360px) {
      .header { padding-bottom: 4px !important; }
      .header-actions { gap: 3px !important; }
      .action-btn { width: 24px !important; height: 24px !important; }
    }
  </style>
 
  <!-- PWA Manifest -->
  <script>
    // S√≥ carrega o manifest se n√£o estiver rodando via file://
    if (window.location.protocol !== 'file:') {
      const manifestLink = document.createElement('link');
      manifestLink.rel = 'manifest';
      manifestLink.href = 'manifest.json';
      document.head.appendChild(manifestLink);
      console.log('‚úÖ PWA Manifest carregado');
    } else {
      console.log('‚ÑπÔ∏è Executando via file:// - PWA Manifest desabilitado para evitar erro de CORS');
    }
  </script>
  <!-- üé® Apple Touch Icon (substitu√≠do pelo ccb.png) -->
  <!-- CSS Bootstrap CDN - Funcionando online -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
  <!-- üöÄ OTIMIZA√á√ÉO: CSS do SweetAlert2 vers√£o mais recente -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  
  <!-- CSS Customizado com Modo Dark Funcional -->
  <style>
    /* Vari√°veis CSS para modo dark/light */
    :root {
      /* Modo Light (padr√£o) */
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --accent-color: #007bff;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
    }
    
    /* Modo Dark - Mais Escuro (APENAS quando explicitamente ativado) */
    [data-theme="dark"] {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #21262d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --border-color: #30363d;
      --accent-color: #58a6ff;
      --success-color: #3fb950;
      --warning-color: #d29922;
      --danger-color: #f85149;
      --info-color: #79c0ff;
      --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.7);
    }
    
    
    /* Aplicar vari√°veis */
    body, html {
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* For√ßar fundo escuro uniforme em toda a tela */
    [data-theme="dark"] {
      background-color: var(--bg-primary) !important;
    }
    
    [data-theme="dark"] body,
    [data-theme="dark"] html,
    [data-theme="dark"] .wrapper,
    [data-theme="dark"] .page-wrapper,
    [data-theme="dark"] .content-wrapper,
    [data-theme="dark"] .main-content,
    [data-theme="dark"] .container,
    [data-theme="dark"] .row,
    [data-theme="dark"] .col,
    [data-theme="dark"] div,
    [data-theme="dark"] section,
    [data-theme="dark"] article,
    [data-theme="dark"] aside,
    [data-theme="dark"] header,
    [data-theme="dark"] footer,
    [data-theme="dark"] main {
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
    }
    
    /* Corrigir fundo espec√≠fico para elementos que podem criar faixas */
    [data-theme="dark"] .page-wrapper,
    [data-theme="dark"] .content-wrapper,
    [data-theme="dark"] .main-content {
      background: var(--bg-primary) !important;
      background-color: var(--bg-primary) !important;
      background-image: none !important;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Cards e containers */
    .card, .panel, .ibox {
      background-color: var(--bg-card) !important;
      border: 1px solid var(--border-color) !important;
      color: var(--text-primary) !important;
      box-shadow: var(--shadow-lg) !important;
      transition: all 0.3s ease;
    }
    
    .card-header, .panel-heading, .ibox-title {
      background-color: var(--bg-secondary) !important;
      border-bottom: 1px solid var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
       /* Formul√°rios b√°sicos */
       .form-control, .form-select, input, select, textarea {
         border-radius: 8px;
         padding: 12px 16px;
         font-size: 16px;
         transition: all 0.3s ease;
       }
    
    .form-control::placeholder, input::placeholder, textarea::placeholder {
      color: var(--text-secondary) !important;
    }
    
    /* Bot√µes */
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color) 0%, #0056b3 100%);
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }
    
    /* Toggle de tema removido - usando √≠cones originais */
    
    /* Header Inspinia Style - Baseado no c√≥digo fornecido */
    .header {
      background: #2f4050;
      color: #a7b1c2;
      padding: 8px 0 0 0;
      border-bottom: 1px solid #293846;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      position: relative;
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: auto;
      gap: 15px;
      row-gap: 6px;
      flex-wrap: wrap; /* permite segunda linha */
    }
    
    /* Header Left Section - Logo, t√≠tulo e local */
    .header-left {
      display: flex;
      align-items: center;
      flex: 1 1 auto;
      min-width: 0; /* Permite que o conte√∫do encolha */
    }
    
    /* Brand Section - Logo simples */
    .header-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .brand-logo {
      width: 35px;
      height: 35px;
      background: #1ab394;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }
    
    .brand-text h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      line-height: 1;
    }
    
    /* User Info Section - Layout horizontal simples */
    .header-user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      /* Permite encolher de forma segura sem sobreposi√ß√£o */
      flex: 0 1 auto;
      min-width: 0;
    }
    
    .user-location {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #a7b1c2;
      font-size: 13px;
      margin-top: 2px;
      font-weight: 500;
    }
    
    .user-location i {
      color: #ed5565;
      font-size: 13px;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
      /* Libera encolhimento do conte√∫do textual */
      min-width: 0;
    }
    
    .user-avatar {
      width: 30px;
      height: 30px;
      background: #1ab394;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }
    
    .user-details {
      display: flex;
      flex-direction: column;
      gap: 1px;
      /* Evita que o texto invada o avatar/√≠cones */
      min-width: 0;
      overflow: hidden;
    }
    
    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: #ffffff;
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }
    
    .user-role {
      font-size: 11px;
      color: #a7b1c2;
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }
    
    /* Actions Section - Com espa√ßamento adequado */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1 1 100%;
      order: 3; /* for√ßa ir para a segunda linha */
      justify-content: flex-end;
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #a7b1c2;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      position: relative;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #ffffff;
      transform: translateY(-1px);
    }
    
    .action-btn:active {
      transform: translateY(0px);
    }
    
    
    /* Fallback para √≠cones */
    .icon-fallback {
      display: none;
      font-size: 16px;
    }
    
    /* Se Font Awesome n√£o carregar, mostrar fallback */
    .fa:not(.fa-cog):not(.fa-sign-out) {
      display: none;
    }
    
    .fa:not(.fa-cog):not(.fa-sign-out) + .icon-fallback {
      display: inline;
    }
    
    /* √çcones espec√≠ficos bem vis√≠veis */
    .action-btn i {
      font-size: 14px;
      line-height: 1;
    }
    
    /* Brand Section */
    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .brand-icon {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .brand-icon i {
      font-size: 1.5rem;
      color: white;
    }
    
    .brand-text h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 700;
      color: white;
      line-height: 1.2;
    }
    
    .brand-subtitle {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 400;
      margin-top: 2px;
    }
    
    /* Info Section */
    .header-info {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      flex: 1;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    .info-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }
    
    .info-icon {
      width: 35px;
      height: 35px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .location-info .info-icon {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .user-info .info-icon {
      background: rgba(78, 205, 196, 0.2);
      color: #4ecdc4;
    }
    
    .info-icon i {
      font-size: 1.1rem;
    }
    
    .info-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .info-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .info-value {
      font-size: 0.9rem;
      color: white;
      font-weight: 600;
    }
    
    /* Actions Section */
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-icon {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    .btn-icon i {
      font-size: 1rem;
    }
    
    .action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .action-btn i {
      font-size: 1.1rem;
    }
    
    /* Melhorias nos √≠cones dos campos */
    .field-icon i {
      font-size: 1.1rem;
      color: var(--accent-color);
    }
    
    .btn-primary i {
      margin-right: 0.4rem;
      font-size: 1rem;
    }
    
    /* Controle de √≠cones - Font Awesome vs Fallback */
    .icon-fallback {
      display: none;
      font-size: 1.2rem;
    }
    
    /* Se Font Awesome n√£o carregar, mostrar fallbacks */
    .fa:not(.fa-chart-bar):not(.fa-map-marker):not(.fa-user):not(.fa-cog):not(.fa-sign-out) {
      display: none;
    }
    
    .fa:not(.fa-chart-bar):not(.fa-map-marker):not(.fa-user):not(.fa-cog):not(.fa-sign-out) + .icon-fallback {
      display: inline;
    }
    
    /* Status indicator removido - apenas toggle de tema */

  
    
    /* Dropdowns e menus */
    .dropdown-menu {
      background-color: var(--bg-card) !important;
      border: 1px solid var(--border-color) !important;
      box-shadow: var(--shadow-lg) !important;
    }
    
    .dropdown-item {
      color: var(--text-primary) !important;
    }
    
    .dropdown-item:hover {
      background-color: var(--bg-secondary) !important;
    }
    
    /* Modal */
    .modal-content {
      background-color: var(--bg-card) !important;
      border: 1px solid var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
    .modal-header {
      border-bottom: 1px solid var(--border-color) !important;
    }
    
    .modal-footer {
      border-top: 1px solid var(--border-color) !important;
    }
    
    /* Tablet optimizations */
    @media (max-width: 1024px) {
      .header-content {
        padding: 0 15px;
        gap: 10px;
      }
      
      .header-user-info {
        gap: 10px;
      }
      
      .user-profile {
        gap: 6px;
      }
      
      .header-actions {
        gap: 6px;
      }
      
      .action-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
      
      .user-name {
        font-size: 12px;
      }
      
      .user-role {
        font-size: 10px;
      }
    }
    /* Mobile optimizations */
    @media (max-width: 768px) {
      /* Container Mobile */
      .container {
        padding: 0.75rem !important;
        max-width: 100% !important;
      }
      
      /* Card Mobile */
      .card {
        margin: 0 !important;
        border-radius: 15px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }
      
      .card-header {
        padding: 1rem !important;
        border-bottom: 1px solid #e9ecef !important;
        background: #f8f9fa !important;
        border-radius: 15px 15px 0 0 !important;
      }
      
      .card-title {
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        margin: 0 !important;
        color: #495057 !important;
      }
      
      /* Formul√°rio Mobile */
      .form-group {
        margin-bottom: 1.25rem !important;
      }
      
      .form-label {
        font-size: 0.9rem !important;
        font-weight: 600 !important;
        margin-bottom: 0.5rem !important;
        color: #495057 !important;
      }
      
      .form-control, .form-select, input, select, textarea {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 0.75rem 1rem !important;
        border-radius: 10px !important;
        border: 2px solid #e9ecef !important;
        background: white !important;
        transition: all 0.3s ease !important;
      }
      
      .form-control:focus, .form-select:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
      }
      
      /* Field with icon mobile */
      .field-with-icon {
        position: relative !important;
      }
      
      .field-icon {
        position: absolute !important;
        right: 1rem !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        color: #6c757d !important;
        font-size: 1.1rem !important;
        pointer-events: none !important;
      }
      
      /* Campo nome: REMOVER qualquer √≠cone gen√©rico - n√£o h√° mais √≠cone */
      #nome.field-with-icon .field-icon,
      .field-with-icon input#nome ~ .field-icon,
      .field-with-icon input#nome + .field-icon {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      
      .field-with-icon .form-control,
      .field-with-icon .form-select {
        padding-right: 3rem !important;
      }
      
      /* Campo nome: padding ajustado para √≠cone colado na extremidade */
      #nome.field-with-icon input,
      .field-with-icon input#nome {
        padding-right: 1.75rem !important;
      }
      
      /* CORRE√á√ÉO: Bot√£o discreto para digita√ß√£o manual no mobile */
      .btn-manual-nome {
        position: absolute !important;
        right: 3.5rem !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        background: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 6px !important;
        width: 32px !important;
        height: 32px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #6c757d !important;
        font-size: 0.9rem !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        z-index: 10 !important;
      }
      
      .btn-manual-nome:hover {
        background: #e9ecef !important;
        color: #495057 !important;
        border-color: #adb5bd !important;
      }
      
      .btn-manual-nome:active {
        background: #dee2e6 !important;
        transform: translateY(-50%) scale(0.95) !important;
      }
      
      /* Bot√£o Mobile */
      .btn-primary {
        width: 100% !important;
        padding: 1rem !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        border-radius: 12px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
        margin-top: 1rem !important;
      }
      
      .btn-primary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
      }
      
      /* Action Bar Mobile */
      .action-bar {
        padding: 1rem !important;
        background: #f8f9fa !important;
        border-radius: 0 0 15px 15px !important;
        border-top: 1px solid #e9ecef !important;
      }
      
      .queue-info {
        text-align: center !important;
        margin-top: 0.75rem !important;
      }
      
      .queue-status {
        font-size: 0.9rem !important;
        color: #6c757d !important;
      }
      
      .queue-badge {
        margin-left: 0.5rem !important;
        padding: 0.25rem 0.5rem !important;
        border-radius: 6px !important;
        font-size: 0.8rem !important;
        font-weight: 600 !important;
      }
      
      /* Header Mobile - Layout em Duas Linhas */
      .header {
        padding: 8px 0.75rem 1rem 0.75rem !important;
        border-radius: 0 !important;
      }
      
      .header-content {
        gap: 0.75rem !important;
      }
      
      /* Primeira Linha Mobile */
      .header-top {
        justify-content: center !important;
      }
      
      .header-brand {
        justify-content: center !important;
        text-align: center !important;
      }
      
      .brand-icon {
        width: 40px !important;
        height: 40px !important;
        margin: 0 auto 0.5rem auto !important;
      }
      
      .brand-text h1 {
        font-size: 1.2rem !important;
        margin: 0 !important;
      }
      
      .brand-subtitle {
        font-size: 0.75rem !important;
        margin-top: 2px !important;
      }
      
      /* Segunda Linha Mobile */
      .header-bottom {
        flex-direction: column !important;
        gap: 0.75rem !important;
        align-items: stretch !important;
      }
      
      .header-info {
        justify-content: space-between !important;
        gap: 0.5rem !important;
      }
      
      .info-item {
        flex: 1 !important;
        padding: 0.5rem 0.75rem !important;
        min-height: auto !important;
      }
      
      .info-icon {
        width: 28px !important;
        height: 28px !important;
        margin-right: 0.5rem !important;
      }
      
      .info-content {
        gap: 1px !important;
      }
      
      .info-label {
        font-size: 0.65rem !important;
      }
      
      .info-value {
        font-size: 0.8rem !important;
        line-height: 1.2 !important;
      }
      
      /* Actions Mobile - alinhados √† direita, na segunda linha */
      .header-actions {
        flex-direction: row !important;
        justify-content: flex-end !important;
        gap: 0.5rem !important;
        flex: 1 1 100% !important;
        order: 3 !important;
        margin-top: 4px !important;
      }
      
      .action-btn {
        width: 44px !important;
        height: 44px !important;
        border-radius: 10px !important;
      }
      
      /* Status indicator removido */
      
      /* Header Inspinia Mobile */
      .header-content {
        padding: 0 15px !important;
        height: auto !important;
        gap: 8px !important;
        row-gap: 6px !important;
        flex-wrap: wrap !important;
        align-items: center !important;
      }
      
      .header-left {
        flex: 1;
        min-width: 0;
      }
      
      .header-brand {
        gap: 8px !important;
      }
      
      .brand-text {
        gap: 1px !important;
      }
      
      .brand-text h1 {
        font-size: 14px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      .brand-logo {
        width: 28px !important;
        height: 28px !important;
        font-size: 14px !important;
      }
      
      .brand-text h1 {
        font-size: 16px !important;
      }
      
      .header-user-info {
        gap: 8px !important;
        flex-shrink: 0;
      }
      
      .user-location {
        font-size: 11px !important;
        gap: 4px !important;
      }
      
      .user-location i {
        font-size: 12px !important;
      }
      
      .user-profile {
        gap: 6px !important;
      }
      
      .user-avatar {
        width: 24px !important;
        height: 24px !important;
        font-size: 12px !important;
      }
      
      .user-name {
        font-size: 11px !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 80px;
      }
      
      .user-role {
        font-size: 9px !important;
      }
      
      .header-actions {
        gap: 6px !important;
        flex-shrink: 0;
      }
      
      .action-btn {
        width: 26px !important;
        height: 26px !important;
        font-size: 11px !important;
      }
      
      .action-btn i {
        font-size: 11px !important;
      }
    }
    
    /* üöÄ CORRE√á√ÉO ESPEC√çFICA PARA iOS MOBILE */
    @media (max-width: 480px) {
      .header {
        padding: 8px 0.5rem 0.75rem 0.5rem !important;
        background: linear-gradient(135deg, #2f4050 0%, #1a252f 100%) !important;
      }
      
      .brand-text h1 {
        font-size: 1.1rem !important;
      }
      
      /* üöÄ REDUZIR POLUI√á√ÉO VISUAL NO HEADER */
      .header-user-info {
        gap: 8px !important;
      }
      
      .header-user-info .user-location {
        font-size: 0.65rem !important;
        opacity: 0.8 !important;
      }
      
      .brand-text .user-location {
        font-size: 0.75rem !important;
        opacity: 0.8 !important;
      }
      
      .header-user-info .user-name {
        font-size: 0.75rem !important;
        font-weight: 500 !important;
      }
      
      .header-user-info .user-role {
        font-size: 0.65rem !important;
        opacity: 0.7 !important;
      }
      
      .header-actions {
        gap: 4px !important;
      }
      
      .header-actions .action-btn {
        width: 28px !important;
        height: 28px !important;
        font-size: 0.8rem !important;
      }
      
      /* üöÄ MELHORAR ESPA√áAMENTO DO T√çTULO E SUBT√çTULO */
      .card-title {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
        font-weight: 600 !important;
        line-height: 1.2 !important;
      }
      
      .card-subtitle {
        font-size: 0.75rem !important;
        margin-bottom: 1.25rem !important;
        line-height: 1.3 !important;
        color: #6b7280 !important;
        padding-top: 0.25rem !important;
      }
      
      .card-header {
        padding: 1rem 1rem 0.5rem 1rem !important;
      }
      
      /* üöÄ ESPEC√çFICO PARA iPHONE 8 E iOS */
      @supports (-webkit-touch-callout: none) {
        .header {
          padding: 8px 0.25rem 0.5rem 0.25rem !important;
          background: linear-gradient(135deg, #2f4050 0%, #1a252f 100%) !important;
        }
        
        .header-content {
          gap: 0.5rem !important;
        }
        
        .header-user-info {
          gap: 4px !important;
          flex-shrink: 0;
        }
        
        .header-user-info .user-location {
          font-size: 0.65rem !important;
          opacity: 0.7 !important;
        }
        
        .brand-text .user-location {
          font-size: 0.7rem !important;
          opacity: 0.7 !important;
        }
        
        .header-user-info .user-name {
          font-size: 0.65rem !important;
          font-weight: 400 !important;
          max-width: 60px !important;
        }
        
        .header-user-info .user-role {
          font-size: 0.6rem !important;
          opacity: 0.6 !important;
        }
        
        .header-actions {
          gap: 3px !important;
        }
        
        .header-actions .action-btn {
          width: 26px !important;
          height: 26px !important;
          font-size: 0.75rem !important;
        }
        
        .brand-text h1 {
          font-size: 1rem !important;
          font-weight: 600 !important;
        }
        
        /* üöÄ T√çTULO E SUBT√çTULO MAIS LIMPOS */
        .card-title {
          font-size: 0.95rem !important;
          margin-bottom: 0.75rem !important;
          font-weight: 600 !important;
          line-height: 1.3 !important;
          color: #1f2937 !important;
        }
        
        .card-subtitle {
          font-size: 0.7rem !important;
          margin-bottom: 1.5rem !important;
          line-height: 1.4 !important;
          color: #6b7280 !important;
          padding-top: 0.5rem !important;
          border-top: 1px solid #e5e7eb !important;
          padding-top: 0.5rem !important;
        }
        
        .card-header {
          padding: 1.25rem 1rem 0.75rem 1rem !important;
          background: #ffffff !important;
          border-bottom: 1px solid #f3f4f6 !important;
        }
      }
      
      .brand-subtitle {
        font-size: 0.7rem !important;
      }
      
      .info-item {
        padding: 0.4rem 0.5rem !important;
      }
      
      .info-value {
        font-size: 0.75rem !important;
      }
      
      .container {
        padding: 0.5rem !important;
      }
      
      .card-header {
        padding: 0.75rem !important;
      }
      
      .card-title {
        font-size: 1rem !important;
      }
      
      .form-control, .form-select {
        padding: 0.6rem 0.8rem !important;
        font-size: 16px !important;
      }
      
      .btn-primary {
        padding: 0.8rem !important;
        font-size: 1rem !important;
      }
      
      /* Header Inspinia Mobile Pequeno */
      .header-content {
        padding: 0 10px !important;
        height: 45px !important;
      }
      
      .header-brand {
        gap: 8px !important;
      }
      
      .brand-logo {
        width: 24px !important;
        height: 24px !important;
        font-size: 12px !important;
      }
      
      .brand-text h1 {
        font-size: 14px !important;
      }
      
      .header-user-info {
        gap: 10px !important;
      }
      
      .user-location {
        font-size: 11px !important;
        gap: 4px !important;
      }
      
      .user-location i {
        font-size: 11px !important;
      }
      
      .user-profile {
        gap: 6px !important;
      }
      
      .user-avatar {
        width: 22px !important;
        height: 22px !important;
        font-size: 12px !important;
      }
      
      .user-name {
        font-size: 11px !important;
      }
      
      .user-role {
        font-size: 9px !important;
      }
      
      .header-actions {
        gap: 6px !important;
        padding-right: 8px !important;
      }
      
      .action-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 11px !important;
      }
      
      .action-btn i {
        font-size: 11px !important;
      }
    }
    
    /* Keyboard open state */
    .keyboard-open .container {
      padding-bottom: 100px;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Anima√ß√µes suaves */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* CSS para Modo Dark - Suave e Organizado */
    [data-theme="dark"] {
      --bg-primary: #1e1e1e;
      --bg-secondary: #2d2d2d;
      --bg-card: #2d2d2d;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --border-color: #404040;
    }
    
    [data-theme="dark"] body {
      background-color: #1e1e1e !important;
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .container {
      background-color: #1e1e1e !important;
    }
    
    [data-theme="dark"] .card {
      background-color: #2d2d2d !important;
      border-color: #404040 !important;
      color: #e0e0e0 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .card-header {
      background-color: #3a3a3a !important;
      border-color: #404040 !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
      background-color: #3a3a3a !important;
      border-color: #555555 !important;
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .form-label {
      color: #e0e0e0 !important;
    }
    
    /* For√ßar tema dark suave */
    body.dark-theme {
      background-color: #1e1e1e !important;
      color: #e0e0e0 !important;
    }
    
    body.dark-theme .card {
      background-color: #2d2d2d !important;
      color: #e0e0e0 !important;
      border-color: #404040 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    }
    
    body.dark-theme .form-control,
    body.dark-theme .form-select {
      background-color: #3a3a3a !important;
      color: #e0e0e0 !important;
      border-color: #555555 !important;
    }
    
    /* Formul√°rios */
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
    /* Bot√µes */
    [data-theme="dark"] .btn-default,
    [data-theme="dark"] .btn-secondary {
      background-color: var(--bg-secondary) !important;
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
    /* Eliminar faixas e garantir fundo uniforme */
    [data-theme="dark"] .wrapper,
    [data-theme="dark"] .page-wrapper,
    [data-theme="dark"] .content-wrapper,
    [data-theme="dark"] .main-content,
    [data-theme="dark"] .container-fluid,
    [data-theme="dark"] .container {
      background-color: var(--bg-primary) !important;
      background: var(--bg-primary) !important;
      background-image: none !important;
    }
    
    /* Corrigir poss√≠veis gradientes ou imagens de fundo */
    [data-theme="dark"] body,
    [data-theme="dark"] html,
    [data-theme="dark"] .page-wrapper {
      background: var(--bg-primary) !important;
      background-color: var(--bg-primary) !important;
      background-image: none !important;
      background-attachment: fixed !important;
    }
    
    /* Garantir que n√£o h√° elementos com fundo branco */
    [data-theme="dark"] *:not(.card):not(.panel):not(.ibox):not(.well):not(.jumbotron):not(input):not(select):not(textarea):not(.form-control):not(.form-select) {
      background-color: var(--bg-primary) !important;
    }

  </style>
  
  
  <!-- Fonts Profissionais -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- üö® CORRE√á√ÉO: URL corrigida - usar ponto e v√≠rgula para separar pesos, n√£o v√≠rgula -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- CORRE√á√ÉO DE EMERG√äNCIA - DESABILITAR PACE.JS E OTIMIZAR PERFORMANCE -->
  <style>
    /* CORRE√á√ÉO IMEDIATA - REMOVER BARRA VERMELHA */
    .pace,
    .pace-progress,
    .pace-activity,
    .pace-inactive,
    [class*="pace"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      height: 0 !important;
      width: 0 !important;
    }
    
    /* Remover qualquer barra de progresso no topo */
    .pace .pace-progress {
      display: none !important;
      background: transparent !important;
      height: 0 !important;
      width: 0 !important;
    }
    
    /* Garantir que n√£o h√° elementos Pace vis√≠veis */
    body > .pace {
      display: none !important;
    }
    
    /* Estilo para indicar foco autom√°tico no campo COMUM CONGREGA√á√ÉO */
    #comumInput.auto-focused {
      border-color: #007bff !important;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
      animation: focusPulse 2s ease-in-out;
    }
    
    @keyframes focusPulse {
      0% { box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5); }
      50% { box-shadow: 0 0 0 0.4rem rgba(0, 123, 255, 0.3); }
      100% { box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
    }
  </style>
  <script>
    // CORRE√á√ÉO IMEDIATA - DESABILITAR PACE.JS
    console.log('üöÄ CORRE√á√ÉO DE EMERG√äNCIA - Desabilitando Pace.js...');
    
    // Desabilitar Pace.js imediatamente
    if (typeof Pace !== 'undefined') {
      Pace.stop();
      Pace.restart = function() {};
      Pace.go = function() {};
      console.log('‚úÖ Pace.js desabilitado');
    }
    
    // Remover elementos Pace do DOM
    function removePaceElements() {
      const selectors = [
        '.pace', '.pace-progress', '.pace-activity', '.pace-inactive',
        '[class*="pace"]', '[id*="pace"]',
        'div[style*="position: fixed"][style*="top: 0"]',
        'div[style*="z-index: 2040"]', 'div[style*="height: 2px"]'
      ];
      
      selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
          if (element && element.parentNode) {
            element.parentNode.removeChild(element);
            console.log('üóëÔ∏è Elemento removido:', selector);
          }
        });
      });
    }
    
    // Executar imediatamente
    removePaceElements();
    
    // Executar periodicamente
    setInterval(removePaceElements, 250);
    
    // Executar quando a p√°gina carregar
    window.addEventListener('load', removePaceElements);
    
    console.log('‚úÖ Corre√ß√£o de emerg√™ncia aplicada!');
  </script>
  
  <!-- Scripts Necess√°rios - CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <!-- üöÄ OTIMIZA√á√ÉO: SweetAlert2 vers√£o mais recente (√∫nica inst√¢ncia) -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Corre√ß√£o de emerg√™ncia - REMOVIDO PARA EVITAR LOOP INFINITO -->
  <!-- <script src="emergency-fix.js"></script> -->
  <!-- <script src="clear-cache-emergency.js"></script> -->
  <!-- Script do Supabase movido para baixo -->
  
  <!-- Sistema Original com Supabase -->
  <script src="app.js"></script>
  
  <!-- Parar loop infinito -->
  <script src="stop-loop.js"></script>
  
  <!-- Melhorias para Mobile -->
  <script>
    // üöÄ DETEC√á√ÉO E OTIMIZA√á√ÉO PARA iOS
    function detectAndOptimizeForIOS() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isIPhone8 = /iPhone/.test(navigator.userAgent) && window.screen.width === 375 && window.screen.height === 667;
      
      if (isIOS) {
        console.log('üçé iOS detectado - aplicando otimiza√ß√µes espec√≠ficas');
        document.body.classList.add('ios-device');
        
        if (isIPhone8) {
          console.log('üì± iPhone 8 detectado - aplicando otimiza√ß√µes espec√≠ficas');
          document.body.classList.add('iphone-8');
        }
        
        // Aplicar estilos espec√≠ficos para iOS
        const style = document.createElement('style');
        style.textContent = `
          .ios-device .header {
            padding: 0.5rem 0.25rem !important;
            background: linear-gradient(135deg, #2f4050 0%, #1a252f 100%) !important;
          }
          
          .ios-device .header-user-info {
            gap: 6px !important;
            flex-wrap: wrap !important;
          }
          
          .ios-device .header-user-info .user-location {
            font-size: 0.65rem !important;
            opacity: 0.7 !important;
          }
          
          .ios-device .brand-text .user-location {
            font-size: 0.7rem !important;
            opacity: 0.7 !important;
          }
          
          .ios-device .header-user-info .user-name {
            font-size: 0.7rem !important;
            font-weight: 400 !important;
          }
          
          .ios-device .header-user-info .user-role {
            font-size: 0.6rem !important;
            opacity: 0.6 !important;
          }
          
          .ios-device .header-actions {
            gap: 3px !important;
          }
          
          .ios-device .header-actions .action-btn {
            width: 26px !important;
            height: 26px !important;
            font-size: 0.75rem !important;
          }
          
          .ios-device .card-title {
            font-size: 0.95rem !important;
            margin-bottom: 0.75rem !important;
            font-weight: 600 !important;
            line-height: 1.3 !important;
            color: #1f2937 !important;
          }
          
          .ios-device .card-subtitle {
            font-size: 0.7rem !important;
            margin-bottom: 1.5rem !important;
            line-height: 1.4 !important;
            color: #6b7280 !important;
            padding-top: 0.5rem !important;
            border-top: 1px solid #e5e7eb !important;
          }
          
          .ios-device .card-header {
            padding: 1.25rem 1rem 0.75rem 1rem !important;
            background: #ffffff !important;
            border-bottom: 1px solid #f3f4f6 !important;
          }
          
          .iphone-8 .header {
            padding: 0.4rem 0.2rem !important;
          }
          
          .iphone-8 .header-user-info {
            gap: 4px !important;
          }
          
          .iphone-8 .header-actions {
            gap: 2px !important;
          }
          
          .iphone-8 .header-actions .action-btn {
            width: 24px !important;
            height: 24px !important;
            font-size: 0.7rem !important;
          }
        `;
        document.head.appendChild(style);
      }
    }
    
    // Executar detec√ß√£o quando a p√°gina carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', detectAndOptimizeForIOS);
    } else {
      detectAndOptimizeForIOS();
    }

    // Fun√ß√£o para carregar informa√ß√µes do usu√°rio e local - Din√¢mica
    async function loadUserInfo() {
      try {
        // Tentar obter dados reais do localStorage ou sessionStorage
        let userInfo = {
          name: 'Ricardo Grangeiro',
          location: 'Ensaio Regional Itapevi'
        };
        
        // Verificar se h√° dados salvos da sess√£o
        const savedUser = localStorage.getItem('session_user');
        const savedLocation = localStorage.getItem('session_local');
        const savedName = localStorage.getItem('session_name');
        const savedRole = localStorage.getItem('session_role');
        
        if (savedName) {
          // Usar nome completo do perfil e extrair primeiro e √∫ltimo nome
          const nomeCompleto = savedName.trim();
          const partesNome = nomeCompleto.split(' ');
          
          if (partesNome.length >= 2) {
            // Pegar primeiro e √∫ltimo nome
            const primeiroNome = partesNome[0];
            const ultimoNome = partesNome[partesNome.length - 1];
            userInfo.name = `${primeiroNome} ${ultimoNome}`;
          } else {
            // Se s√≥ tem um nome, usar ele mesmo
            userInfo.name = nomeCompleto;
          }
          
          console.log('‚úÖ Nome do perfil carregado:', userInfo.name);
        } else if (savedUser) {
          // Fallback: Formatar nome do usu√°rio a partir do email
          const nomeUsuario = savedUser.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          userInfo.name = nomeUsuario;
          console.log('‚ö†Ô∏è Usando nome formatado do email:', userInfo.name);
        }
        
        if (savedLocation) {
          userInfo.location = savedLocation;
        }
        
        // Definir role baseado no session_role
        let userRole = 'Usu√°rio'; // Padr√£o
        if (savedRole === 'master') {
          userRole = 'Administrador';
        } else if (savedRole === 'user') {
          userRole = 'Usu√°rio';
        }
        
        // Atualizar elementos do header
        const userElement = document.getElementById('currentUser');
        const locationElement = document.getElementById('currentLocation');
        const roleElement = document.getElementById('currentUserRole');
        
        if (userElement) {
          userElement.textContent = userInfo.name;
        }
        
        if (locationElement) {
          locationElement.textContent = userInfo.location;
        }
        
        if (roleElement) {
          roleElement.textContent = userRole;
        }
        
        console.log('‚úÖ Informa√ß√µes do usu√°rio carregadas:', { ...userInfo, role: userRole });
        console.log('üîç Role detectado:', savedRole, '‚Üí Exibido como:', userRole);
        
        // Aguardar um pouco para garantir que o app.js carregou
        setTimeout(() => {
          // Tentar carregar dados reais se dispon√≠vel
          if (typeof loadComunsFromCatalog === 'function') {
            loadComunsFromCatalog();
          }
          if (typeof loadNomes === 'function') {
            loadNomes();
          }
          if (typeof toggleInstrumentFieldVisibility === 'function') {
            toggleInstrumentFieldVisibility();
          }
          
          // Tentar obter localiza√ß√£o real se dispon√≠vel
          if (typeof getCurrentLocation === 'function') {
            getCurrentLocation();
          }
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar informa√ß√µes do usu√°rio:', error);
        
        // Fallback para valores padr√£o
        const userElement = document.getElementById('currentUser');
        const locationElement = document.getElementById('currentLocation');
        
        if (userElement) {
          userElement.textContent = 'Usu√°rio';
        }
        
        if (locationElement) {
          locationElement.textContent = 'Local n√£o definido';
        }
      }
    }
    
    // Fun√ß√£o para atualizar localiza√ß√£o dinamicamente
    function updateLocation(newLocation) {
      const locationElement = document.getElementById('currentLocation');
      if (locationElement) {
        locationElement.textContent = newLocation;
        localStorage.setItem('currentLocation', newLocation);
        console.log('üìç Localiza√ß√£o atualizada:', newLocation);
      }
    }
    
    
    
    // Previne zoom no iOS quando foca em inputs
    document.addEventListener('DOMContentLoaded', function() {
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.type !== 'range' && input.type !== 'checkbox' && input.type !== 'radio') {
          input.style.fontSize = '16px';
        }
      });
      
      // Aplicar tema light por padr√£o
      document.documentElement.setAttribute('data-theme', 'light');
      
      // Carregar informa√ß√µes do usu√°rio
      loadUserInfo();
    });
    
    // Melhora o comportamento do teclado virtual
    let initialViewportHeight = window.innerHeight;
    
    window.addEventListener('resize', function() {
      const currentHeight = window.innerHeight;
      const heightDifference = initialViewportHeight - currentHeight;
      
      // Se a diferen√ßa for significativa, o teclado est√° aberto
      if (heightDifference > 150) {
        document.body.classList.add('keyboard-open');
        // Ajusta o dropdown para ficar acima do teclado
        const dropdown = document.getElementById('comumResults');
        if (dropdown && dropdown.style.display !== 'none') {
          dropdown.style.bottom = (heightDifference + 20) + 'px';
        }
      } else {
        document.body.classList.remove('keyboard-open');
        const dropdown = document.getElementById('comumResults');
        if (dropdown) {
          dropdown.style.bottom = '20px';
        }
      }
    });
    
    // Melhora o scroll no dropdown
    document.addEventListener('touchstart', function(e) {
      if (e.target.closest('.suggestions-dropdown')) {
        e.target.closest('.suggestions-dropdown').style.overscrollBehavior = 'contain';
      }
    }, { passive: true });
    
    // üöÄ CORRE√á√ÉO MOBILE: Detectar teclado aberto e ajustar dropdown
    let isKeyboardOpen = false;
    
    function handleViewportChange() {
      const currentHeight = window.innerHeight;
      const heightDifference = initialViewportHeight - currentHeight;
      
      // Se a altura diminuiu significativamente, o teclado est√° aberto
      if (heightDifference > 150) {
        isKeyboardOpen = true;
        document.body.classList.add('keyboard-open');
        
        // Ajusta dropdowns para aparecer acima do teclado
        const dropdowns = document.querySelectorAll('.suggestions-dropdown');
        dropdowns.forEach(dropdown => {
          if (dropdown.classList.contains('show')) {
            // No mobile, usar posi√ß√£o fixa na parte inferior
            dropdown.style.position = 'fixed';
            dropdown.style.bottom = '0px';
            dropdown.style.left = '0px';
            dropdown.style.right = '0px';
            dropdown.style.top = 'auto';
            dropdown.style.maxHeight = '60vh';
            dropdown.style.zIndex = '9999';
          }
        });
      } else {
        isKeyboardOpen = false;
        document.body.classList.remove('keyboard-open');
        
        // Restaura posi√ß√£o normal dos dropdowns
        const dropdowns = document.querySelectorAll('.suggestions-dropdown');
        dropdowns.forEach(dropdown => {
          dropdown.style.position = '';
          dropdown.style.bottom = '';
          dropdown.style.left = '';
          dropdown.style.right = '';
          dropdown.style.top = '';
          dropdown.style.maxHeight = '';
          dropdown.style.zIndex = '';
        });
      }
    }
    
    // Detectar mudan√ßas na viewport (teclado abrindo/fechando)
    window.addEventListener('resize', handleViewportChange);
    window.addEventListener('orientationchange', () => {
      setTimeout(handleViewportChange, 100);
    });
  </script>
  <style>
    :root{ 
      /* Cores Profissionais */
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --secondary: #64748b;
      --success: #059669;
      --warning: #d97706;
      --error: #dc2626;
      --info: #0891b2;
      
      /* Backgrounds */
      --background: #f8fafc;
      --surface: #ffffff;
      --surface-elevated: #ffffff;
      --surface-hover: #f1f5f9;
      
      /* Textos */
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --text-white: #ffffff;
      
      /* Bordas */
      --border: #e2e8f0; 
      --border-light: #f1f5f9;
      --border-dark: #cbd5e1;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      
      /* Bordas */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-full: 9999px;
      
      /* Transi√ß√µes */
      --transition: all 0.2s ease-in-out;
    }
    
    /* Modo Escuro */
    [data-theme="dark"] {
      --background: #0f172a;
      --surface: #1e293b;
      --surface-elevated: #334155;
      --surface-hover: #475569;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #334155;
      --border-light: #475569;
      --border-dark: #64748b;
    }
    
    /* Estilos para modo escuro */
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: var(--surface);
      color: var(--text-primary);
      border-color: var(--border);
    }

    [data-theme="dark"] .btn-icon {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    [data-theme="dark"] .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Garantir alta legibilidade no modo escuro */
    [data-theme="dark"] input[type="text"], 
    [data-theme="dark"] input[type="email"], 
    [data-theme="dark"] input[type="search"],
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .search-input {
      color: #f1f5f9 !important;
      background: #1e293b !important;
      border-color: #334155 !important;
    }
    
    [data-theme="dark"] input[type="text"]::placeholder, 
    [data-theme="dark"] input[type="email"]::placeholder, 
    [data-theme="dark"] input[type="search"]::placeholder,
    [data-theme="dark"] .form-control::placeholder,
    [data-theme="dark"] .search-input::placeholder {
      color: #94a3b8 !important;
      opacity: 0.8 !important;
    }
    
    * { box-sizing: border-box; }
    
    html, body { 
      margin: 0; 
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Anima√ß√µes Simples */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Anima√ß√µes Elegantes para Modal de Sucesso */
    @keyframes modalSlideIn {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8) translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) translateY(0);
      }
    }

    @keyframes backdropFadeIn {
      0% {
        opacity: 0;
        backdrop-filter: blur(0px);
      }
      100% {
        opacity: 0.6;
        backdrop-filter: blur(8px);
      }
    }

    @keyframes progressGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
      }
      50% {
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
      }
    }
    
    /* Header Funcional */
    .header {
      background: var(--primary);
      color: var(--text-white);
      padding: 8px 0 1rem 0;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 100%;
      margin: 0;
      padding: 0 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .header-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .header-info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .location-info, .user-info {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      opacity: 0.9;
    }

    .location-icon, .user-icon {
      font-size: 0.6rem;
    }

    .location-text, .user-text {
      font-weight: 500;
      color: var(--text-white);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.125rem;
      position: relative;
    }
    
    .header-actions {
      position: static; /* evita sobreposi√ß√£o no header */
      top: auto;
      right: auto;
      display: flex;
      gap: 0.25rem;
      flex: 1 1 100%;
      order: 3; /* envia para a segunda linha quando houver wrap */
      justify-content: flex-end;
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .btn-icon:active {
      transform: translateY(0);
    }

    .btn-icon.hidden {
      display: none;
    }

    .status-online {
      background: rgba(5, 150, 105, 0.2);
      border-color: rgba(5, 150, 105, 0.3);
    }

    .status-offline {
      background: rgba(220, 38, 38, 0.2);
      border-color: rgba(220, 38, 38, 0.3);
    }

    .header-location {
      font-size: 0.75rem;
      font-weight: 500;
      opacity: 0.9;
    }

    .header-user {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    /* Status indicator removido */
    
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--error);
      transition: all 0.3s ease;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
    }

    .status-dot.online {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    /* Main Content - Mobile First */
    .container {
      max-width: 100%;
      margin: 0;
      padding: 0.75rem;
      padding-bottom: 1.5rem;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      overflow: hidden;
      animation: slideIn 0.3s ease-out;
    }

    .card-header {
      padding: 1rem 1rem 0;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .card-body {
      padding: 0 1rem 1rem;
    }

    /* Form Elements - Mobile Optimized */
    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .form-label.required::after {
      content: " *";
      color: var(--error);
    }

    .field-container {
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .field-container.hidden {
        opacity: 0;
      max-height: 0;
      margin: 0;
      padding: 0;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--surface);
      color: var(--text-primary);
      transition: var(--transition);
      min-height: 48px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    input:hover, select:hover, textarea:hover {
      border-color: var(--border-dark);
    }

    /* Touch targets optimization */
    .btn-icon, .btn-primary, input, select, textarea {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    textarea {
      resize: none;
      height: 100px;
      font-family: inherit;
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      background: var(--background);
      border-top: 1px solid var(--border-light);
      margin: 1rem -1rem -1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      min-height: 44px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--text-white);
      border: none;
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      width: 100%;
      min-height: 52px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    /* Queue Status */
    .queue-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-align: center;
    }
      
    .queue-badge {
      display: inline-flex;
        align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .queue-badge.empty {
      background: #dcfce7;
      color: #166534;
    }

    .queue-badge.pending {
      background: #f0ad4e;
      color: white;
    }

    .queue-badge.syncing {
      background: #dbeafe;
      color: #1e40af;
    }

    .offline-info {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(217, 119, 6, 0.1);
      border-radius: var(--radius-md);
      color: var(--warning);
      font-size: 0.75rem;
      text-align: center;
    }
    
    /* Mobile Touch Optimizations - Fluido e Elegante */
    @media (max-width: 640px) {
      .container {
        padding: 0.25rem;
        padding-bottom: 0.5rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      
      .header {
        padding: 8px 0 0.5rem 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .header-content {
        padding: 0 0.25rem;
      }
      
      .header h1 {
        font-size: 1rem;
        font-weight: 700;
        margin: 0;
      }
      
      .header-actions {
        gap: 0.25rem;
      }
      
      .btn-icon {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      
      .btn-icon:active {
        transform: scale(0.95);
      }
      
      .card {
        margin: 0.25rem;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid var(--border-light);
        overflow: hidden;
      }
      
      .card-header {
        padding: 0.5rem 0.5rem 0;
        background: var(--surface);
      }
      
      .card-title {
        font-size: 0.9rem;
        margin-bottom: 0.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .card-subtitle {
        font-size: 0.7rem;
        margin-bottom: 0.5rem;
        opacity: 0.8;
        color: var(--text-secondary);
      }
      
      .card-body {
        padding: 0 0.5rem 0.5rem;
        background: var(--surface);
      }
      
      .form-group {
        margin-bottom: 0.5rem;
      }
      
      .form-label {
        font-size: 0.7rem;
        margin-bottom: 0.2rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-primary);
      }
      
      input, select, textarea {
        padding: 0.6rem 0.75rem;
        font-size: 0.85rem;
        min-height: 42px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-primary);
        transition: all 0.2s ease;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      
      input:focus, select:focus, textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
        transform: translateY(-1px);
      }
      
      .btn-primary {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        min-height: 44px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        transition: all 0.2s ease;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      }
      
      .btn-primary:active {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 1px 4px rgba(59, 130, 246, 0.3);
      }
      
      .action-bar {
        padding: 0.5rem;
        margin: 0.5rem -0.5rem -0.5rem;
        background: var(--surface);
        border-top: 1px solid var(--border-light);
        border-radius: 0 0 12px 12px;
      }
      
      .queue-info {
        font-size: 0.7rem;
        text-align: center;
        padding: 0.25rem;
      }
      
      .form-text {
        font-size: 0.65rem;
        margin-top: 0.2rem;
        opacity: 0.7;
        color: var(--text-muted);
      }
      
      .link-mini {
        font-size: 0.65rem;
        margin-top: 0.2rem;
        color: var(--primary);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      
      .link-mini:hover {
        color: var(--primary-dark);
      }
    }
    
    /* Extra Small Mobile - Ultra Compacto */
    @media (max-width: 375px) {
      .container {
        padding: 0.125rem;
        padding-bottom: 0.25rem;
      }
      
      .header {
        padding: 8px 0 0.375rem 0;
      }
      
      .header-content {
        padding: 0 0.125rem;
      }
      
      .header h1 {
        font-size: 0.9rem;
        font-weight: 700;
      }
      
      .header-actions {
        gap: 0.125rem;
      }
      
      .btn-icon {
        width: 24px;
        height: 24px;
        font-size: 0.6rem;
      }
      
      .card {
        margin: 0.125rem;
        border-radius: 10px;
      }
      
      .card-header {
        padding: 0.375rem 0.375rem 0;
      }
      
      .card-title {
        font-size: 0.8rem;
        margin-bottom: 0.1rem;
      }
      
      .card-subtitle {
        font-size: 0.65rem;
        margin-bottom: 0.375rem;
      }
      
      .card-body {
        padding: 0 0.375rem 0.375rem;
      }
      
      .form-group {
        margin-bottom: 0.375rem;
      }
      
      .form-label {
        font-size: 0.65rem;
        margin-bottom: 0.15rem;
      }
      
      input, select, textarea {
        padding: 0.5rem 0.6rem;
        font-size: 0.8rem;
        min-height: 38px;
        border-radius: 6px;
      }
      
      .btn-primary {
        padding: 0.6rem 0.8rem;
        font-size: 0.8rem;
        min-height: 40px;
        border-radius: 8px;
      }
      
      .action-bar {
        padding: 0.375rem;
        margin: 0.375rem -0.375rem -0.375rem;
      }
      
      .queue-info {
        font-size: 0.65rem;
        padding: 0.2rem;
      }
      
      .form-text {
        font-size: 0.6rem;
        margin-top: 0.15rem;
      }
      
      .link-mini {
        font-size: 0.6rem;
        margin-top: 0.15rem;
      }
    }
    /* Tablet Optimizations */
    @media (min-width: 641px) and (max-width: 1024px) {
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 1rem;
      }
      
      .header-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      
      .card {
        margin: 0.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      input, select, textarea {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        min-height: 48px;
        border-radius: 10px;
      }
      
      .btn-primary {
        padding: 1rem 1.5rem;
        font-size: 1rem;
        min-height: 52px;
        border-radius: 12px;
      }
      
      .action-bar {
        padding: 1rem;
        margin: 1rem -1rem -1rem;
        border-radius: 0 0 16px 16px;
      }
    }
    
    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(1rem);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeInUp 0.5s ease;
    }

    /* Form text and links */
    .form-text {
      font-size: 0.8em;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .link-mini {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.8em;
      font-weight: 500;
    }
    
    .link-mini:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* Alert styles */
    .alert {
      border-radius: var(--radius-md);
      border: none;
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .alert-danger {
      background: #fef2f2;
      color: var(--error);
      border-left: 4px solid var(--error);
    }

    /* Search container */
    .search-container {
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding-right: 50px;
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      max-height: 500px; /* üöÄ Aumentado para mostrar mais comuns */
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow-lg);
      margin-top: -2px;
    }
    
    .suggestions-dropdown.show {
      display: block;
      animation: fadeInUp 0.3s ease;
    }
    
    .suggestion-item {
      padding: 16px 20px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.3s ease;
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }
    
    .suggestion-item:hover,
    .suggestion-item.highlighted {
      background: var(--primary);
      color: white;
      transform: translateX(5px);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
      font-size: 18px;
      transition: all 0.3s ease;
    }
    
    .search-input:focus + .search-icon {
      color: var(--primary);
      transform: translateY(-50%) rotate(180deg);
    }
    
    /* Estilos para entrada manual */
    .suggestion-item.manual-entry {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      border-left: 3px solid #f59e0b;
      font-weight: 600;
      padding: 0.75rem 1rem;
    }

    .suggestion-item.manual-entry:hover {
      background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
      color: #78350f;
      transform: translateX(3px);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .suggestion-item.manual-entry span {
      margin-right: 0.5rem;
      color: #f59e0b;
      }
      
      .suggestion-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--border-light);
    }

    .suggestion-item:hover {
      background: var(--surface-hover);
      transform: translateX(2px);
      }
      
      .suggestion-item:last-child {
      border-bottom: none;
    }

    /* √çcones nos campos de entrada */
    .search-container {
      position: relative;
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1rem;
      pointer-events: none;
      z-index: 1;
    }

        .search-input {
      padding-right: 40px !important;
    }

    .field-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1rem;
      pointer-events: none;
      z-index: 1;
    }
    
    /* REMOVER √≠cones gen√©ricos do campo nome - n√£o h√° mais √≠cone */
    #nome.field-with-icon .field-icon,
    .field-with-icon input#nome ~ .field-icon,
    .field-with-icon input#nome + .field-icon {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* REMOVIDO: CSS do √≠cone de seta - √≠cone foi removido */
    /* O campo nome agora funciona apenas com busca autom√°tica ap√≥s 3 caracteres */
    
    /* ESCONDER qualquer √≠cone gen√©rico no campo nome */
    #nome.field-with-icon .field-icon {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .field-with-icon {
      position: relative;
    }

    /* Ajustar padding do input para acomodar √≠cone - PADR√ÉO PARA TODOS OS CAMPOS */
    .field-with-icon input,
    .field-with-icon select {
      padding-right: 3rem !important; /* Mesmo padding para todos os campos */
    }
    
    /* Padding espec√≠fico para o campo nome - SEM √çCONE */
    #nome.field-with-icon input,
    .field-with-icon input#nome {
      padding-right: 1rem !important; /* Padding normal sem √≠cone */
    }
    
    /* GARANTIR QUE N√ÉO H√Å SUGEST√ïES ACIMA DO TECLADO */
    #nome {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
    }

    /* Dropdown de sugest√µes */
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      max-height: 500px; /* üöÄ Aumentado para mostrar mais comuns */
      overflow-y: auto;
      display: none;
      margin-top: 4px;
    }
    
      /* üöÄ CORRE√á√ÉO MULTIPLATAFORMA: Dropdown funcionando igual em todas as plataformas (iOS, Android, Desktop) */
    @media (max-width: 768px) {
      /* ‚úÖ CORRE√á√ÉO CR√çTICA: Todas as listas de sugest√µes funcionam como dropdown normal (n√£o bottom-sheet) */
      .suggestions-dropdown {
        position: absolute !important;
        top: calc(100% + 4px) !important;
        bottom: auto !important;
        left: 0 !important;
        right: 0 !important;
        max-height: 50vh !important;
        border-radius: var(--radius-md) !important;
        margin-top: 0 !important;
        z-index: 1000 !important;
        transform: none !important;
        transition: none !important;
        box-shadow: var(--shadow-lg) !important;
        background: var(--surface) !important;
        border: 1px solid var(--border) !important;
      }
      
      .suggestions-dropdown.show {
        transform: none !important;
        display: block !important;
      }

      /* ‚úÖ CORRE√á√ÉO: COMUNS tamb√©m como dropdown normal */
      #comumResults {
        position: absolute !important;
        top: calc(100% + 4px) !important;
        bottom: auto !important;
        left: 0 !important;
        right: 0 !important;
        max-height: 45vh !important;
        border-radius: var(--radius-md) !important;
        box-shadow: var(--shadow-lg) !important;
        border: 1px solid var(--border) !important;
        transform: none !important;
        transition: none !important;
      }
      
      /* ‚úÖ CORRE√á√ÉO CR√çTICA: NOMES tamb√©m como dropdown normal (padronizado para TODAS as plataformas) */
      /* üö® CORRE√á√ÉO XIAOMI/REDMI: Garantir que sempre use position: absolute, nunca fixed */
      #nomeResults {
        position: absolute !important;
        top: calc(100% + 4px) !important;
        bottom: auto !important;
        left: 0 !important;
        right: 0 !important;
        max-height: 50vh !important;
        z-index: 1000 !important;
        border-radius: var(--radius-md) !important;
        box-shadow: var(--shadow-lg) !important;
        background: var(--surface) !important;
        border: 1px solid var(--border) !important;
        transform: none !important;
        transition: none !important;
      }
      
      /* üö® CORRE√á√ÉO XIAOMI/REDMI: Garantir que nunca use position: fixed */
      #nomeResults[style*="position: fixed"],
      #nomeResults[style*="position:fixed"] {
        position: absolute !important;
        bottom: auto !important;
        top: calc(100% + 4px) !important;
      }
      
      /* üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: For√ßar posicionamento correto sempre */
      /* Garantir que a lista apare√ßa abaixo do campo, n√£o como sugest√µes do teclado */
      #nomeResults.show {
        position: absolute !important;
        top: calc(100% + 4px) !important;
        bottom: auto !important;
        transform: none !important;
        display: block !important;
      }
      
      /* Melhorar visual dos itens no mobile */
      .suggestion-item {
        padding: 16px 20px !important;
        font-size: 16px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        min-height: 56px !important;
        display: flex !important;
        align-items: center !important;
      }
      
      .suggestion-item:last-child {
        border-bottom: none !important;
        border-radius: 0 0 var(--radius-md) var(--radius-md) !important;
      }
      
      .suggestion-item:hover,
      .suggestion-item:active {
        background: #f8fafc !important;
        color: #1e40af !important;
        transform: none !important;
      }
      
      /* Estilo especial para entrada manual no mobile */
      .suggestion-item.manual-entry {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
        color: #92400e !important;
        border-left: 4px solid #f59e0b !important;
        font-weight: 600 !important;
      }
      
      .suggestion-item.manual-entry:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%) !important;
        color: #78350f !important;
      }
    }

    .suggestions-dropdown.show {
      display: block;
      animation: slideDown 0.2s ease-out;
    }

    /* REMOVIDO: Bot√£o toggle da seta - n√£o √© mais necess√°rio */

    /* Ocultar completamente o bot√£o antigo no mobile */
    .btn-manual-nome {
      display: none !important;
      position: absolute !important;
      right: 0 !important;
      top: 50% !important;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      border: 0 !important;
      opacity: 0 !important;
      pointer-events: none !important;
      background: transparent !important;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .suggestion-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--border-light);
      font-size: 0.875rem;
    }

    .suggestion-item:hover {
      background: var(--surface-hover);
      transform: translateX(2px);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item.manual-entry {
      background: var(--surface-elevated);
      color: var(--text-primary);
      border-left: 3px solid var(--primary);
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .suggestion-item.manual-entry:hover {
      background: var(--surface-hover);
      color: var(--primary);
      transform: translateX(3px);
      box-shadow: var(--shadow-md);
    }

    /* Estilos para badges da fila */
    .queue-badge {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .queue-badge.empty {
      background: var(--success);
      color: white;
    }

    .queue-badge.pending {
      background: #f0ad4e;
      color: white;
    }

    .queue-badge.error {
      background: var(--error);
      color: white;
    }

    /* üö® CORRE√á√ÉO: Remover estilos CSS personalizados que quebram a renderiza√ß√£o do SweetAlert2 */
    /* O SweetAlert2 tem seus pr√≥prios estilos padr√£o que funcionam corretamente */

    /* üö® CORRE√á√ÉO: Remover todos os estilos CSS personalizados do SweetAlert2 */
    /* O SweetAlert2 tem seus pr√≥prios estilos padr√£o que funcionam corretamente */
    /* Estilos personalizados com !important estavam quebrando a renderiza√ß√£o */

    /* üö® CORRE√á√ÉO: Remover estilos CSS personalizados que quebram a renderiza√ß√£o do SweetAlert2 */
    /* O SweetAlert2 tem seus pr√≥prios estilos padr√£o que funcionam corretamente */
    /* Apenas garantir que estilos globais n√£o interfiram nos √≠cones */
    .swal2-icon * {
      box-sizing: border-box;
    }
    
    /* Garantir que estilos globais n√£o interfiram no SweetAlert2 */
    /* Removido: regra CSS vazia - usar padr√£o do SweetAlert2 */

    /* Modal Inspinia - Estilo Original */
    .modal.inmodal {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 1050 !important;
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
      outline: 0 !important;
    }
    
    .modal.inmodal .modal-dialog {
      position: relative !important;
      width: auto !important;
      margin: 0.5rem !important;
      pointer-events: auto !important; /* CORRE√á√ÉO: Permitir intera√ß√£o */
      max-width: 500px !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }
    
    .modal.inmodal.show .modal-dialog {
      transform: none !important;
    }
    
    .modal.inmodal .modal-content {
      position: relative !important;
      display: flex !important;
      flex-direction: column !important;
      width: 100% !important;
      pointer-events: auto !important;
      background-color: #ffffff !important;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
      outline: 0 !important;
    }

    .modal.inmodal .modal-header {
      background-color: #ffffff !important;
      border-bottom: 1px solid #e5e5e5;
      border-radius: 6px 6px 0 0;
      padding: 15px;
      text-align: center !important;
    }

    .modal.inmodal .modal-header .modal-icon {
      font-size: 24px;
      color: #1ab394;
      margin-right: 10px;
    }

    .modal.inmodal .modal-header .modal-title {
      color: #333333 !important;
      font-size: 18px;
      font-weight: 500;
      line-height: 1.1;
      margin: 0;
      text-align: center !important;
    }

    .modal.inmodal .modal-header .font-bold {
      color: #777777 !important;
      font-size: 13px;
      font-weight: 400;
      margin-top: 5px;
      display: block;
      text-align: center !important;
    }

    .modal.inmodal .modal-body {
      background-color: #ffffff !important;
      padding: 20px;
    }

    .modal.inmodal .modal-footer {
      background-color: #ffffff !important;
      border-top: 1px solid #e5e5e5;
      border-radius: 0 0 6px 6px;
      padding: 15px;
      text-align: right;
    }

    .modal.inmodal .btn-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 18px;
      opacity: 0.8;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .modal.inmodal .btn-close:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
      opacity: 1;
      transform: scale(1.1);
    }

    .modal.inmodal .btn-close::before {
      content: "√ó";
      font-size: 22px;
      font-weight: bold;
      line-height: 1;
    }

    /* Anima√ß√µes do modal */
    .modal.inmodal .modal-content.animated {
      animation-duration: 0.6s;
    }

    @keyframes bounceInRight {
      0% {
        opacity: 0;
        transform: translateX(2000px);
      }
      60% {
        opacity: 1;
        transform: translateX(-30px);
      }
      80% {
        transform: translateX(10px);
      }
      100% {
        transform: translateX(0);
      }
    }

    .bounceInRight {
      animation-name: bounceInRight;
    }

    .modal.inmodal .form-control {
      background-color: #ffffff !important;
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      color: #555555 !important;
      font-size: 14px;
      height: 34px;
      line-height: 1.42857143;
      padding: 6px 12px;
      width: 100%;
    }
    .modal.inmodal .form-control:focus {
      background-color: #ffffff !important;
      border-color: #66afe9;
      box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(102, 175, 233, 0.6);
      color: #555555 !important;
      outline: 0;
    }

    .modal.inmodal .form-group label {
      color: #555555 !important;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.42857143;
      margin-bottom: 5px;
      padding-top: 7px;
      display: block;
    }

    .modal.inmodal .form-group {
      margin-bottom: 15px;
    }



    .modal .btn-close {
      background: transparent;
      border: 0;
      cursor: pointer;
      font-size: 21px;
      font-weight: bold;
      line-height: 1;
      opacity: 0.2;
      padding: 0;
    }

    .modal .btn-close:hover {
      opacity: 0.5;
    }

    .modal .btn {
      background-image: none;
      border: 1px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      font-size: 14px;
      font-weight: normal;
      line-height: 1.42857143;
      margin-bottom: 0;
      padding: 6px 12px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }

    .modal.inmodal .btn-primary {
      background-color: #1ab394 !important;
      border-color: #1ab394 !important;
      color: #ffffff !important;
      border-radius: 3px;
      padding: 6px 12px;
      font-size: 14px;
    }

    .modal.inmodal .btn-primary:hover {
      background-color: #18a085 !important;
      border-color: #18a085 !important;
      color: #ffffff !important;
    }

    .modal.inmodal .btn-white {
      background-color: #ffffff !important;
      border: 1px solid #cccccc !important;
      color: #333333 !important;
      border-radius: 3px;
      padding: 6px 12px;
      font-size: 14px;
    }

    .modal.inmodal .btn-white:hover {
      background-color: #e6e6e6 !important;
      border-color: #adadad !important;
      color: #333333 !important;
    }

    .modal .mb-3 {
      margin-bottom: 15px;
    }

    /* Garantir fundo s√≥lido em todos os elementos do modal */
    .modal.inmodal * {
      background-color: #ffffff !important;
    }

    .modal.inmodal .modal-header {
      background-color: #ffffff !important;
    }

    .modal.inmodal .modal-body {
      background-color: #ffffff !important;
    }

    .modal.inmodal .modal-footer {
      background-color: #ffffff !important;
    }

    .modal.inmodal .form-group {
      background-color: transparent !important;
    }

    .modal.inmodal .form-control {
      background-color: #ffffff !important;
    }

    /* Garantir que o campo de instrumento seja ocultado para organistas */
    .modal.inmodal #instrumentoContainer[style*="display: none"],
    .modal.inmodal #modalInstrumentoContainer[style*="display: none"] {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .modal.inmodal #classeContainer[style*="display: block"] {
      display: block !important;
    }

    /* CSS adicional para for√ßar oculta√ß√£o do campo de instrumento */
    .modal.inmodal .organista-mode #instrumentoContainer,
    .modal.inmodal .organista-mode #modalInstrumentoContainer {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .modal.inmodal .organista-mode #classeContainer {
      display: block !important;
    }

    /* CSS espec√≠fico para cargos n√£o musicais */
    .modal.inmodal .cargo-nao-musical #modalInstrumentoContainer {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .modal.inmodal .cargo-nao-musical #classeContainer {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Responsividade do modal */
    @media (max-width: 768px) {
      .modal.inmodal .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
      }

      .modal.inmodal .modal-header {
        padding: 15px 20px;
        text-align: center !important;
      }

      .modal.inmodal .modal-header .modal-title {
        font-size: 18px;
        text-align: center !important;
      }

      .modal.inmodal .modal-header .font-bold {
        font-size: 12px;
        text-align: center !important;
      }

      .modal.inmodal .modal-body {
        padding: 20px 15px;
      }

      .modal.inmodal .modal-footer {
        padding: 15px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .modal.inmodal .modal-footer .btn {
        width: auto;
        margin: 0;
        display: inline-flex;
        flex: 0 0 auto;
        min-width: 120px;
      }

      .modal.inmodal .row .col-md-6 {
        margin-bottom: 15px;
      }
      
      /* CSS espec√≠fico para modal NovaComum no mobile */
      #modalNovaComum .modal-footer {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 15px !important;
        padding: 20px 15px !important;
        text-align: center !important;
      }
      
      #modalNovaComum .modal-footer .btn {
        flex: 0 0 auto !important;
        min-width: 130px !important;
        margin: 0 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
    }


    /* Estilos para autocomplete de comuns */
    .comum-suggestions {
      background-color: #ffffff;
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      max-height: 500px; /* üöÄ Aumentado para mostrar mais comuns */
      overflow-y: auto;
      z-index: 9999;
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
      color: #333333;
      transition: background-color 0.2s ease;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.selected {
      background-color: #f8f9fa;
      color: #007bff;
    }

    .suggestion-item.no-results {
      color: #6c757d;
      font-style: italic;
      cursor: default;
    }

    .suggestion-item.no-results:hover {
      background-color: transparent;
      color: #6c757d;
    }

    /* Estilos para checkbox de adi√ß√£o manual */
    .modal .form-check {
      padding-left: 0;
    }

    .modal .form-check-input {
      margin-top: 0.25rem;
      margin-right: 0.5rem;
    }

    .modal .form-check-label {
      color: #555555;
      font-size: 14px;
      line-height: 1.4;
      cursor: pointer;
    }

    .modal .form-check-label strong {
      color: #333333;
      font-weight: 600;
    }

    .modal .form-check-label small {
      color: #6c757d;
      font-size: 12px;
      line-height: 1.3;
    }

  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <!-- Logo, T√≠tulo e Local -->
      <div class="header-left">
      <div class="header-brand">
        <div class="brand-logo">
          <i class="fa fa-chart-bar"></i>
        </div>
        <div class="brand-text">
          <h1>Sistema de Contagem</h1>
            <div class="user-location">
              <i class="fas fa-map-marker-alt"></i>
              <span>Ensaio: <span id="currentLocation"></span></span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Informa√ß√µes do Usu√°rio -->
      <div class="header-user-info">
        <div class="user-profile">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-details">
            <span class="user-name" id="currentUser">Ricardo Grangeiro</span>
            <span class="user-role" id="currentUserRole">Usu√°rio</span>
          </div>
        </div>
      </div>
      
      <!-- A√ß√µes e Controles - Padr√£o Inspinia -->
      <div class="header-actions">
        <button class="action-btn" id="editBtn" title="Modo de edi√ß√£o" onclick="toggleEditMode()">
          <i class="fa fa-cog"></i>
          <span class="icon-fallback">‚öôÔ∏è</span>
        </button>
        <button class="action-btn" id="logoutBtn" title="Sair do sistema" onclick="logout()">
          <i class="fa fa-sign-out"></i>
          <span class="icon-fallback">üö™</span>
        </button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Registro de Participante</h2>
        <p class="card-subtitle">Selecione as informa√ß√µes do participante para registrar a presen√ßa</p>
            </div>
      <div class="card-body">

        <div id="apiError" class="alert alert-danger d-none" role="alert" style="display: none !important;"></div>

        <form id="formPresenca" autocomplete="on">
          <div class="form-group">
            <label for="comumInput" class="form-label required">COMUM CONGREGA√á√ÉO</label>
            <div class="field-with-icon">
              <input type="text" id="comumInput" name="comum" class="form-control" placeholder="Digite a comum e selecione..." autocomplete="off" autofocus required>
              <span class="field-icon"><i class="fa fa-building"></i></span>
              <div id="comumResults" class="suggestions-dropdown"></div>
            </div>
            <div class="form-text">Digite para pesquisar ou clique para ver todas as op√ß√µes.</div>
            <a id="btnAbrirModal" class="link-mini" href="#" role="button">+ Novo registro</a>
          </div>

          <div class="form-group">
            <label for="cargo" class="form-label required">CARGO/MINIST√âRIO</label>
            <div class="field-with-icon">
            <select id="cargo" class="form-select" required>
              <option value="">Selecione o cargo...</option>
            </select>
              <span class="field-icon"><i class="fa fa-users"></i></span>
            </div>
          </div>

          <div class="field-container" id="instrumentoContainer">
            <div class="form-group">
              <label for="instrumento" class="form-label">INSTRUMENTO (APENAS PARA CARGOS MUSICAIS)</label>
              <div class="field-with-icon">
            <select id="instrumento" class="form-select">
              <option value="">Selecione o instrumento...</option>
            </select>
              <span class="field-icon"><i class="fa fa-music"></i></span>
            </div>
            </div>
          </div>

          <div class="form-group">
            <label for="nome" class="form-label required">NOME E SOBRENOME</label>
            <div class="field-with-icon">
              <select id="nome" name="nome" class="form-select" required>
                <option value="">Selecione um nome da lista...</option>
              </select>
            </div>
            <div class="form-text">Selecione um nome da lista ap√≥s preencher Comum e Cargo.</div>
            <div id="nomeResults" class="suggestions-dropdown" style="display:none;"></div>
          </div>
        </form>
      </div>

      <!-- Action Bar -->
      <div class="action-bar">
        <button id="btnSubmit" type="button" class="btn btn-primary" onclick="handleSubmit(event)">
          <i class="fas fa-paper-plane" style="font-size: 12px; margin-right: 6px;"></i>
          Enviar Registro
        </button>
        
        <div class="queue-info">
          <div class="queue-status">
            <span id="queue-count">0</span> itens em fila
            <span id="queue-status" class="queue-badge empty"></span>
          </div>
          <div class="offline-info" id="offlineInfo" style="display: none;">
            <small>üì± Modo offline - dados ser√£o sincronizados quando voltar online</small>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal: Nova comum / m√∫sico - Estilo Inspinia -->
  <div class="modal inmodal" id="modalNovaComum" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <i class="fa fa-laptop modal-icon" style="font-size: 84px; color: #e2e3e3; display: block; margin-bottom: 10px;"></i>
          <h4 class="modal-title" id="modalNovaComumLabel">Novo Registro</h4>
          <small class="font-bold">Use o formul√°rio para o novo registro</small> 
        </div>
          
        <div class="modal-body">
          <div id="sheetsError" class="alert alert-danger d-none" style="display: none !important;"></div>
          
          <div class="form-group">
            <label for="gsComum">Comum*</label>
            <input type="text" id="gsComum" class="form-control" placeholder="Ex.: √Ågua Rasa" required
          </div>
          
          <div class="form-group">
            <label for="gsCidade">Cidade*</label>
            <input type="text" id="gsCidade" class="form-control" placeholder="Ex.: S√£o Paulo" required>
          </div>
          
          <div class="form-group">
            <label for="gsCargo">Cargo/Minist√©rio*</label>
            <select id="gsCargo" class="form-control" required>
              <option value="">Selecione um cargo...</option>
            </select>
          </div>
          
          <div class="form-group" id="modalInstrumentoContainer">
            <label for="gsInstrumento">Instrumento (se M√∫sico)</label>
            <select id="gsInstrumento" class="form-control">
              <option value="">Selecione um instrumento...</option>
            </select>
          </div>
          
          <div class="form-group" id="classeContainer" style="display: none;">
            <label for="gsClasse">Classe da Organista</label>
            <select id="gsClasse" class="form-control">
              <option value="">Selecione a classe...</option>
              <option value="Ensaio">Ensaio</option>
              <option value="Meia-Hora">Meia-Hora</option>
              <option value="RDJM">RDJM</option>
              <option value="Culto a Noite">Culto a Noite</option>
              <option value="Oficializada">Oficializada</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="gsNome">Nome completo*</label>
            <input type="text" id="gsNome" class="form-control" placeholder="Ex.: Jo√£o da Silva" required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-white" data-bs-dismiss="modal">
            <i class="fas fa-times" style="font-size: 11px; margin-right: 5px; color: #676a6c; background: transparent; border: none; padding: 0;"></i> Fechar
          </button>
          <button type="button" class="btn btn-primary" id="btnSalvarGS">
            <i class="fas fa-save" style="font-size: 11px; margin-right: 5px; color: white; background: transparent; border: none; padding: 0;"></i> Salvar registro
          </button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <!-- Scripts com fallbacks -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" 
          onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/supabase/2.38.0/supabase.min.js';"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js@10/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js';"></script>
  
  <!-- Corre√ß√µes para deploy em produ√ß√£o -->
  <script src="./deploy-fix.js"></script>

  <!-- Fallback para SweetAlert2 -->

  <!-- App principal -->
  <script src="app.js?v=20250127"></script>
  
  <script>
    function toggleStatus() {
      const btn = document.getElementById("statusBtn");
      if (btn.classList.contains("offline")) {
        btn.classList.remove("offline");
        btn.textContent = "Online";
      } else {
        btn.classList.add("offline");
        btn.textContent = "Offline";
      }
    }

    // Fun√ß√£o removida - controle de visibilidade do instrumento agora √© feito pelo app.js

    // Fun√ß√£o removida - controle de visibilidade do instrumento agora √© feito pelo app.js


    // Fun√ß√£o removida - toggleConnectionStatus n√£o √© mais necess√°ria

    // üö® CORRE√á√ÉO: Simplificar para usar API padr√£o do SweetAlert2 (conforme documenta√ß√£o)
    // Documenta√ß√£o: https://sweetalert2.github.io/#examples
    window.showStatusModal = function showStatusModal(title, text, type, callback) {
      try {
        if (typeof Swal === 'undefined') {
          alert(`${title}${text ? '\n' + text : ''}`);
          if (typeof callback === 'function') setTimeout(callback, 50);
          return;
        }

        // üö® CORRE√á√ÉO: Usar API padr√£o do SweetAlert2 - simples e funcional
        const icon = (type === 'success' || type === 'error' || type === 'warning' || type === 'info' || type === 'question') ? type : 'info';

        Swal.fire({
          icon: icon,
          title: title,
          text: text || '',
          showConfirmButton: false,
          timer: 1500,
          timerProgressBar: true
        }).then(() => {
          if (typeof callback === 'function') callback();
        });
      } catch (e) {
        console.error('‚ùå Erro ao exibir SweetAlert2:', e);
        alert(`${title}${text ? '\n' + text : ''}`);
        if (typeof callback === 'function') setTimeout(callback, 50);
      }
    }

    // Fun√ß√£o para for√ßar recarregamento da p√°gina (√∫til para casos de emerg√™ncia)
    window.forceReload = function() {
      console.log('üîÑ For√ßando recarregamento da p√°gina...');
      // Limpar todos os overlays do SweetAlert2
      const overlays = document.querySelectorAll('.swal2-backdrop, .swal2-container, .swal2-popup');
      overlays.forEach(overlay => {
        if (overlay && overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      });
      // Recarregar p√°gina
      window.location.reload();
    };

    // Fun√ß√£o de logout
    function logout() {
      // Verificar se SweetAlert2 est√° dispon√≠vel
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          title: 'Confirmar Sa√≠da',
          text: 'Tem certeza que deseja sair do sistema?',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sim, sair',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#dc2626'
        }).then((result) => {
          if (result.isConfirmed) {
            performLogout();
          }
        });
      } else {
        // Fallback: usar confirm nativo
        if (confirm('Tem certeza que deseja sair do sistema?')) {
          performLogout();
        }
      }
    }

    // Fun√ß√£o para executar logout
    function performLogout() {
      // Limpar dados locais
      localStorage.clear();
      sessionStorage.clear();
      
      // Mostrar modal de sa√≠da
      showStatusModal('SAINDO...', 'REDIRECIONANDO PARA A P√ÅGINA DE LOGIN', 'success');
      
      // Redirecionar ap√≥s 1.5 segundos
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    }

    // Fun√ß√£o para controlar modo de edi√ß√£o
    function toggleEditMode() {
      const editBtn = document.getElementById('editBtn');
      const isEditMode = editBtn.classList.contains('active');
      
      if (isEditMode) {
        editBtn.classList.remove('active');
        editBtn.textContent = '‚úèÔ∏è';
      } else {
        editBtn.classList.add('active');
        editBtn.textContent = 'üîí';
      }
    }

    // Verificar se usu√°rio √© master e mostrar/ocultar bot√£o de edi√ß√£o
    function checkUserPermissions() {
      const editBtn = document.getElementById('editMasterBtn');
      const currentUser = document.getElementById('header-user').textContent;
      
      // Lista de usu√°rios master (pode ser expandida)
      const masterUsers = [
        'Ricardo Grangeiro',
        'Admin',
        'Master',
        'Administrador'
      ];
      
      const isMaster = masterUsers.some(user => 
        currentUser.toLowerCase().includes(user.toLowerCase())
      );
      
      if (isMaster) {
        editBtn.classList.remove('hidden');
      } else {
        editBtn.classList.add('hidden');
      }
    }

    // Fun√ß√£o para detectar se √© mobile (sincronizada com app.js)
    function isMobileDevice() {
      // Usar a vari√°vel global isMobile se estiver dispon√≠vel
      if (typeof isMobile !== 'undefined') {
        return isMobile;
      }
      // Fallback para detec√ß√£o local
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    // Fun√ß√£o para controlar digita√ß√£o manual de nomes
    function setupNomeManual() {
      const nomeInput = document.getElementById('nome');
      const nomeResults = document.getElementById('nomeResults');
      
      if (!nomeInput || !nomeResults) return;
      
      let isManualEntry = false;
      let selectedFromList = false;
      
      // üö® SOLU√á√ÉO DEFINITIVA: Garantir que o campo est√° SEMPRE habilitado e clic√°vel
      function garantirCampoEditavel() {
        const nomeInput = document.getElementById('nome');
        if (nomeInput) {
          nomeInput.disabled = false;
          nomeInput.readOnly = false;
          nomeInput.removeAttribute('readonly');
          nomeInput.removeAttribute('disabled');
          nomeInput.style.pointerEvents = 'auto';
          nomeInput.style.opacity = '1';
          nomeInput.style.cursor = 'text';
          nomeInput.style.userSelect = 'text';
          nomeInput.setAttribute('inputmode', 'text');
          nomeInput.setAttribute('tabindex', '0');
        }
      }
      
      // Garantir campo edit√°vel imediatamente e periodicamente
      garantirCampoEditavel();
      setInterval(garantirCampoEditavel, 1000);
      
      // Remover event listeners existentes para evitar conflitos
      nomeInput.removeEventListener('input', handleNomeInput);
      nomeInput.removeEventListener('focus', handleNomeFocus);
      nomeInput.removeEventListener('keydown', handleNomeKeydown);
      
      // Event listener para digita√ß√£o - mostra dropdown ap√≥s 3 caracteres
      function handleNomeInput(e) {
        if (window.suppressManualNome) return;
        
        // üö® CORRE√á√ÉO: Se o campo estava readonly, remover para permitir digita√ß√£o
        if (nomeInput.readOnly) {
          nomeInput.readOnly = false;
          nomeInput.removeAttribute('readonly');
          console.log('üîì Campo nome liberado para digita√ß√£o manual');
        }
        
        const value = e.target.value.trim();
        selectedFromList = false;
        
        // CORRE√á√ÉO CR√çTICA: Limpar atributo de sele√ß√£o da lista quando usu√°rio digita
        e.target.removeAttribute('data-selected-from-list');
        
        console.log('üîç handleNomeInput chamado:', {
          value: value,
          isManualEntry: isManualEntry,
          selectedFromList: selectedFromList,
          length: value.length
        });
        
        // üéØ CORRE√á√ÉO: Marcar como entrada manual quando usu√°rio digita e n√£o foi sele√ß√£o da lista
        if (value.length > 0) {
          e.target.setAttribute('data-nome-manual', 'true');
          console.log('‚úèÔ∏è Campo marcado como entrada manual via digita√ß√£o');
        }
        
        if (value.length >= 3) {
          // üöÄ SOLU√á√ÉO DEFINITIVA: Usar fun√ß√£o simples que sempre funciona
          console.log('üîç Buscando nomes ap√≥s 3 caracteres:', value);
          if (typeof window.buscarNomesDireto === 'function') {
            window.buscarNomesDireto(value);
          } else {
            console.error('‚ùå buscarNomesDireto n√£o dispon√≠vel!');
          }
        } else {
          hideSuggestions();
        }
      }
      
      // Event listener para navega√ß√£o por teclado
      function handleNomeKeydown(e) {
        const nomeResults = document.getElementById('nomeResults');
        if (!nomeResults || !nomeResults.classList.contains('show')) return;
        
        const items = nomeResults.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;
        
        let currentIndex = -1;
        items.forEach((item, index) => {
          if (item.classList.contains('selected')) {
            currentIndex = index;
          }
        });
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            currentIndex = Math.min(currentIndex + 1, items.length - 1);
            updateNomeSelection(items, currentIndex);
            break;
          case 'ArrowUp':
            e.preventDefault();
            currentIndex = Math.max(currentIndex - 1, -1);
            updateNomeSelection(items, currentIndex);
            break;
          case 'Enter':
            e.preventDefault();
            if (currentIndex >= 0 && items[currentIndex]) {
              items[currentIndex].click();
            }
            break;
          case 'Escape':
            e.preventDefault();
            hideSuggestions();
            break;
        }
      }
      
      // Fun√ß√£o para atualizar sele√ß√£o visual
      function updateNomeSelection(items, selectedIndex) {
        items.forEach((item, index) => {
          if (index === selectedIndex) {
            item.classList.add('selected');
            item.style.backgroundColor = '#e5f3ff';
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('selected');
            item.style.backgroundColor = item.classList.contains('manual-entry') ? '#f8fafc' : 'transparent';
          }
        });
      }
      
      // üö® CORRE√á√ÉO CR√çTICA: Garantir que o campo esteja sempre edit√°vel
      function handleNomeFocus(e) {
        const value = e.target.value.trim();
        
        // SEMPRE garantir que o campo est√° edit√°vel (n√£o readonly)
        nomeInput.readOnly = false;
        nomeInput.removeAttribute('readonly');
        nomeInput.disabled = false;
        nomeInput.style.pointerEvents = 'auto';
        nomeInput.style.opacity = '1';
        
        // No mobile, permitir teclado mas SEM sugest√µes nativas
        if (isMobileDevice()) {
          nomeInput.setAttribute('inputmode', 'text');
          nomeInput.setAttribute('autocomplete', 'off');
          nomeInput.setAttribute('autocorrect', 'off');
          nomeInput.setAttribute('autocapitalize', 'off');
          nomeInput.removeAttribute('list');
        }
        
        // Se j√° tem 3+ caracteres, buscar automaticamente
          if (value.length >= 3) {
            // üöÄ SOLU√á√ÉO DEFINITIVA: Usar fun√ß√£o simples que sempre funciona
            if (typeof window.buscarNomesDireto === 'function') {
              window.buscarNomesDireto(value);
            }
          }
      }
      
      // Abrir dropdown automaticamente ao clicar no campo (mobile e desktop)
      function handleNomeClick(e) {
        // üö® CORRE√á√ÉO CR√çTICA MOBILE: Garantir que o campo est√° edit√°vel e pode receber foco
        nomeInput.disabled = false;
        nomeInput.readOnly = false;
        nomeInput.removeAttribute('readonly');
        nomeInput.removeAttribute('disabled');
        nomeInput.style.pointerEvents = 'auto';
        nomeInput.style.opacity = '1';
        
        // REMOVIDO: Verifica√ß√£o de √≠cone de seta - n√£o existe mais
        
        const value = e.target.value.trim();
        
        // üõ°Ô∏è DETEC√á√ÉO XIAOMI: Detectar se √© dispositivo Xiaomi
        const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                               /Mi\s/i.test(navigator.userAgent) ||
                               /POCO/i.test(navigator.userAgent);
        
        // No mobile, permitir teclado mas SEM sugest√µes nativas
        if (isMobileDevice()) {
          // üö® CORRE√á√ÉO CR√çTICA: SEMPRE garantir que o teclado possa abrir
          nomeInput.setAttribute('inputmode', 'text');
          nomeInput.setAttribute('autocomplete', 'off');
          nomeInput.setAttribute('autocorrect', 'off');
          nomeInput.setAttribute('autocapitalize', 'off');
          nomeInput.removeAttribute('list');
          
          // Garantir que o campo possa receber foco
          setTimeout(() => {
            nomeInput.focus();
          }, 10);
          
          // üö® CORRE√á√ÉO CR√çTICA XIAOMI: Garantir que nomes sejam carregados antes de filtrar
          if (isXiaomiDevice) {
            // Verificar se window.nomesData est√° vazio
            if (!window.nomesData || !Array.isArray(window.nomesData) || window.nomesData.length === 0) {
              console.log('üì± XIAOMI - handleNomeClick: window.nomesData vazio - carregando nomes primeiro...');
              
              // Tentar carregar nomes primeiro
              const comum = document.getElementById('comumInput')?.value?.trim();
              const cargo = document.getElementById('cargo')?.value?.trim();
              
              if (comum && cargo && typeof loadNomes === 'function') {
                loadNomes().then(() => {
                  console.log('üì± XIAOMI - handleNomeClick: Nomes carregados, abrindo dropdown...');
                  // Ap√≥s carregar, abrir dropdown
                  if (typeof window.buscarNomesDireto === 'function') {
                    window.buscarNomesDireto(value || '');
                  } else if (typeof window.searchNomesComContexto === 'function') {
                    window.searchNomesComContexto(value || '');
                  }
                }).catch((error) => {
                  console.error('‚ùå XIAOMI - handleNomeClick: Erro ao carregar nomes:', error);
                  // Tentar abrir dropdown mesmo assim
                  if (typeof window.buscarNomesDireto === 'function') {
                    window.buscarNomesDireto(value || '');
                  } else if (typeof window.searchNomesComContexto === 'function') {
                    window.searchNomesComContexto(value || '');
                  }
                });
                return; // Retornar para n√£o continuar
              }
            }
          }
          
          // Abrir dropdown imediatamente - usar fun√ß√£o direta
          if (typeof window.buscarNomesDireto === 'function') {
            window.buscarNomesDireto(value || '');
          }
        } else {
          // Desktop: abrir dropdown imediatamente
          if (typeof window.searchNomesComContexto === 'function') {
            if (value.length >= 3) {
              window.searchNomesComContexto(value);
            } else {
              window.searchNomesComContexto('');
            }
          } else {
            setTimeout(() => {
              if (typeof window.searchNomesComContexto === 'function') {
                if (value.length >= 3) {
                  window.searchNomesComContexto(value);
                } else {
                  window.searchNomesComContexto('');
                }
              }
            }, 50);
          }
        }
      }
      
      // Abrir dropdown no touchstart (mobile) - SEMPRE abrir
      function handleNomeTouchStart(e) {
        if (isMobileDevice()) {
          // üö® CORRE√á√ÉO CR√çTICA MOBILE: Garantir que o campo est√° edit√°vel e pode receber foco
          nomeInput.disabled = false;
          nomeInput.readOnly = false;
          nomeInput.removeAttribute('readonly');
          nomeInput.removeAttribute('disabled');
          nomeInput.style.pointerEvents = 'auto';
          nomeInput.style.opacity = '1';
          
          const value = e.target.value.trim();
          
          // üõ°Ô∏è DETEC√á√ÉO XIAOMI: Detectar se √© dispositivo Xiaomi
          const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                                 /Mi\s/i.test(navigator.userAgent) ||
                                 /POCO/i.test(navigator.userAgent);
          
          // Permitir teclado mas SEM sugest√µes nativas
          nomeInput.setAttribute('inputmode', 'text');
          nomeInput.setAttribute('autocomplete', 'off');
          nomeInput.setAttribute('autocorrect', 'off');
          nomeInput.setAttribute('autocapitalize', 'off');
          nomeInput.removeAttribute('list');
          
          // Garantir que o campo possa receber foco
          setTimeout(() => {
            nomeInput.focus();
          }, 10);
          
          // üö® CORRE√á√ÉO CR√çTICA XIAOMI: Garantir que nomes sejam carregados antes de filtrar
          if (isXiaomiDevice) {
            // Verificar se window.nomesData est√° vazio
            if (!window.nomesData || !Array.isArray(window.nomesData) || window.nomesData.length === 0) {
              console.log('üì± XIAOMI - handleNomeTouchStart: window.nomesData vazio - carregando nomes primeiro...');
              
              // Tentar carregar nomes primeiro
              const comum = document.getElementById('comumInput')?.value?.trim();
              const cargo = document.getElementById('cargo')?.value?.trim();
              
              if (comum && cargo && typeof loadNomes === 'function') {
                loadNomes().then(() => {
                  console.log('üì± XIAOMI - handleNomeTouchStart: Nomes carregados, abrindo dropdown...');
                  // Ap√≥s carregar, abrir dropdown
                  if (typeof window.buscarNomesDireto === 'function') {
                    window.buscarNomesDireto(value || '');
                  } else if (typeof window.searchNomesComContexto === 'function') {
                    window.searchNomesComContexto(value || '');
                  }
                }).catch((error) => {
                  console.error('‚ùå XIAOMI - handleNomeTouchStart: Erro ao carregar nomes:', error);
                  // Tentar abrir dropdown mesmo assim
                  if (typeof window.buscarNomesDireto === 'function') {
                    window.buscarNomesDireto(value || '');
                  } else if (typeof window.searchNomesComContexto === 'function') {
                    window.searchNomesComContexto(value || '');
                  }
                });
                return; // Retornar para n√£o continuar
              }
            }
          }
          
          // SEMPRE abrir dropdown no mobile - usar fun√ß√£o direta
          if (typeof window.buscarNomesDireto === 'function') {
            window.buscarNomesDireto(value || '');
          }
        }
      }
      
      // üö® CORRE√á√ÉO CR√çTICA MOBILE: Fun√ß√£o para fechar teclado virtual (iOS e Android)
      function fecharTecladoVirtualMobile() {
        if (!isMobileDevice()) return;
        
        console.log('üì± MOBILE: Fechando teclado virtual...');
        
        try {
          // M√©todo 1: Blur do campo atual imediatamente
          nomeInput.blur();
          
          // M√©todo 2: Criar input tempor√°rio invis√≠vel, focar e remover (mais eficaz)
          const tmpInput = document.createElement('input');
          tmpInput.type = 'text';
          tmpInput.style.position = 'fixed';
          tmpInput.style.opacity = '0';
          tmpInput.style.height = '1px';
          tmpInput.style.width = '1px';
          tmpInput.style.top = '-1000px';
          tmpInput.style.left = '-1000px';
          tmpInput.style.pointerEvents = 'none';
          tmpInput.style.zIndex = '-9999';
          tmpInput.setAttribute('readonly', 'readonly');
          tmpInput.setAttribute('tabindex', '-1');
          document.body.appendChild(tmpInput);
          
          // M√©todo 3: Focar no input tempor√°rio para desfocar o campo nome
          // Usar requestAnimationFrame para garantir que o DOM foi atualizado
          requestAnimationFrame(() => {
            tmpInput.focus();
            
            setTimeout(() => {
              tmpInput.blur();
              
              // Remover input tempor√°rio
              if (tmpInput.parentNode) {
                document.body.removeChild(tmpInput);
              }
              
              // M√©todo 4: Remover focus de qualquer elemento ativo
              if (document.activeElement && document.activeElement !== document.body) {
                document.activeElement.blur();
              }
              
              // M√©todo 5: Focar no body para garantir que nenhum campo est√° focado
              document.body.focus();
              document.body.blur();
              
              // M√©todo 6: Blur adicional do campo nome
              nomeInput.blur();
              
              console.log('‚úÖ Teclado virtual fechado');
            }, 150); // Delay otimizado para iOS e Android
          });
        } catch (e) {
          console.warn('‚ö†Ô∏è Erro ao fechar teclado virtual:', e);
          // Fallback: apenas blur
          nomeInput.blur();
          if (document.activeElement && document.activeElement !== document.body) {
            document.activeElement.blur();
          }
        }
      }
      
      // Adicionar event listeners - MOBILE e DESKTOP
      if (isMobileDevice()) {
        // MOBILE: touchstart primeiro (mais responsivo)
        nomeInput.addEventListener('touchstart', handleNomeTouchStart, { passive: true });
        // MOBILE: click tamb√©m
        nomeInput.addEventListener('click', handleNomeClick);
        // MOBILE: focus
      nomeInput.addEventListener('focus', handleNomeFocus);
          } else {
        // DESKTOP: click e focus
        nomeInput.addEventListener('click', handleNomeClick);
        nomeInput.addEventListener('focus', handleNomeFocus);
      }
      
      // Event listeners comuns
      nomeInput.addEventListener('input', handleNomeInput);
      nomeInput.addEventListener('keydown', handleNomeKeydown);
      // REMOVER COMPLETAMENTE DATALIST E SUGEST√ïES DO TECLADO
      const nomeInputField = document.getElementById('nome');
      if (nomeInputField) {
        // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: Detectar dispositivo
        const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                               /Mi\s/i.test(navigator.userAgent) ||
                               /POCO/i.test(navigator.userAgent);
        
        // Remover atributo list
        nomeInputField.removeAttribute('list');
        nomeInputField.setAttribute('autocomplete', 'off');
        nomeInputField.setAttribute('autocorrect', 'off');
        nomeInputField.setAttribute('autocapitalize', 'off');
        nomeInputField.setAttribute('spellcheck', 'false');
        // üö® CORRE√á√ÉO CR√çTICA MOBILE: SEMPRE permitir teclado quando clicar no campo
        nomeInputField.setAttribute('inputmode', 'text'); // Permitir teclado sempre
        
        // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: Garantir que n√£o use sugest√µes do teclado
        if (isXiaomiDevice) {
          // For√ßar remo√ß√£o de qualquer atributo que possa causar sugest√µes do teclado
          nomeInputField.removeAttribute('list');
          nomeInputField.setAttribute('autocomplete', 'off');
          nomeInputField.setAttribute('autocorrect', 'off');
          nomeInputField.setAttribute('autocapitalize', 'off');
          nomeInputField.setAttribute('spellcheck', 'false');
          nomeInputField.setAttribute('inputmode', 'text');
          console.log('üì± XIAOMI/REDMI: Atributos de sugest√µes do teclado removidos');
        }
        
        // Remover datalist se existir
        const datalist = document.getElementById('dlNomes');
        if (datalist) {
          datalist.remove();
        }
        
        // Remover todos os datalists relacionados
        const allDatalists = document.querySelectorAll('datalist[id*="Nomes"], datalist[id*="nome"], datalist');
        allDatalists.forEach(function(dl) {
          if (dl.parentNode) {
            dl.parentNode.removeChild(dl);
          }
        });
        
        // Monitorar e remover qualquer datalist que aparecer
        if (typeof MutationObserver !== 'undefined') {
          const datalistObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && (node.tagName === 'DATALIST' || node.id === 'dlNomes')) {
                  node.remove();
                }
              });
            });
            
            // Verificar se o atributo list foi adicionado
            if (nomeInputField.getAttribute('list')) {
              nomeInputField.removeAttribute('list');
              // üö® CORRE√á√ÉO: N√ÉO setar inputmode='none' - manter 'text' para permitir teclado
              nomeInputField.setAttribute('inputmode', 'text');
            }
          });
          
          datalistObserver.observe(document.body, { childList: true, subtree: true });
          datalistObserver.observe(nomeInputField, { attributes: true, attributeFilter: ['list', 'autocomplete'] });
        }
        
        // Remover periodicamente qualquer datalist
        setInterval(function() {
          const datalist = document.getElementById('dlNomes');
          if (datalist) {
            datalist.remove();
          }
          if (nomeInputField.getAttribute('list')) {
            nomeInputField.removeAttribute('list');
            // üö® CORRE√á√ÉO: N√ÉO setar inputmode='none' - manter 'text' para permitir teclado
            nomeInputField.setAttribute('inputmode', 'text');
          }
        }, 500);
      }
      
      // REMOVIDO: Fun√ß√£o garantirIconeNomeVisivel - √≠cone de seta foi removido
      // O campo nome agora funciona apenas com busca autom√°tica ap√≥s 3 caracteres
      
      // Toggle da seta - simples e funcional
      // REMOVIDO: Todo o c√≥digo do bot√£o toggle - n√£o √© mais necess√°rio
      // O campo funciona ao clicar nele ou ao digitar
      
      // Event listener para clique fora - simplificado
      let clickTimeout = null;
      document.addEventListener('click', function(e) {
        // N√£o fechar dropdown se clicar no bot√£o submit
        const btnSubmit = document.getElementById('btnSubmit');
        if (btnSubmit && btnSubmit.contains(e.target)) {
          hideSuggestions();
          return;
        }
        
        // Limpar timeout anterior se existir
        if (clickTimeout) {
          clearTimeout(clickTimeout);
        }
        
        // Aguardar um pouco para garantir que o dropdown foi processado
        clickTimeout = setTimeout(() => {
          const nomeResults = document.getElementById('nomeResults');
          
          // Verificar se o clique foi fora do campo nome e do dropdown
          if (nomeInput && !nomeInput.contains(e.target) && 
              nomeResults && !nomeResults.contains(e.target) &&
              !e.target.closest('.suggestion-item')) {
            hideSuggestions();
          }
        }, 200);
      });
      
      // Event listener para toque no mobile
      if (isMobileDevice()) {
        let touchTimeout = null;
        document.addEventListener('touchstart', function(e) {
          // Limpar timeout anterior se existir
          if (touchTimeout) {
            clearTimeout(touchTimeout);
          }
          
          // Aguardar um pouco para garantir que o dropdown foi processado
          touchTimeout = setTimeout(() => {
            const nomeResults = document.getElementById('nomeResults');
            
            // Verificar se o toque foi fora do campo nome e do dropdown
            if (nomeInput && !nomeInput.contains(e.target) && 
                nomeResults && !nomeResults.contains(e.target) &&
                !e.target.closest('.suggestion-item')) {
            hideSuggestions();
          }
          }, 200);
        });
      }
      
      // üö® SOLU√á√ÉO DEFINITIVA: Resetar campo nome ap√≥s envio
      window.resetarCampoNome = function resetarCampoNome() {
        console.log('üîÑ Resetando campo nome ap√≥s envio...');
        
        // Limpar window.nomesData para for√ßar novo carregamento
        window.nomesData = [];
        
        // Garantir que o campo nome seja SELECT
        const nomeEl = document.getElementById('nome');
        if (!nomeEl) {
          console.warn('‚ö†Ô∏è Campo nome n√£o encontrado');
          return;
        }
        
        // Se for INPUT, converter para SELECT
        if (nomeEl.tagName === 'INPUT') {
          const selectEl = document.createElement('select');
          selectEl.id = 'nome';
          selectEl.name = 'nome';
          selectEl.className = 'form-select';
          selectEl.required = true;
          selectEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
          nomeEl.parentNode.replaceChild(selectEl, nomeEl);
        } else if (nomeEl.tagName === 'SELECT') {
          // Se j√° √© SELECT, apenas resetar para estado inicial
          nomeEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
          nomeEl.selectedIndex = 0;
        }
        
        // Limpar atributos de estado
        const nomeSelect = document.getElementById('nome');
        if (nomeSelect) {
          nomeSelect.removeAttribute('data-nome-manual');
          nomeSelect.removeAttribute('data-selected-from-list');
          nomeSelect.removeAttribute('data-sam-desatualizado');
          nomeSelect.style.backgroundColor = '';
          nomeSelect.style.borderColor = '';
        }
        
        // Fechar dropdown se existir
        const nomeResults = document.getElementById('nomeResults');
        if (nomeResults) {
          nomeResults.innerHTML = '';
          nomeResults.classList.remove('show');
          nomeResults.style.display = 'none';
        }
        
        console.log('‚úÖ Campo nome resetado para estado inicial');
      };
      
      // üö® CORRE√á√ÉO CR√çTICA ANDROID: Detectar Android e iOS
      const isAndroid = /Android/.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      // üö® CORRE√á√ÉO: Renomear vari√°vel para evitar conflito com fun√ß√£o isMobileDevice()
      const isMobileDeviceVar = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      console.log('üì± Detec√ß√£o de plataforma:', { isAndroid, isIOS, isMobileDevice: isMobileDeviceVar });
      
      // üö® REMOVIDO: Intercepta√ß√£o removida - deixar app.js fazer o trabalho
      // A l√≥gica no app.js j√° trata SELECT corretamente
      
      // üö® SOLU√á√ÉO DEFINITIVA ANDROID: Monitorar window.nomesData e popular SELECT automaticamente
      let nomesDataAnterior = null;
      let verificacaoInterval = null;
      
      function popularSelectSeNecessario() {
        const nomeEl = document.getElementById('nome');
        if (!nomeEl) {
          return;
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: N√ÉO popular se SELECT j√° foi populado no loadNomes
        if (nomeEl.tagName === 'SELECT' && nomeEl.options.length > 1) {
          console.log('‚úÖ SELECT j√° foi populado - n√£o sobrescrevendo');
          return;
        }
        
        // Verificar se window.nomesData foi populada
        if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
          // Verificar se os dados mudaram
          const dadosAtuais = JSON.stringify(window.nomesData.slice(0, 10));
          if (dadosAtuais === nomesDataAnterior) {
            return; // Dados n√£o mudaram, n√£o precisa popular novamente
          }
          
          nomesDataAnterior = dadosAtuais;
          
          // Verificar se o SELECT j√° foi populado
          if (nomeEl.tagName === 'SELECT' && nomeEl.options.length <= 1) {
            console.log('üö® ANDROID FIX: window.nomesData detectada, populando SELECT agora!');
            console.log('üìã window.nomesData:', window.nomesData.length, 'nomes');
            
            // Garantir que √© SELECT
            if (nomeEl.tagName !== 'SELECT') {
              const selectEl = document.createElement('select');
              selectEl.id = 'nome';
              selectEl.name = 'nome';
              selectEl.className = 'form-select';
              selectEl.required = true;
              nomeEl.parentNode.replaceChild(selectEl, nomeEl);
              const newNomeEl = document.getElementById('nome');
              if (newNomeEl) {
                popularSelectSeNecessario();
                return;
              }
            }
            
            // üö® CORRE√á√ÉO ANDROID: Usar appendChild (igual ao iOS que funciona)
            // Limpar SELECT completamente usando removeChild (igual ao app.js)
            while (nomeEl.firstChild) {
              nomeEl.removeChild(nomeEl.firstChild);
            }
            
            // Adicionar primeira op√ß√£o
            const primeiraOpcao = document.createElement('option');
            primeiraOpcao.value = '';
            primeiraOpcao.textContent = 'Selecione um nome da lista (ou digite, se offline)';
            nomeEl.appendChild(primeiraOpcao);
            
            const nomesStrings = window.nomesData.map(nome => {
              return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
            }).filter(Boolean);
            
            // Adicionar nomes com appendChild (igual ao iOS)
            nomesStrings.forEach((nome, index) => {
              const option = document.createElement('option');
              option.value = nome;
              option.textContent = nome;
              nomeEl.appendChild(option);
            });
            
            // Adicionar op√ß√£o manual
            const optionManual = document.createElement('option');
            optionManual.value = '__MANUAL_INPUT__';
            optionManual.textContent = '‚úèÔ∏è Adicionar novo nome manualmente';
            optionManual.style.backgroundColor = '#e3f2fd';
            optionManual.style.color = '#1976d2';
            optionManual.style.fontWeight = 'bold';
            nomeEl.appendChild(optionManual);
            
            // üö® CORRE√á√ÉO ANDROID: For√ßar renderiza√ß√£o (igual ao iOS)
            nomeEl.style.backgroundColor = '';
            nomeEl.style.display = 'block';
            nomeEl.style.visibility = 'visible';
            void nomeEl.offsetHeight;
            void nomeEl.offsetWidth;
            
            // üö® PROTE√á√ÉO CR√çTICA: Marcar SELECT como populado
            nomeEl.setAttribute('data-populado', 'true');
            nomeEl.setAttribute('data-populado-em', Date.now().toString());
            
            // Usar requestAnimationFrame para garantir renderiza√ß√£o no Android
            requestAnimationFrame(() => {
              void nomeEl.offsetHeight;
              void nomeEl.offsetWidth;
              
              // Verificar se foi populado corretamente
              const opcoesCount = nomeEl.options.length;
              if (opcoesCount > 1) {
                console.log('‚úÖ SELECT populado com sucesso no Android:', opcoesCount, 'op√ß√µes');
              } else {
                console.error('‚ùå ERRO: SELECT n√£o foi populado no Android! Apenas', opcoesCount, 'op√ß√µes');
              }
            });
            
            // Event listener para op√ß√£o manual
            nomeEl.removeEventListener('change', handleNomeSelectChangeManual);
            nomeEl.addEventListener('change', handleNomeSelectChangeManual);
            
            function handleNomeSelectChangeManual(e) {
              if (e.target.value === '__MANUAL_INPUT__') {
                const selectEl = e.target;
                const inputEl = document.createElement('input');
                inputEl.type = 'text';
                inputEl.id = 'nome';
                inputEl.name = 'nome';
                inputEl.className = 'form-control';
                inputEl.placeholder = 'Digite o nome completo...';
                inputEl.required = true;
                inputEl.setAttribute('data-nome-manual', 'true');
                selectEl.parentNode.replaceChild(inputEl, selectEl);
                inputEl.focus();
              }
            }
            
            console.log('‚úÖ SELECT populado com', nomesStrings.length, 'nomes (total options:', nomeEl.options.length, ')');
          } else if (nomeEl.tagName === 'SELECT' && nomeEl.options.length > 1) {
            console.log('‚úÖ SELECT j√° foi populado com', nomeEl.options.length, 'op√ß√µes');
          }
        } else if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length === 0) {
          // Se n√£o h√° nomes, converter para INPUT
          if (nomeEl.tagName === 'SELECT' && nomeEl.options.length <= 1) {
            console.log('üìù Nenhum nome - convertendo para INPUT');
            if (typeof window.converterParaInput === 'function') {
              window.converterParaInput(nomeEl);
            }
          }
        }
      }
      
      // Iniciar monitoramento de window.nomesData
      if (isAndroid) {
        console.log('üì± ANDROID: Iniciando monitoramento de window.nomesData...');
        
        // Tornar fun√ß√£o global para ser acess√≠vel de qualquer lugar
        window.popularSelectSeNecessario = popularSelectSeNecessario;
        
        // Verificar a cada 300ms se window.nomesData foi populada (mais frequente no Android)
        verificacaoInterval = setInterval(() => {
          const nomeElCheck = document.getElementById('nome');
          // Verificar se app.js j√° populou o SELECT
          if (nomeElCheck && nomeElCheck.tagName === 'SELECT' && 
              (nomeElCheck.options.length > 1 || nomeElCheck.getAttribute('data-populado') === 'true')) {
            // SELECT j√° foi populado - n√£o fazer nada
            return;
          }
          // Se n√£o foi populado, tentar popular
          popularSelectSeNecessario();
        }, 300);
        
        // Parar ap√≥s 30 segundos para n√£o sobrecarregar
        setTimeout(() => {
          if (verificacaoInterval) {
            clearInterval(verificacaoInterval);
            verificacaoInterval = null;
            console.log('üì± ANDROID: Monitoramento encerrado ap√≥s 30s');
          }
        }, 30000);
      }
      
      // üö® SOLU√á√ÉO DEFINITIVA: Interceptar atribui√ß√µes a window.nomesData
      if (isAndroid) {
        let nomesDataValue = window.nomesData;
        
        Object.defineProperty(window, 'nomesData', {
          get: function() {
            return nomesDataValue;
          },
          set: function(newValue) {
            console.log('üîÑ window.nomesData foi atribu√≠do:', newValue?.length || 0, 'nomes');
            nomesDataValue = newValue;
            
            // Se h√° nomes, popular SELECT imediatamente
            if (newValue && Array.isArray(newValue) && newValue.length > 0) {
              console.log('üö® ANDROID: window.nomesData foi populada - populando SELECT AGORA!');
              // üö® CORRE√á√ÉO ANDROID: Aguardar um pouco mais para garantir que app.js terminou de popular
              setTimeout(() => {
                const nomeElCheck = document.getElementById('nome');
                // Verificar se app.js j√° populou o SELECT
                if (nomeElCheck && nomeElCheck.tagName === 'SELECT' && 
                    (nomeElCheck.options.length > 1 || nomeElCheck.getAttribute('data-populado') === 'true')) {
                  console.log('‚úÖ app.js j√° populou o SELECT - n√£o populando novamente');
                  return;
                }
                // Se n√£o foi populado, popular agora
                if (typeof popularSelectSeNecessario === 'function') {
                  popularSelectSeNecessario();
                }
              }, 200);
            }
          },
          configurable: true
        });
        
        console.log('‚úÖ Intercepta√ß√£o de window.nomesData configurada para Android');
      }
      
      // üö® REMOVIDO: Todas as intercepta√ß√µes removidas - deixar app.js fazer o trabalho
      // A l√≥gica no app.js j√° trata SELECT corretamente para iOS e Android
      
      // üö® FUN√á√ÉO PARA CONVERTER SELECT PARA INPUT
      window.converterParaInput = function converterParaInput(selectEl) {
        if (!selectEl || selectEl.tagName !== 'SELECT') {
          console.error('‚ùå Elemento n√£o √© SELECT para convers√£o');
          return null;
        }
        
        console.log('üîÑ Convertendo SELECT para INPUT (sem nomes)...');
        
        const inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.id = 'nome';
        inputEl.name = 'nome';
        inputEl.className = 'form-control';
        inputEl.placeholder = 'Digite o nome completo...';
        inputEl.required = true;
        inputEl.setAttribute('data-nome-manual', 'true');
        inputEl.setAttribute('data-sem-nomes', 'true');
        
        // Estilos para mobile
        if (isMobileDevice) {
          inputEl.style.fontSize = '16px';
          inputEl.style.minHeight = '44px';
          inputEl.style.padding = '12px 16px';
        }
        
        // Substituir SELECT por INPUT
        try {
          selectEl.parentNode.replaceChild(inputEl, selectEl);
          console.log('‚úÖ SELECT convertido para INPUT - digita√ß√£o manual habilitada');
          return inputEl;
        } catch (error) {
          console.error('‚ùå Erro ao converter SELECT para INPUT:', error);
          return null;
        }
      };
      
      // üö® SOLU√á√ÉO DEFINITIVA: Popular SELECT diretamente com nomes
      window.popularSelectNome = function popularSelectNome(nomes) {
        const nomeSelect = document.getElementById('nome');
        if (!nomeSelect) {
          console.error('‚ùå Campo nome n√£o encontrado');
          return;
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: N√ÉO popular se SELECT j√° foi populado no loadNomes
        if (nomeSelect.tagName === 'SELECT' && nomeSelect.options.length > 1) {
          console.log('‚úÖ SELECT j√° foi populado no loadNomes - n√£o sobrescrevendo');
          return;
        }
        
        console.log('üîÑ popularSelectNome chamado - Elemento:', nomeSelect.tagName, 'Nomes:', nomes?.length || 0);
        
        // üö® CORRE√á√ÉO CR√çTICA: Se n√£o houver nomes, converter SELECT para INPUT automaticamente
        const nomesValidos = nomes && Array.isArray(nomes) && nomes.length > 0;
        
        if (!nomesValidos) {
          console.log('üìù Nenhum nome encontrado - convertendo para INPUT');
          
          // Se j√° √© INPUT, apenas configurar
          if (nomeSelect.tagName === 'INPUT') {
            nomeSelect.placeholder = 'Digite o nome completo...';
            nomeSelect.setAttribute('data-nome-manual', 'true');
            nomeSelect.setAttribute('data-sem-nomes', 'true');
            nomeSelect.value = '';
            return;
          }
          
          // Se √© SELECT, converter para INPUT
          if (nomeSelect.tagName === 'SELECT') {
            const inputEl = window.converterParaInput(nomeSelect);
            if (inputEl) {
              // Adicionar event listener para capturar classe automaticamente
              if (typeof capturarClasseAutomaticamente === 'function') {
                inputEl.addEventListener('input', capturarClasseAutomaticamente);
                inputEl.addEventListener('change', capturarClasseAutomaticamente);
              }
              inputEl.focus();
            }
            return;
          }
        }
        
        // Se for INPUT e h√° nomes, converter para SELECT primeiro
        if (nomeSelect.tagName === 'INPUT') {
          console.log('üîÑ Convertendo INPUT para SELECT (h√° nomes)...');
          const selectEl = document.createElement('select');
          selectEl.id = 'nome';
          selectEl.name = 'nome';
          selectEl.className = 'form-select';
          selectEl.required = true;
          nomeSelect.parentNode.replaceChild(selectEl, nomeSelect);
          const newSelect = document.getElementById('nome');
          if (newSelect) {
            popularSelectNome(nomes);
            return;
          }
        }
        
        if (nomeSelect.tagName !== 'SELECT') {
          console.error('‚ùå Campo nome n√£o √© SELECT:', nomeSelect.tagName);
          return;
        }
        
        // Limpar op√ß√µes existentes (exceto a primeira)
        nomeSelect.innerHTML = '<option value="">Selecione um nome da lista...</option>';
        
        // Converter objetos para strings se necess√°rio
        const nomesStrings = nomes.map(nome => {
          return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
        }).filter(Boolean);
        
        console.log('üìã Populando SELECT com', nomesStrings.length, 'nomes');
        
        // Adicionar op√ß√µes
        nomesStrings.forEach(nome => {
          const option = document.createElement('option');
          option.value = nome;
          option.textContent = nome;
          nomeSelect.appendChild(option);
        });
        
        // Adicionar op√ß√£o para digitar manualmente
        const optionManual = document.createElement('option');
        optionManual.value = '__MANUAL_INPUT__';
        optionManual.textContent = '‚úèÔ∏è Adicionar novo nome manualmente';
        nomeSelect.appendChild(optionManual);
        
        // Event listener para op√ß√£o manual
        nomeSelect.removeEventListener('change', handleNomeSelectChangeManual);
        nomeSelect.addEventListener('change', handleNomeSelectChangeManual);
        
        function handleNomeSelectChangeManual(e) {
          if (e.target.value === '__MANUAL_INPUT__') {
            // Converter SELECT para INPUT quando selecionar op√ß√£o manual
            const selectEl = e.target;
            const inputEl = window.converterParaInput(selectEl);
            if (inputEl) {
              // Adicionar event listener para capturar classe automaticamente
              if (typeof capturarClasseAutomaticamente === 'function') {
                inputEl.addEventListener('input', capturarClasseAutomaticamente);
                inputEl.addEventListener('change', capturarClasseAutomaticamente);
              }
              inputEl.focus();
            }
          }
        }
        
        console.log('‚úÖ SELECT populado com', nomesStrings.length, 'nomes');
      };
      
      // üö® FUN√á√ÉO SIMPLES PARA EXIBIR NOMES
      window.exibirNomes = function exibirNomes(nomes, query) {
        const nomeResults = document.getElementById('nomeResults');
        if (!nomeResults) {
          console.error('‚ùå nomeResults n√£o encontrado!');
          return;
        }
        
        nomeResults.innerHTML = '';
        
        // Converter objetos para strings se necess√°rio
        const nomesStrings = nomes.map(nome => {
          return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
        }).filter(Boolean);
        
        if (nomesStrings.length > 0) {
          // Exibir nomes encontrados
          nomesStrings.forEach(nome => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = nome;
            item.style.cssText = 'padding: 12px; cursor: pointer; border-bottom: 1px solid #e5e7eb;';
            
            item.addEventListener('click', function() {
              const nomeInput = document.getElementById('nome');
              if (nomeInput) {
                nomeInput.value = nome;
                nomeInput.setAttribute('data-selected-from-list', 'true');
                nomeInput.removeAttribute('data-nome-manual');
              }
              nomeResults.innerHTML = '';
              nomeResults.classList.remove('show');
              nomeResults.style.display = 'none';
            });
            
            nomeResults.appendChild(item);
          });
        } else if (query && query.length >= 3) {
          // Exibir op√ß√£o SAM Desatualizado
          const item = document.createElement('div');
          item.className = 'suggestion-item manual-entry';
          item.style.cssText = 'background-color: #fef3c7 !important; border-left: 4px solid #f59e0b !important; cursor: pointer !important; padding: 12px;';
          item.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #f59e0b; font-size: 1.4rem;">‚ö†Ô∏è</span>
              <div style="flex: 1;">
                <strong style="color: #92400e;">SAM Desatualizado</strong>
                <div style="font-size: 0.875rem; color: #78350f; margin-top: 4px;">
                  Nome n√£o encontrado. Clique para incluir manualmente: "${query}"
                </div>
              </div>
            </div>
          `;
          item.addEventListener('click', function() {
            const nomeInput = document.getElementById('nome');
            if (nomeInput) {
              nomeInput.value = query;
              nomeInput.setAttribute('data-nome-manual', 'true');
              nomeInput.setAttribute('data-sam-desatualizado', 'true');
            }
            nomeResults.innerHTML = '';
            nomeResults.classList.remove('show');
            nomeResults.style.display = 'none';
          });
          nomeResults.appendChild(item);
        }
        
        // Sempre exibir dropdown se houver conte√∫do
        if (nomeResults.children.length > 0) {
          // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: Detectar dispositivo
          const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                                 /Mi\s/i.test(navigator.userAgent) ||
                                 /POCO/i.test(navigator.userAgent);
          
          nomeResults.classList.add('show');
          nomeResults.style.display = 'block';
          nomeResults.style.visibility = 'visible';
          nomeResults.style.opacity = '1';
          nomeResults.style.zIndex = '1000';
          // üö® CORRE√á√ÉO CR√çTICA: Padronizar posicionamento para TODAS as plataformas (iOS, Android, Xiaomi, Redmi)
          // Sempre usar position: absolute com top, nunca position: fixed com bottom
          nomeResults.style.position = 'absolute';
          nomeResults.style.top = 'calc(100% + 4px)';
          nomeResults.style.bottom = 'auto'; // Garantir que bottom n√£o seja usado
          nomeResults.style.left = '0';
          nomeResults.style.right = '0';
          nomeResults.style.maxHeight = isMobileDevice() ? '50vh' : '300px';
          nomeResults.style.overflowY = 'auto';
          nomeResults.style.backgroundColor = '#ffffff';
          nomeResults.style.border = '1px solid #e5e7eb';
          nomeResults.style.borderRadius = '0.375rem';
          nomeResults.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
          nomeResults.style.width = '100%';
          nomeResults.style.marginTop = '4px';
          
          // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: For√ßar posicionamento ap√≥s renderiza√ß√£o
          if (isXiaomiDevice) {
            setTimeout(() => {
              nomeResults.style.position = 'absolute';
              nomeResults.style.top = 'calc(100% + 4px)';
              nomeResults.style.bottom = 'auto';
              nomeResults.style.display = 'block';
              nomeResults.style.visibility = 'visible';
              nomeResults.style.opacity = '1';
              console.log('üì± XIAOMI/REDMI: Posicionamento for√ßado para dropdown abaixo do campo');
            }, 50);
          }
        } else {
          nomeResults.style.display = 'none';
          nomeResults.classList.remove('show');
        }
      };
      
      // üö® CORRE√á√ÉO CR√çTICA: Fun√ß√£o para buscar nomes baseado no contexto (comum + cargo + instrumento)
      // üö® CORRE√á√ÉO CR√çTICA: Tornar fun√ß√£o global para ser acess√≠vel de qualquer lugar
      // Agora busca nomes reais de window.nomesData ou carrega do banco
      window.searchNomesComContexto = function searchNomesComContexto(query) {
        console.log('üîç searchNomesComContexto chamada com query:', query);
        const comum = document.getElementById('comumInput')?.value?.trim();
        const cargo = document.getElementById('cargo')?.value?.trim();
        const instrumento = document.getElementById('instrumento')?.value?.trim();
        
        console.log('üîç Buscando nomes com contexto:', { comum, cargo, instrumento, query });
        
        // Verificar se comum e cargo est√£o preenchidos
        if (!comum || !cargo) {
          console.warn('‚ö†Ô∏è Comum ou cargo n√£o preenchidos - n√£o √© poss√≠vel buscar nomes');
          const nomeResults = document.getElementById('nomeResults');
          if (nomeResults) {
            nomeResults.innerHTML = '';
            nomeResults.classList.remove('show');
            nomeResults.style.display = 'none';
          }
          return;
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: Se n√£o h√° nomes carregados, FOR√áAR carregamento ANTES de filtrar
        if (!window.nomesData || !Array.isArray(window.nomesData) || window.nomesData.length === 0) {
          console.log('üö® FOR√áANDO CARREGAMENTO DE NOMES - window.nomesData vazio ou n√£o existe');
          
          // üö® CORRE√á√ÉO CR√çTICA XIAOMI: Criar fun√ß√£o forceCarregarNomes se n√£o existir
          if (typeof window.forceCarregarNomes !== 'function') {
            window.forceCarregarNomes = function forceCarregarNomes(query, comum, cargo, instrumento) {
              console.log('üö® forceCarregarNomes chamada:', { query, comum, cargo, instrumento });
              
              // Verificar se loadNomes existe
              if (typeof loadNomes === 'function') {
                loadNomes().then(() => {
                  console.log('‚úÖ forceCarregarNomes: Nomes carregados, buscando novamente...');
                  // Ap√≥s carregar, tentar buscar novamente
                  if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                    // Chamar searchNomesComContexto novamente com a query
                    if (typeof window.searchNomesComContexto === 'function') {
                      window.searchNomesComContexto(query);
                    }
                  } else {
                    console.warn('‚ö†Ô∏è forceCarregarNomes: Nenhum nome carregado ap√≥s loadNomes');
                  }
                }).catch((error) => {
                  console.error('‚ùå forceCarregarNomes: Erro ao carregar nomes:', error);
                });
              } else {
                console.error('‚ùå forceCarregarNomes: loadNomes n√£o est√° dispon√≠vel!');
              }
            };
          }
          
          window.forceCarregarNomes(query, comum, cargo, instrumento);
          return;
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: Fun√ß√£o auxiliar para filtrar e mostrar nomes
        function filtrarEMostrarNomes(allNames, query) {
          const nomeResults = document.getElementById('nomeResults');
          if (!nomeResults) {
            console.error('‚ùå nomeResults n√£o encontrado em filtrarEMostrarNomes!');
            return;
          }
          
          // üö® CORRE√á√ÉO CR√çTICA: Garantir que allNames seja array de strings
          // Se for array de objetos, extrair os nomes
          let nomesStrings = [];
          if (allNames && Array.isArray(allNames) && allNames.length > 0) {
            // Verificar se o primeiro item √© objeto ou string
            if (typeof allNames[0] === 'object' && allNames[0].nome) {
              // √â array de objetos - extrair nomes
              console.log('üîß Extraindo nomes de objetos:', allNames.length);
              nomesStrings = allNames.map(item => {
                if (typeof item === 'object' && item.nome) {
                  return item.nome;
                }
                return item;
              }).filter(Boolean);
            } else {
              // J√° √© array de strings
              nomesStrings = allNames;
            }
          }
          
          console.log('üìã Nomes dispon√≠veis para filtrar:', nomesStrings.length);
          
          let suggestions = [];
          if (!query || query.length === 0) {
            // Se query vazia, mostrar todos os nomes (at√© 50 para n√£o sobrecarregar)
            suggestions = nomesStrings.slice(0, 50);
            console.log('üìã Mostrando primeiros', suggestions.length, 'nomes (query vazia)');
          } else if (query.length >= 3) {
            // Filtrar nomes que correspondem √† busca (apenas se tiver 3+ caracteres)
            suggestions = nomesStrings.filter(nome => 
              typeof nome === 'string' && nome.toLowerCase().includes(query.toLowerCase())
            );
            console.log('üîç Encontrados', suggestions.length, 'nomes para:', query);
          }
          
          if (suggestions.length > 0) {
            showSuggestionsWithManualOption(suggestions, query, comum, cargo, instrumento);
          } else if (query && query.length >= 3) {
            // Se n√£o encontrou ap√≥s digitar 3+ caracteres, mostrar op√ß√£o manual
            console.log('üîç Nome n√£o encontrado na lista - mostrando op√ß√£o manual');
            showSuggestionsWithManualOption([], query, comum, cargo, instrumento);
          } else {
            // Se query menor que 3 caracteres, n√£o mostrar nada
            const nomeResults = document.getElementById('nomeResults');
            if (nomeResults) {
              nomeResults.innerHTML = '';
              nomeResults.classList.remove('show');
            }
          }
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: Buscar nomes reais de window.nomesData (carregados do banco)
        // Se chegou aqui, window.nomesData j√° existe e tem dados
        const allNames = window.nomesData;
        console.log('‚úÖ Usando nomes de window.nomesData:', allNames.length, 'nomes');
        // Filtrar e mostrar nomes imediatamente
        filtrarEMostrarNomes(allNames, query);
      };
      
      // Garantir que a fun√ß√£o est√° dispon√≠vel globalmente
      if (typeof window.searchNomesComContexto === 'undefined') {
        window.searchNomesComContexto = searchNomesComContexto;
      }
      
      // üö® CORRE√á√ÉO CR√çTICA XIAOMI: Criar fun√ß√£o buscarNomesDireto que estava faltando
      // Esta fun√ß√£o √© chamada quando o usu√°rio digita no campo nome
      window.buscarNomesDireto = function buscarNomesDireto(query) {
        // üõ°Ô∏è LOG ESPEC√çFICO XIAOMI: Log detalhado para debug em dispositivos Xiaomi
        const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                               /Mi\s/i.test(navigator.userAgent) ||
                               /POCO/i.test(navigator.userAgent);
        
        if (isXiaomiDevice) {
          console.log('üì± XIAOMI - buscarNomesDireto chamada com query:', query);
        } else {
          console.log('üîç buscarNomesDireto chamada com query:', query);
        }
        
        // Se n√£o h√° query ou query menor que 3 caracteres, n√£o fazer nada
        if (!query || query.length < 3) {
          const nomeResults = document.getElementById('nomeResults');
          if (nomeResults) {
            nomeResults.innerHTML = '';
            nomeResults.classList.remove('show');
            nomeResults.style.display = 'none';
          }
          if (isXiaomiDevice) {
            console.log('üì± XIAOMI - Query muito curta, escondendo dropdown');
          }
          return;
        }
        
        // Verificar se window.nomesData existe e tem dados
        if (!window.nomesData || !Array.isArray(window.nomesData) || window.nomesData.length === 0) {
          if (isXiaomiDevice) {
            console.log('üö® XIAOMI - buscarNomesDireto: window.nomesData vazio - tentando carregar nomes...');
          } else {
            console.log('üö® buscarNomesDireto: window.nomesData vazio - tentando carregar nomes...');
          }
          
          // Tentar carregar nomes primeiro
          const comum = document.getElementById('comumInput')?.value?.trim();
          const cargo = document.getElementById('cargo')?.value?.trim();
          const instrumento = document.getElementById('instrumento')?.value?.trim();
          
          if (comum && cargo) {
            // Se h√° contexto, tentar carregar nomes
            if (typeof loadNomes === 'function') {
              loadNomes().then(() => {
                // Ap√≥s carregar, tentar buscar novamente
                if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                  console.log('‚úÖ buscarNomesDireto: Nomes carregados, buscando novamente...');
                  window.buscarNomesDireto(query);
                } else {
                  console.warn('‚ö†Ô∏è buscarNomesDireto: Nenhum nome carregado ap√≥s loadNomes');
                  // Mostrar op√ß√£o manual
                  if (typeof window.searchNomesComContexto === 'function') {
                    window.searchNomesComContexto(query);
                  }
                }
              }).catch((error) => {
                console.error('‚ùå buscarNomesDireto: Erro ao carregar nomes:', error);
                // Tentar usar searchNomesComContexto mesmo assim
                if (typeof window.searchNomesComContexto === 'function') {
                  window.searchNomesComContexto(query);
                }
              });
            } else {
              // Se loadNomes n√£o existe, usar searchNomesComContexto
              if (typeof window.searchNomesComContexto === 'function') {
                window.searchNomesComContexto(query);
              }
            }
          } else {
            // Se n√£o h√° contexto, usar searchNomesComContexto que vai verificar
            if (typeof window.searchNomesComContexto === 'function') {
              window.searchNomesComContexto(query);
            }
          }
          return;
        }
        
        // Se h√° nomes carregados, filtrar e exibir diretamente
        if (isXiaomiDevice) {
          console.log('üì± XIAOMI - buscarNomesDireto: Filtrando', window.nomesData.length, 'nomes com query:', query);
        } else {
          console.log('‚úÖ buscarNomesDireto: Filtrando', window.nomesData.length, 'nomes com query:', query);
        }
        
        // Extrair nomes se forem objetos
        let nomesStrings = [];
        if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
          if (typeof window.nomesData[0] === 'object' && window.nomesData[0].nome) {
            // √â array de objetos - extrair nomes
            if (isXiaomiDevice) {
              console.log('üì± XIAOMI - Extraindo nomes de objetos:', window.nomesData.length);
            }
            nomesStrings = window.nomesData.map(item => {
              if (typeof item === 'object' && item.nome) {
                return item.nome;
              }
              return item;
            }).filter(Boolean);
          } else {
            // J√° √© array de strings
            nomesStrings = window.nomesData;
          }
        }
        
        // üõ°Ô∏è VALIDA√á√ÉO XIAOMI: Garantir que nomesStrings n√£o est√° vazio
        if (nomesStrings.length === 0 && isXiaomiDevice) {
          console.warn('‚ö†Ô∏è XIAOMI - ATEN√á√ÉO: nomesStrings est√° vazio ap√≥s extra√ß√£o!');
          console.warn('‚ö†Ô∏è XIAOMI - window.nomesData:', window.nomesData);
        }
        
        // Filtrar nomes que correspondem √† query
        const queryLower = query.toLowerCase().trim();
        const suggestions = nomesStrings.filter(nome => {
          if (typeof nome !== 'string') return false;
          return nome.toLowerCase().includes(queryLower);
        });
        
        if (isXiaomiDevice) {
          console.log('üì± XIAOMI - buscarNomesDireto: Encontrados', suggestions.length, 'nomes para:', query);
          if (suggestions.length > 0) {
            console.log('üì± XIAOMI - Primeiros nomes encontrados:', suggestions.slice(0, 5));
          } else {
            console.warn('‚ö†Ô∏è XIAOMI - Nenhum nome encontrado para a query:', query);
            console.warn('‚ö†Ô∏è XIAOMI - Total de nomes dispon√≠veis:', nomesStrings.length);
            if (nomesStrings.length > 0) {
              console.warn('‚ö†Ô∏è XIAOMI - Primeiros nomes dispon√≠veis:', nomesStrings.slice(0, 10));
            }
          }
        } else {
          console.log('üîç buscarNomesDireto: Encontrados', suggestions.length, 'nomes para:', query);
        }
        
        // Obter contexto para passar para showSuggestionsWithManualOption
        const comum = document.getElementById('comumInput')?.value?.trim() || '';
        const cargo = document.getElementById('cargo')?.value?.trim() || '';
        const instrumento = document.getElementById('instrumento')?.value?.trim() || '';
        
        // Exibir sugest√µes usando a fun√ß√£o existente
        if (typeof window.showSuggestionsWithManualOption === 'function') {
          window.showSuggestionsWithManualOption(suggestions, query, comum, cargo, instrumento);
        } else {
          // Fallback: usar exibirNomes se showSuggestionsWithManualOption n√£o existir
          if (typeof window.exibirNomes === 'function') {
            window.exibirNomes(suggestions, query);
          } else {
            console.error('‚ùå buscarNomesDireto: Nenhuma fun√ß√£o de exibi√ß√£o dispon√≠vel!');
          }
        }
      };
      
      // REMOVIDO: Fun√ß√£o abrirListaNomes - √≠cone de seta foi removido
      // O campo nome agora funciona apenas com busca autom√°tica ap√≥s 3 caracteres
      
      // üö® CORRE√á√ÉO CR√çTICA: Tornar fun√ß√£o global para ser acess√≠vel de qualquer lugar
      // Fun√ß√£o para mostrar sugest√µes com op√ß√£o manual
      window.showSuggestionsWithManualOption = function showSuggestionsWithManualOption(suggestions, query, comum, cargo, instrumento) {
        console.log('üìã Mostrando sugest√µes:', suggestions.length, 'nomes');
        
        // üö® CORRE√á√ÉO CR√çTICA: Buscar nomeResults novamente para garantir que est√° no escopo correto
        let nomeResults = document.getElementById('nomeResults');
        
        // Garantir que h√° apenas um elemento nomeResults
        const allNomeResults = document.querySelectorAll('#nomeResults');
        if (allNomeResults.length > 1) {
          console.warn('‚ö†Ô∏è M√∫ltiplos elementos nomeResults encontrados, removendo duplicados');
          for (let i = 1; i < allNomeResults.length; i++) {
            allNomeResults[i].remove();
          }
        }
        
        // Se n√£o encontrou, tentar buscar novamente
        if (!nomeResults) {
          nomeResults = document.getElementById('nomeResults');
        }
        
        if (!nomeResults) {
          console.error('‚ùå nomeResults n√£o encontrado! Tentando criar...');
          // Tentar criar o elemento se n√£o existir
          const nomeInput = document.getElementById('nome');
          if (nomeInput && nomeInput.parentElement) {
            const nomeResultsDiv = document.createElement('div');
            nomeResultsDiv.id = 'nomeResults';
            nomeResultsDiv.className = 'suggestions-dropdown';
            nomeInput.parentElement.appendChild(nomeResultsDiv);
            nomeResults = nomeResultsDiv;
            console.log('‚úÖ nomeResults criado');
          } else {
            console.error('‚ùå N√£o foi poss√≠vel criar nomeResults - nomeInput n√£o encontrado');
            return;
          }
        }
        
        // Limpar completamente antes de adicionar novos itens
        nomeResults.innerHTML = '';
        // N√ÉO remover classe 'show' e display aqui - ser√° definido depois
        
        // üö® CORRE√á√ÉO: Garantir que h√° sugest√µes ou mostrar mensagem
        if (suggestions.length === 0 && (!query || query.length === 0)) {
          console.log('‚ö†Ô∏è Nenhum nome dispon√≠vel - tentando carregar do banco...');
          // Tentar carregar nomes do banco se ainda n√£o foram carregados
          if (typeof loadNomes === 'function') {
            loadNomes().then(() => {
              if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                console.log('‚úÖ Nomes carregados do banco:', window.nomesData.length);
                // Recarregar dropdown com os nomes carregados
                searchNomesComContexto('');
              } else {
                console.log('‚ö†Ô∏è Nenhum nome encontrado no banco');
                nomeResults.innerHTML = '<div class="suggestion-item" style="padding: 12px; text-align: center; color: #6b7280;">Nenhum nome dispon√≠vel</div>';
                nomeResults.classList.add('show');
              }
            }).catch(() => {
              nomeResults.innerHTML = '<div class="suggestion-item" style="padding: 12px; text-align: center; color: #6b7280;">Erro ao carregar nomes</div>';
              nomeResults.classList.add('show');
            });
            return;
          }
        }
        
        // Mostrar sugest√µes encontradas
        suggestions.forEach(nome => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = nome;
          
          // CORRE√á√ÉO: Mobile igual ao desktop - sem estilos espec√≠ficos
          
          item.addEventListener('click', function(e) {
            // Prevenir propaga√ß√£o do evento
            e.stopPropagation();
            e.preventDefault();
            
            // Suprimir marca√ß√£o manual durante sele√ß√£o program√°tica
            window.suppressManualNome = true;
            
            // Fechar dropdown primeiro (antes de atribuir valor)
            hideSuggestions();
            
            // Atribuir valor ao campo
            nomeInput.value = nome;
            selectedFromList = true;
            isManualEntry = false;
            
            // CORRE√á√ÉO CR√çTICA: Marcar campo como selecionado da lista
            nomeInput.setAttribute('data-selected-from-list', 'true');
            nomeInput.removeAttribute('data-nome-manual');
            
            // Restaurar estilo normal
            nomeInput.style.backgroundColor = '';
            nomeInput.style.borderColor = '';
            
            // CORRE√á√ÉO: Esconder bot√£o manual quando nome √© selecionado da lista
            const btnManual = document.getElementById('btnManualNome');
            if (btnManual) {
              btnManual.style.display = 'none';
            }
            
            // MOBILE: Fechar teclado virtual ap√≥s selecionar da lista
            if (isMobileDevice()) {
              // Fechar teclado mas manter campo edit√°vel para permitir digita√ß√£o se necess√°rio
              nomeInput.blur();
              fecharTecladoVirtualMobile();
              
              // Scroll para garantir que o bot√£o enviar seja vis√≠vel
                setTimeout(() => {
                const btnSubmit = document.getElementById('btnSubmit');
                if (btnSubmit) {
                  btnSubmit.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
              }, 200);
            }
            // Reativar marca√ß√£o manual ap√≥s o ciclo de eventos
            setTimeout(() => { window.suppressManualNome = false; }, 0);
            
            console.log('‚úÖ Nome selecionado da lista:', {
              nome: nome,
              selectedFromList: selectedFromList,
              isManualEntry: isManualEntry
            });
            
            // CORRE√á√ÉO: N√£o mostrar modal que trava a tela no mobile
            if (!isMobileDevice()) {
            showStatusModal('NOME SELECIONADO', `NOME "${nome}" SELECIONADO DA LISTA`, 'success');
            }
          });
          nomeResults.appendChild(item);
        });
        
        // CORRE√á√ÉO CR√çTICA: Mobile - usar bot√£o discreto em vez de banner amarelo
        const btnManual = document.getElementById('btnManualNome');
        
        if (suggestions.length === 0 && query && query.length >= 3) {
          // Quando n√£o encontrar nome ap√≥s digitar 3+ caracteres, mostrar op√ß√£o manual com "SAM Desatualizado"
          const enableTypingItem = document.createElement('div');
          enableTypingItem.className = 'suggestion-item manual-entry';
          enableTypingItem.style.cssText = 'background-color: #fef3c7 !important; border-left: 4px solid #f59e0b !important; cursor: pointer !important;';
          enableTypingItem.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; padding: 12px;">
              <span style="color: #f59e0b; font-size: 1.4rem;">‚ö†Ô∏è</span>
              <div style="flex: 1;">
                <strong style="color: #92400e;">SAM Desatualizado</strong>
                <div style="font-size: 0.875rem; color: #78350f; margin-top: 4px;">
                  Nome n√£o encontrado. Clique para incluir manualmente: "${query}"
                </div>
              </div>
            </div>
          `;
          enableTypingItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Atribuir o nome digitado ao campo
            const nomeInput = document.getElementById('nome');
            if (nomeInput) {
              nomeInput.value = query;
              nomeInput.setAttribute('data-nome-manual', 'true');
              nomeInput.setAttribute('data-sam-desatualizado', 'true'); // Marcar para adicionar "SAM Desatualizado" na anota√ß√£o
              nomeInput.removeAttribute('data-selected-from-list');
              // N√ÉO aplicar estilo amarelo - apenas marcar para anota√ß√£o
              nomeInput.style.backgroundColor = '';
              nomeInput.style.borderColor = '';
            }
            hideSuggestions();
            console.log('‚úÖ Nome inclu√≠do manualmente (ser√° marcado como SAM Desatualizado na anota√ß√£o):', query);
          });
          nomeResults.appendChild(enableTypingItem);
        } else if (suggestions.length === 0 && (!query || query.length < 3)) {
          // Se n√£o h√° query ou query menor que 3 caracteres, n√£o mostrar nada
          nomeResults.innerHTML = '';
          nomeResults.classList.remove('show');
          return;
        } else {
          // CORRE√á√ÉO: Quando h√° nomes encontrados, mostrar op√ß√£o para converter para input manual
          if (isMobileDevice() && btnManual) {
            btnManual.style.display = 'flex';
            btnManual.onclick = function() {
              habilitarDigitacaoManual();
            };
          } else if (!isMobileDevice()) {
            // Desktop: mostrar op√ß√£o manual no dropdown
            const enableTypingItem = document.createElement('div');
            enableTypingItem.className = 'suggestion-item manual-entry';
          enableTypingItem.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; padding: 12px;">
              <span style="color: #3b82f6; font-size: 1.4rem;">‚úèÔ∏è</span>
              <div style="flex: 1;">
                  <strong>Adicionar novo nome manualmente</strong>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">
                  CLIQUE AQUI PARA DIGITAR QUALQUER NOME LIVREMENTE
                </div>
              </div>
            </div>
          `;
        enableTypingItem.addEventListener('click', function() {
          habilitarDigitacaoManual();
        });
        nomeResults.appendChild(enableTypingItem);
          }
        }
        
        // üö® CORRE√á√ÉO CR√çTICA: SEMPRE garantir que o dropdown seja exibido quando h√° conte√∫do (TODAS as plataformas)
        if (suggestions.length > 0 || nomeResults.children.length > 0) {
          // For√ßar exibi√ß√£o do dropdown com todos os estilos necess√°rios
          nomeResults.classList.add('show');
          nomeResults.style.display = 'block';
          nomeResults.style.visibility = 'visible';
          nomeResults.style.opacity = '1';
          nomeResults.style.zIndex = '1000';
          // üö® CORRE√á√ÉO CR√çTICA: Padronizar posicionamento para TODAS as plataformas (iOS, Android, Xiaomi, Redmi)
          // Sempre usar position: absolute com top, nunca position: fixed com bottom
          nomeResults.style.position = 'absolute';
          nomeResults.style.top = 'calc(100% + 4px)';
          nomeResults.style.bottom = 'auto'; // Garantir que bottom n√£o seja usado
          nomeResults.style.left = '0';
          nomeResults.style.right = '0';
          nomeResults.style.maxHeight = isMobileDevice() ? '50vh' : '300px';
          nomeResults.style.overflowY = 'auto';
          nomeResults.style.backgroundColor = '#ffffff';
          nomeResults.style.border = '1px solid #e5e7eb';
          nomeResults.style.borderRadius = '0.375rem';
          nomeResults.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
          nomeResults.style.width = '100%';
          nomeResults.style.marginTop = '4px';
          
          // For√ßar reflow para garantir que o navegador renderize (TODAS as plataformas)
          void nomeResults.offsetHeight;
          
          // üö® CORRE√á√ÉO CR√çTICA: Garantir que o dropdown seja vis√≠vel mesmo ap√≥s renderiza√ß√£o (TODAS as plataformas)
          requestAnimationFrame(() => {
            // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: For√ßar posicionamento correto
            const isXiaomiDevice = /Xiaomi|MIUI|Redmi/i.test(navigator.userAgent) || 
                                   /Mi\s/i.test(navigator.userAgent) ||
                                   /POCO/i.test(navigator.userAgent);
            
            // Garantir que position e top sejam mantidos (n√£o permitir que sejam sobrescritos)
            nomeResults.style.position = 'absolute';
            nomeResults.style.top = 'calc(100% + 4px)';
            nomeResults.style.bottom = 'auto';
            nomeResults.style.display = 'block';
            nomeResults.style.visibility = 'visible';
            nomeResults.style.opacity = '1';
            
            // üö® CORRE√á√ÉO ESPEC√çFICA XIAOMI/REDMI: For√ßar novamente ap√≥s um pequeno delay
            if (isXiaomiDevice) {
              setTimeout(() => {
                nomeResults.style.position = 'absolute';
                nomeResults.style.top = 'calc(100% + 4px)';
                nomeResults.style.bottom = 'auto';
                nomeResults.style.display = 'block';
                nomeResults.style.visibility = 'visible';
                nomeResults.style.opacity = '1';
                console.log('üì± XIAOMI/REDMI: Posicionamento for√ßado para dropdown abaixo do campo');
              }, 100);
            }
          });
        } else {
          // Se n√£o h√° conte√∫do, esconder o dropdown
          nomeResults.style.display = 'none';
          nomeResults.classList.remove('show');
        }
        
        console.log('‚úÖ Dropdown exibido com', suggestions.length, 'sugest√µes, total de itens:', nomeResults.children.length);
        console.log('‚úÖ Dropdown display:', nomeResults.style.display);
        console.log('‚úÖ Dropdown visibility:', nomeResults.style.visibility);
        console.log('‚úÖ Dropdown opacity:', nomeResults.style.opacity);
        
        // MOBILE: NUNCA tornar readonly - sempre permitir teclado se necess√°rio
        // O usu√°rio pode escolher: selecionar da lista ou digitar manualmente
        if (isMobileDevice()) {
          nomeInput.readOnly = false;
          nomeInput.removeAttribute('readonly');
          console.log('üì± MOBILE: Campo sempre edit√°vel - usu√°rio pode selecionar da lista ou digitar');
        }
      }
      
      
      // Fun√ß√£o para habilitar digita√ß√£o manual automaticamente (quando n√£o encontra nomes)
      function habilitarDigitacaoManualAutomatica(query) {
        console.log('üîß Nome n√£o encontrado - habilitando digita√ß√£o manual automaticamente');
        
        // For√ßar convers√£o para INPUT se for SELECT
        if (nomeInput.tagName === 'SELECT') {
          const parent = nomeInput.parentNode;
          const newInput = document.createElement('input');
          newInput.type = 'text';
          newInput.id = 'nome';
          newInput.name = 'nome';
          newInput.className = 'form-control';
          newInput.placeholder = 'Digite o nome completo...';
          newInput.autocomplete = 'off';
          newInput.required = true;
          newInput.value = query || '';
          parent.replaceChild(newInput, nomeInput);
          
          // Atualizar refer√™ncia
          const updatedInput = document.getElementById('nome');
          updatedInput.focus();
        }
        
        // Habilitar o campo
        nomeInput.disabled = false;
        nomeInput.readOnly = false;
        nomeInput.style.pointerEvents = 'auto';
        nomeInput.style.opacity = '1';
        // REMOVIDO: Estilo amarelo - n√£o aplicar mais, apenas marcar para anota√ß√£o
        nomeInput.style.backgroundColor = '';
        nomeInput.style.borderColor = '';
        
        // Marcar como modo de digita√ß√£o manual
        isManualEntry = true;
        selectedFromList = false;
        
        // üéØ CORRE√á√ÉO: Marcar campo com atributo para facilitar detec√ß√£o
        nomeInput.setAttribute('data-nome-manual', 'true');
        
        // Esconder sugest√µes
        hideSuggestions();
        
        // Mostrar bot√£o para voltar √† lista
        mostrarBotaoVoltarLista();
        
        // Focar no campo
        nomeInput.focus();
        
        // Verificar se √© cargo musical para mostrar mensagem espec√≠fica
        const cargoEl = document.getElementById('cargo');
        const cargo = cargoEl ? cargoEl.value : '';
        
        // Fun√ß√£o para verificar se √© cargo musical
        function isCargoMusical(cargo) {
          if (!cargo) return false;
          const up = cargo.toUpperCase();
          const low = cargo.toLowerCase();
          const isSecretariadoMusica = (
            (low.includes('secret√°ria') || low.includes('secretario') || low.includes('secret√°rio')) &&
            (low.includes('m√∫sica') || low.includes('musica'))
          );
          return up.includes('ORGANISTA') ||
                 up.includes('EXAMINADORA') ||
                 up.includes('INSTRUTORA') ||
                 isSecretariadoMusica;
        }
        
        // CORRE√á√ÉO CR√çTICA: N√£o mostrar alertas no mobile
        if (!isMobileDevice()) {
        if (isCargoMusical(cargo)) {
            // Cargo musical - mostra mensagem sobre SAM DESATUALIZADO (apenas desktop)
          showStatusModal(
            'DIGITA√á√ÉO MANUAL ATIVADA', 
            'NOME N√ÉO ENCONTRADO NA LISTA. DIGITE O NOME COMPLETO - SER√Å MARCADO COMO "SAM DESATUALIZADO"', 
            'warning'
          );
        } else {
          // Cargo n√£o-musical - permite digita√ß√£o normal sem modal
          console.log('‚úÖ Digita√ß√£o manual habilitada para cargo n√£o-musical - sem modal');
          }
        } else {
          // Mobile: Apenas log, sem alertas que travam a tela
          console.log('üì± Mobile: Digita√ß√£o manual autom√°tica habilitada - sem alertas');
        }
      }

      // Fun√ß√£o para habilitar digita√ß√£o manual (manual)
      function habilitarDigitacaoManual() {
        // For√ßar convers√£o para INPUT se for SELECT
        if (nomeInput.tagName === 'SELECT') {
          const parent = nomeInput.parentNode;
          const newInput = document.createElement('input');
          newInput.type = 'text';
          newInput.id = 'nome';
          newInput.name = 'nome';
          newInput.className = 'form-control';
          newInput.placeholder = 'Digite o nome completo...';
          newInput.autocomplete = 'off';
          newInput.required = true;
          newInput.value = nomeInput.value || '';
          parent.replaceChild(newInput, nomeInput);
          
          // Atualizar refer√™ncia
          const updatedInput = document.getElementById('nome');
          updatedInput.focus();
        }
        
        // Habilitar o campo
        nomeInput.disabled = false;
        nomeInput.readOnly = false;
        nomeInput.style.pointerEvents = 'auto';
        nomeInput.style.opacity = '1';
        nomeInput.style.backgroundColor = '#f0f9ff';
        nomeInput.style.borderColor = '#3b82f6';
        
        // Marca√ß√£o manual expl√≠cita
        isManualEntry = true;
        selectedFromList = false;
        nomeInput.setAttribute('data-nome-manual', 'true');
        nomeInput.removeAttribute('data-selected-from-list');
        
        // Esconder sugest√µes
        hideSuggestions();
        
        // Mostrar bot√£o para voltar √† lista
        mostrarBotaoVoltarLista();
        
        // Focar no campo
        nomeInput.focus();
        
        // Verificar se √© cargo musical para mostrar mensagem espec√≠fica
        const cargoEl = document.getElementById('cargo');
        const cargo = cargoEl ? cargoEl.value : '';
        
        // Fun√ß√£o para verificar se √© cargo musical
        function isCargoMusical(cargo) {
          if (!cargo) return false;
          const up = cargo.toUpperCase();
          const low = cargo.toLowerCase();
          const isSecretariadoMusica = (
            (low.includes('secret√°ria') || low.includes('secretario') || low.includes('secret√°rio')) &&
            (low.includes('m√∫sica') || low.includes('musica'))
          );
          return up.includes('ORGANISTA') ||
                 up.includes('EXAMINADORA') ||
                 up.includes('INSTRUTORA') ||
                 isSecretariadoMusica;
        }
        
        // CORRE√á√ÉO CR√çTICA: N√£o mostrar alertas no mobile
        if (!isMobileDevice()) {
        if (isCargoMusical(cargo)) {
            // Cargo musical - mostra mensagem sobre SAM DESATUALIZADO (apenas desktop)
          showStatusModal(
            'MODO DIGITA√á√ÉO MANUAL', 
            'AGORA VOC√ä PODE DIGITAR QUALQUER NOME. SER√Å MARCADO COMO "SAM DESATUALIZADO". USE O BOT√ÉO ABAIXO PARA VOLTAR √Ä LISTA.', 
            'info'
          );
        } else {
          // Cargo n√£o-musical - permite digita√ß√£o normal sem modal
          console.log('‚úÖ Modo digita√ß√£o manual habilitado para cargo n√£o-musical - sem modal');
          }
        } else {
          // Mobile: Apenas log, sem alertas que travam a tela
          console.log('üì± Mobile: Modo digita√ß√£o manual habilitado - sem alertas');
        }
      }
      
      // Fun√ß√£o para mostrar bot√£o de voltar √† lista
      function mostrarBotaoVoltarLista() {
        // Remover bot√£o existente se houver
        const botaoExistente = document.getElementById('btnVoltarLista');
        if (botaoExistente) {
          botaoExistente.remove();
        }
        
        // Criar bot√£o para voltar √† lista
        const botaoVoltar = document.createElement('button');
        botaoVoltar.id = 'btnVoltarLista';
        botaoVoltar.type = 'button';
        botaoVoltar.className = 'btn btn-outline-primary btn-sm';
        botaoVoltar.style.cssText = `
          margin-top: 8px;
          width: 100%;
          font-size: 0.8rem;
          padding: 6px 12px;
          border-radius: 6px;
          border: 1px solid #3b82f6;
          background: transparent;
          color: #3b82f6;
          cursor: pointer;
          transition: all 0.2s ease;
        `;
        botaoVoltar.innerHTML = 'üìã VOLTAR √Ä LISTA DE NOMES';
        
        // Adicionar hover effect
        botaoVoltar.addEventListener('mouseenter', function() {
          this.style.backgroundColor = '#3b82f6';
          this.style.color = 'white';
        });
        
        botaoVoltar.addEventListener('mouseleave', function() {
          this.style.backgroundColor = 'transparent';
          this.style.color = '#3b82f6';
        });
        
        // Event listener para voltar √† lista
        botaoVoltar.addEventListener('click', function() {
          voltarParaLista();
        });
        
        // Inserir o bot√£o ap√≥s o campo de nome
        const nomeContainer = nomeInput.closest('.form-group');
        if (nomeContainer) {
          nomeContainer.appendChild(botaoVoltar);
        }
      }
      
      // Fun√ß√£o para voltar √† lista de nomes
      function voltarParaLista() {
        // Remover bot√£o
        const botaoVoltar = document.getElementById('btnVoltarLista');
        if (botaoVoltar) {
          botaoVoltar.remove();
        }
        
        // Resetar estado
        isManualEntry = false;
        selectedFromList = false;
        
        // Restaurar estilo normal
        nomeInput.style.backgroundColor = '';
        nomeInput.style.borderColor = '';
        
        // Limpar campo
        nomeInput.value = '';
        
        // Mostrar sugest√µes novamente
        if (nomeInput.value.length >= 3) {
          searchNomesComContexto(nomeInput.value);
        }
        
        showStatusModal(
          'Modo Lista', 
          'Voltou para o modo de sele√ß√£o da lista', 
          'success'
        );
      }
      
      // Fun√ß√£o para confirmar entrada manual
      function confirmarEntradaManual(query, comum, cargo, instrumento) {
        const confirmacao = confirm(
          `Confirmar adi√ß√£o manual do m√∫sico?\n\n` +
          `Nome: ${query}\n` +
          `Comum: ${comum || 'Comum n√£o localizada'}\n` +
          `Cargo: ${cargo || 'N√£o selecionado'}\n` +
          `Instrumento: ${instrumento || 'N√£o selecionado'}\n\n` +
          `Este registro ser√° marcado como "SAM Desatualizado" na coluna de anota√ß√µes.`
        );
        
        if (confirmacao) {
          nomeInput.value = query;
          nomeInput.setAttribute('data-nome-manual', 'true');
          nomeInput.setAttribute('data-sam-desatualizado', 'true'); // Marcar para adicionar "SAM Desatualizado" na anota√ß√£o
          isManualEntry = true;
          selectedFromList = false;
          hideSuggestions();
          
          // REMOVIDO: Estilo amarelo - n√£o aplicar mais, apenas marcar para anota√ß√£o
          nomeInput.style.borderColor = '';
          nomeInput.style.backgroundColor = '';
          
          showStatusModal(
            'Entrada Manual Confirmada', 
            `Nome "${query}" ser√° adicionado com anota√ß√£o "SAM Desatualizado"`, 
            'warning'
          );
        }
      }
      
      // üö® CORRE√á√ÉO CR√çTICA: Fun√ß√£o para esconder sugest√µes
      function hideSuggestions() {
        const nomeResults = document.getElementById('nomeResults');
        if (!nomeResults) {
          console.warn('‚ö†Ô∏è nomeResults n√£o encontrado ao tentar esconder');
          return;
        }
        
        nomeResults.classList.remove('show');
        nomeResults.style.display = 'none';
        nomeResults.style.visibility = 'hidden';
        nomeResults.style.opacity = '0';
        
        // CORRE√á√ÉO: Esconder bot√£o manual quando esconder sugest√µes
        const btnManual = document.getElementById('btnManualNome');
        if (btnManual) {
          btnManual.style.display = 'none';
        }
      }
      
      // Fun√ß√£o para verificar se √© entrada manual
      window.isNomeManual = function() {
        // CORRE√á√ÉO CR√çTICA: Verificar atributos do campo para detec√ß√£o mais confi√°vel
        const isSelectedFromList = nomeInput && nomeInput.getAttribute('data-selected-from-list') === 'true';
        const isMarkedAsManual = nomeInput && nomeInput.getAttribute('data-nome-manual') === 'true';
        
        // Se foi selecionado da lista, NUNCA √© manual
        if (isSelectedFromList) {
          console.log('üîç Nome selecionado da lista - N√ÉO √© manual');
          return false;
        }
        
        // Se foi marcado como manual, √© manual
        if (isMarkedAsManual) {
          console.log('üîç Nome marcado como manual - √â manual');
          return true;
        }
        
        // Fallback para l√≥gica antiga (apenas se n√£o h√° atributos)
        const result = isManualEntry && !selectedFromList;
        
        console.log('üîç window.isNomeManual() chamada:', {
          isManualEntry: isManualEntry,
          selectedFromList: selectedFromList,
          isSelectedFromList: isSelectedFromList,
          isMarkedAsManual: isMarkedAsManual,
          result: result,
          nomeValue: nomeInput ? nomeInput.value : 'undefined'
        });
        
        return result;
      };
      
      // Fun√ß√£o para obter o nome com anota√ß√£o
      window.getNomeComAnotacao = function() {
        const nome = nomeInput.value.trim();
        
        // CORRE√á√ÉO CR√çTICA: Usar a mesma l√≥gica de detec√ß√£o
        const isSelectedFromList = nomeInput && nomeInput.getAttribute('data-selected-from-list') === 'true';
        const isMarkedAsManual = nomeInput && nomeInput.getAttribute('data-nome-manual') === 'true';
        const isSamDesatualizado = nomeInput && nomeInput.getAttribute('data-sam-desatualizado') === 'true';
        
        // Se foi selecionado da lista, NUNCA √© manual
        if (isSelectedFromList) {
          return {
            nome: nome,
            anotacao: '',
            isManual: false
          };
        }
        
        // Se foi marcado como SAM Desatualizado (nome n√£o encontrado na lista), adicionar anota√ß√£o
        if (isSamDesatualizado || isMarkedAsManual) {
          return {
            nome: nome,
            anotacao: 'SAM Desatualizado',
            isManual: true
          };
        }
        
        // Fallback para l√≥gica antiga
        if (isManualEntry && !selectedFromList) {
          return {
            nome: nome,
            anotacao: 'SAM Desatualizado',
            isManual: true
          };
        }
        
        return {
          nome: nome,
          anotacao: '',
          isManual: false
        };
      };
      
      // Fun√ß√£o para adicionar nome √† lista (para uso futuro)
      window.adicionarNomeALista = function(nome) {
        console.log('Adicionando nome √† lista:', nome);
        showStatusModal('NOME ADICIONADO', `NOME "${nome}" FOI ADICIONADO √Ä LISTA`, 'success');
      };
      
      // Fun√ß√£o para limpar entrada manual
      window.limparEntradaManual = function() {
        isManualEntry = false;
        selectedFromList = false;
        hideSuggestions();
        
        // Restaurar estilo normal do input
        nomeInput.style.borderColor = '';
        nomeInput.style.backgroundColor = '';
        
        // CORRE√á√ÉO CR√çTICA: Limpar todos os atributos de estado
        nomeInput.removeAttribute('data-nome-manual');
        nomeInput.removeAttribute('data-selected-from-list');
      };
      
      // Fun√ß√£o para verificar se h√° entrada manual pendente
      window.temEntradaManualPendente = function() {
        return isManualEntry && !selectedFromList && nomeInput.value.trim().length > 0;
      };
      
      // Fun√ß√£o para resetar estado quando comum/cargo/instrumento mudam
      window.resetNomeState = function() {
        isManualEntry = false;
        selectedFromList = false;
        nomeInput.style.borderColor = '';
        nomeInput.style.backgroundColor = '';
        
        // CORRE√á√ÉO CR√çTICA: Limpar todos os atributos de estado
        nomeInput.removeAttribute('data-nome-manual');
        nomeInput.removeAttribute('data-selected-from-list');
        
        hideSuggestions();
        
        // Remover bot√£o de voltar √† lista se existir
        const botaoVoltar = document.getElementById('btnVoltarLista');
        if (botaoVoltar) {
          botaoVoltar.remove();
        }
      };
    }

    // Fun√ß√£o para testar envio do formul√°rio
    function testarEnvio() {
      // Simular valida√ß√£o do formul√°rio
      const comum = document.getElementById('comumInput').value;
      const cargo = document.getElementById('cargo').value;
      const nome = document.getElementById('nome').value;
      const instrumento = document.getElementById('instrumento').value;
      
      if (!comum || !cargo || !nome) {
        showStatusModal('CAMPOS OBRIGAT√ìRIOS', 'POR FAVOR, PREENCHA TODOS OS CAMPOS OBRIGAT√ìRIOS', 'warning');
        return false;
      }
      
      // Verificar se √© entrada manual e obter anota√ß√£o
      const nomeData = window.getNomeComAnotacao ? window.getNomeComAnotacao() : { nome, anotacao: '', isManual: false };
      const isManualEntry = nomeData.isManual;
      const anotacao = nomeData.anotacao;
      
      console.log('üì§ Enviando dados:', { comum, cargo, nome: nomeData.nome, instrumento, isManualEntry, anotacao });
      
      // Verificar se est√° online ou offline
      const isOnline = navigator.onLine;
      
      if (isOnline) {
        // Enviar dados com anota√ß√£o se for entrada manual
        enviarDadosComAnotacao({
          comum: comum,
          cargo: cargo,
          nome: nomeData.nome,
          instrumento: instrumento,
          anotacao: anotacao,
          isManualEntry: isManualEntry,
          timestamp: new Date().toISOString()
        });
      } else {
        // Simular envio offline - adicionar √† fila
        addToOfflineQueueTest({
          comum: comum,
          cargo: cargo,
          nome: nomeData.nome,
          instrumento: instrumento,
          anotacao: anotacao,
          isManualEntry: isManualEntry,
          timestamp: new Date().toISOString()
        });
        // showStatusModal('SALVO OFFLINE', 'DADOS SALVOS NA FILA PARA ENVIO POSTERIOR', 'warning');
      }
      
      // Simular limpeza do formul√°rio
      setTimeout(() => {
        document.getElementById('comumInput').value = '';
        document.getElementById('cargo').value = '';
        document.getElementById('nome').value = '';
        document.getElementById('instrumento').value = '';
        
        // Limpar estado de entrada manual
        if (window.limparEntradaManual) {
          window.limparEntradaManual();
        }
      }, 2000);
      
      return false; // Prevenir envio real
    }
    // Fun√ß√£o para enviar dados com anota√ß√£o
    async function enviarDadosComAnotacao(dados) {
      try {
        console.log('üì§ Enviando dados com anota√ß√£o:', dados);

        // ‚úÖ Se for inclus√£o manual (n√£o est√° na lista), registrar na aba "Anota√ß√µes" do Google Sheets
        if (dados.isManualEntry) {
          const agoraISO = new Date().toISOString().split('T')[0];
          const payload = {
            uuid: generateUUID(),
            nome: dados.nome,
            comum: dados.comum,
            cidade: document.getElementById('currentLocation')?.textContent || '',
            cargo: dados.cargo,
            instrumento: dados.instrumento || '',
            naipe: '',
            nivel: '',
            local_ensaio: '',
            data_ensaio: agoraISO,
            registrado_por: localStorage.getItem('current_user_name') || localStorage.getItem('session_user') || 'Sistema',
            user_id: localStorage.getItem('user_id') || '',
            anotacoes: dados.anotacao || 'SAM Desatualizado'
          };

          await enviarParaSheetsAnotacoes(payload);

          showStatusModal('ENVIADO!', 'REGISTRO SALVO COM SUCESSO', 'success');
          return true;
        }

        // Caso n√£o seja manual, mant√©m o fluxo atual (simula√ß√£o/integra√ß√£o principal)
        const sucesso = await simularEnvioGoogleSheets(dados);
        if (sucesso) {
          showStatusModal('ENVIADO!', 'REGISTRO SALVO COM SUCESSO', 'success');
          return true;
        }
        throw new Error('Falha no envio');

      } catch (error) {
        console.error('‚ùå Erro ao enviar dados:', error);
        return false;
      }
    }
    
    // Fun√ß√£o para simular envio para Google Sheets
    async function simularEnvioGoogleSheets(dados) {
      return new Promise((resolve) => {
        // Simular delay de rede
        setTimeout(() => {
          console.log('‚úÖ Dados enviados para Google Sheets:', {
            ...dados,
            sheet: dados.isManualEntry ? 'Anota√ß√µes' : 'Dados',
            anotacao: dados.anotacao || ''
          });
          resolve(true);
        }, 1000);
      });
    }

    // Fun√ß√£o para adicionar √† fila offline (CORRIGIDA - usa a mesma chave do app.js)
    function addToOfflineQueueTest(data) {
      try {
        // Usar a mesma chave que o app.js usa
        const OFFLINE_QUEUE_KEY = 'offline_queue_v3';
        const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
        const newItem = {
          id: Date.now() + Math.random(),
          data: data,
          timestamp: Date.now(),
          synced: false
        };
        
        queue.push(newItem);
        localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
        
        // Atualizar contador da fila
        updateQueueCountTest();
        
        console.log('‚úÖ Item adicionado √† fila offline (unificada):', newItem);
      } catch (error) {
        console.error('‚ùå Erro ao adicionar √† fila offline:', error);
      }
    }

    // Fun√ß√£o para atualizar contador da fila (CORRIGIDA - usa a mesma chave do app.js)
    function updateQueueCountTest() {
      try {
        // Usar a mesma chave que o app.js usa
        const OFFLINE_QUEUE_KEY = 'offline_queue_v3';
        const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
        const pendingCount = queue.filter(item => !item.synced).length;
        
        const queueCountEl = document.getElementById('queue-count');
        const queueStatusEl = document.getElementById('queue-status');
        
        if (queueCountEl) {
          queueCountEl.textContent = pendingCount;
        }
        
        if (queueStatusEl) {
          if (pendingCount > 0) {
            queueStatusEl.textContent = 'Pendente';
            queueStatusEl.className = 'queue-badge pending';
          } else {
            queueStatusEl.textContent = 'Vazio';
            queueStatusEl.className = 'queue-badge empty';
          }
        }
        
        // Mostrar/ocultar info offline
        const offlineInfo = document.getElementById('offlineInfo');
        if (offlineInfo) {
          if (pendingCount > 0 && !navigator.onLine) {
            offlineInfo.style.display = 'block';
          } else {
            offlineInfo.style.display = 'none';
          }
        }
        
        
      } catch (error) {
        console.error('‚ùå Erro ao atualizar contador da fila:', error);
      }
    }

    // Fun√ß√£o para processar fila offline quando voltar online (CORRIGIDA)
    function processOfflineQueueTest() {
      if (!navigator.onLine) {
        console.log('üì¥ Ainda offline - n√£o processando fila');
        return;
      }
      
      try {
        // Usar a mesma chave que o app.js usa
        const OFFLINE_QUEUE_KEY = 'offline_queue_v3';
        const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
        const pendingItems = queue.filter(item => !item.synced);
        
        if (pendingItems.length === 0) {
          console.log('üìã Nenhum item pendente na fila');
          return;
        }
        
        console.log(`üîÑ Processando ${pendingItems.length} itens da fila offline...`);
        
        // Processar todos os itens pendentes
        pendingItems.forEach((item, index) => {
          setTimeout(() => {
            // Marcar como sincronizado
            item.synced = true;
            console.log(`‚úÖ Item ${index + 1} processado:`, item.data.nome);
            
            // Salvar fila atualizada ap√≥s cada item
            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
            
            // Atualizar contador ap√≥s cada item
            updateQueueCountTest();
            
            // Resetar flag de processamento ap√≥s o √∫ltimo item
            if (index === pendingItems.length - 1) {
              setTimeout(() => {
                isProcessingQueue = false;
                console.log('‚úÖ Processamento autom√°tico conclu√≠do');
              }, 1000);
            }
            
          }, index * 1000); // Processar um item por segundo
        });
        
      } catch (error) {
        console.error('‚ùå Erro ao processar fila offline:', error);
      }
    }

    // Fun√ß√£o para processar fila manualmente (para debug)
    function processQueueManually() {
      console.log('üîß Processamento manual da fila iniciado');
      processOfflineQueueTest();
    }

    // Fun√ß√£o para limpar fila (para debug) - CORRIGIDA
    function clearQueue() {
      // Usar a mesma chave que o app.js usa
      const OFFLINE_QUEUE_KEY = 'offline_queue_v3';
      localStorage.removeItem(OFFLINE_QUEUE_KEY);
      updateQueueCountTest();
      // showStatusModal('FILA LIMPA', 'TODOS OS ITENS DA FILA FORAM REMOVIDOS', 'info');
    }

    // Vari√°vel para controlar se j√° est√° processando
    let isProcessingQueue = false;

    // Fun√ß√£o para iniciar processamento autom√°tico da fila
    function startAutomaticQueueProcessing() {
      // Verificar fila a cada 3 segundos
      setInterval(() => {
        try {
          // Evitar processamento simult√¢neo
          if (isProcessingQueue) {
            return;
          }
          
          // Usar a mesma chave que o app.js usa
          const OFFLINE_QUEUE_KEY = 'offline_queue_v3';
          const queue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');
          const pendingItems = queue.filter(item => !item.synced);
          
          // Se h√° itens pendentes e est√° online, processar automaticamente
          if (pendingItems.length > 0 && navigator.onLine) {
            console.log(`üîÑ Processamento autom√°tico: ${pendingItems.length} itens pendentes`);
            isProcessingQueue = true;
            processOfflineQueueTest();
          }
        } catch (error) {
          console.error('‚ùå Erro no processamento autom√°tico:', error);
          isProcessingQueue = false;
        }
      }, 3000); // Verifica a cada 3 segundos
    }

    // Fun√ß√£o para diagnosticar problemas da fila offline
    function diagnosticarFilaOffline() {
      console.log('üîç DIAGN√ìSTICO DA FILA OFFLINE');
      console.log('================================');
      
      // Verificar todas as chaves de fila poss√≠veis
      const chaves = [
        'offline_queue_v3',
        'offline_queue_test', 
        'fila_envio',
        'fila_supabase',
        'queue'
      ];
      
      chaves.forEach(chave => {
        const dados = localStorage.getItem(chave);
        if (dados) {
          try {
            const parsed = JSON.parse(dados);
            const pendentes = parsed.filter(item => !item.synced).length;
            console.log(`üìã ${chave}: ${parsed.length} itens (${pendentes} pendentes)`);
          } catch (e) {
            console.log(`‚ùå ${chave}: Dados inv√°lidos`);
          }
        } else {
          console.log(`üì≠ ${chave}: Vazia`);
        }
      });
      
      // Verificar conectividade
      console.log('üåê Conectividade:');
      console.log(`  - navigator.onLine: ${navigator.onLine}`);
      console.log(`  - window.offlineQueueProcessing: ${window.offlineQueueProcessing}`);
      console.log(`  - isProcessingQueue: ${isProcessingQueue}`);
      
      // Verificar se app.js est√° carregado
      console.log('üì± App.js:');
      console.log(`  - processOfflineQueue dispon√≠vel: ${typeof window.processOfflineQueue === 'function'}`);
      console.log(`  - checkSupabaseConnection dispon√≠vel: ${typeof window.checkSupabaseConnection === 'function'}`);
      
      // showStatusModal('DIAGN√ìSTICO CONCLU√çDO', 'VERIFIQUE O CONSOLE PARA DETALHES', 'info');
    }

    // Fun√ß√£o para testar todas as funcionalidades
    function testarFuncionalidades() {
      console.log('üß™ Testando funcionalidades do sistema...');
      
      // Testar elementos HTML
      const elementos = {
        comumInput: document.getElementById('comumInput'),
        cargo: document.getElementById('cargo'),
        nome: document.getElementById('nome'),
        instrumento: document.getElementById('instrumento'),
        btnSubmit: document.getElementById('btnSubmit')
      };
      
      console.log('üìã Elementos HTML:', elementos);
      
      // Testar fun√ß√µes
      const funcoes = {
        setupComumSearch: typeof setupComumSearch === 'function',
        setupNomeSearch: typeof setupNomeSearch === 'function',
        loadSampleData: typeof loadSampleData === 'function',
        // toggleInstrumentoVisibility removido - agora √© controlado pelo app.js
        testarEnvio: typeof testarEnvio === 'function',
        showStatusModal: typeof showStatusModal === 'function'
      };
      
      console.log('üîß Fun√ß√µes dispon√≠veis:', funcoes);
      
      // Testar dados
      const dados = {
        comuns: document.getElementById('comumInput') ? 'Campo encontrado' : 'Campo n√£o encontrado',
        cargos: document.getElementById('cargo')?.options?.length || 0,
        instrumentos: document.getElementById('instrumento')?.options?.length || 0
      };
      
      console.log('üìä Dados carregados:', dados);
      
      // Mostrar resultado
      const todosFuncionando = Object.values(elementos).every(el => el !== null) && 
                              Object.values(funcoes).every(fn => fn === true);
      
      if (todosFuncionando) {
        // showStatusModal('SISTEMA OK', 'TODAS AS FUNCIONALIDADES EST√ÉO OPERACIONAIS', 'success');
      } else {
        // showStatusModal('ATEN√á√ÉO', 'ALGUMAS FUNCIONALIDADES PODEM N√ÉO ESTAR FUNCIONANDO', 'warning');
      }
    }

    // Fun√ß√£o para testar o novo toast SweetAlert2
    function testarToast() {
      showStatusModal('ENVIADO!', 'REGISTRO SALVO COM SUCESSO', 'success');
    }
    
    // Fun√ß√£o para testar SweetAlert2 diretamente
    function testarSweetAlert2() {
      console.log('üîî Testando SweetAlert2 diretamente...');
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          title: 'TESTE',
          text: 'Este √© um teste do SweetAlert2',
          icon: 'success',
          showConfirmButton: false,
          timer: 2000,
          zIndex: 99999
        });
      } else {
        console.error('‚ùå SweetAlert2 n√£o est√° dispon√≠vel');
        alert('SweetAlert2 n√£o est√° dispon√≠vel');
      }
    }
    
    // Tornar fun√ß√£o de teste dispon√≠vel globalmente
    window.testarSweetAlert2 = testarSweetAlert2;

    // Fun√ß√£o para garantir que todos os modais estejam fechados na inicializa√ß√£o
    function ensureModalsClosed() {
      console.log('üîí Garantindo que todos os modais estejam fechados...');
      
      // Lista de IDs de modais conhecidos
      const modalIds = ['modalNovaComum', 'modalEdicao', 'modalListaEdicao'];
      
      modalIds.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          // For√ßar fechamento do modal
          modal.style.display = 'none';
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
          modal.setAttribute('aria-modal', 'false');
          
          // Limpar elementos de erro dentro do modal
          const sheetsError = modal.querySelector('#sheetsError');
          if (sheetsError) {
            sheetsError.style.display = 'none';
            sheetsError.classList.add('d-none');
            sheetsError.textContent = '';
          }
          
          // Remover backdrop se existir
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
          
          // Remover classe modal-open do body
          document.body.classList.remove('modal-open');
          
          console.log(`‚úÖ Modal ${modalId} fechado`);
        }
      });
      
      // Aguardar um pouco e verificar novamente
      setTimeout(() => {
        const openModals = document.querySelectorAll('.modal.show');
        if (openModals.length > 0) {
          console.log('‚ö†Ô∏è Ainda h√° modais abertos, for√ßando fechamento...');
          openModals.forEach(modal => {
            modal.style.display = 'none';
            modal.classList.remove('show');
          });
        }
      }, 100);
    }
    
    // Fun√ß√£o para abrir modal manualmente (fallback)
    function openModalManually(modal) {
      console.log('üîß Abrindo modal manualmente...');
      
      // Garantir que elementos de erro estejam ocultos
      const sheetsError = document.getElementById('sheetsError');
      if (sheetsError) {
        sheetsError.style.display = 'none';
        sheetsError.classList.add('d-none');
        sheetsError.textContent = '';
      }
      
      // Abrir modal manualmente
      modal.style.display = 'block';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      modal.setAttribute('aria-modal', 'true');
      
      // CORRE√á√ÉO: N√£o criar backdrop manualmente - deixar Bootstrap gerenciar
      // O Bootstrap criar√° o backdrop automaticamente
      
      // Adicionar classe modal-open ao body
      document.body.classList.add('modal-open');
      
      console.log('‚úÖ Modal aberto manualmente');
      
      // Focar no primeiro campo
      setTimeout(() => {
        const firstInput = modal.querySelector('input, select, textarea');
        if (firstInput) {
          firstInput.focus();
        }
      }, 300);
    }
    
    // Fun√ß√£o para fechar modal corretamente
    function handleModalClose(e) {
      e.preventDefault();
      console.log('üîí Fechando modal...');
      
      const modal = document.getElementById('modalNovaComum');
      if (modal) {
        // Limpar elementos de erro antes de fechar
        const sheetsError = document.getElementById('sheetsError');
        if (sheetsError) {
          sheetsError.style.display = 'none';
          sheetsError.classList.add('d-none');
          sheetsError.textContent = '';
        }
        
        // Tentar usar Bootstrap se dispon√≠vel
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          const bootstrapModal = bootstrap.Modal.getInstance(modal);
          if (bootstrapModal) {
            bootstrapModal.hide();
            console.log('‚úÖ Modal fechado com Bootstrap');
          }
        } else {
          // Fallback manual
          modal.style.display = 'none';
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
          modal.setAttribute('aria-modal', 'false');
          
          // Remover backdrop
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
          
          // Remover classe modal-open do body
          document.body.classList.remove('modal-open');
          
          console.log('‚úÖ Modal fechado manualmente');
        }
      }
    }

    // Fun√ß√£o para controlar o modal corretamente
    function setupModalControl() {
      const btnAbrirModal = document.getElementById('btnAbrirModal');
      const modal = document.getElementById('modalNovaComum');
      
      if (btnAbrirModal && modal) {
        // CORRE√á√ÉO: Garantir que o modal fique completamente oculto na inicializa√ß√£o
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        modal.setAttribute('aria-modal', 'false');
        
        // üöÄ CORRE√á√ÉO: Garantir que o modal seja interativo quando aberto
        modal.style.pointerEvents = 'auto';
        modal.style.zIndex = '1055';
        
        // CORRE√á√ÉO: Remover TODOS os event listeners existentes antes de adicionar novos
        const newHandleModalOpen = function(e) {
          e.preventDefault();
          e.stopPropagation();
          handleModalOpen(e);
        };
        
        // Remover listeners antigos (se existirem)
        btnAbrirModal.removeEventListener('click', handleModalOpen);
        btnAbrirModal.removeEventListener('click', newHandleModalOpen);
        btnAbrirModal.removeEventListener('touchstart', newHandleModalOpen);
        
        // Adicionar apenas UM listener que funciona para ambos click e touch
        btnAbrirModal.addEventListener('click', newHandleModalOpen, { once: false, passive: false });
        
        // Para mobile, usar touchstart apenas se necess√°rio
        if (window.innerWidth <= 768) {
          btnAbrirModal.addEventListener('touchstart', function(e) {
            // N√£o prevenir default aqui para permitir que o click tamb√©m funcione
            newHandleModalOpen(e);
          }, { once: false, passive: false });
        }
        
        // CORRE√á√ÉO CR√çTICA: Monitorar e corrigir aria-hidden automaticamente
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'aria-hidden') {
              const modal = document.getElementById('modalNovaComum');
              if (modal && modal.classList.contains('show') && modal.getAttribute('aria-hidden') === 'true') {
                console.log('üîß Corrigindo aria-hidden automaticamente...');
                modal.setAttribute('aria-hidden', 'false');
                modal.setAttribute('aria-modal', 'true');
                modal.style.pointerEvents = 'auto';
              }
            }
          });
        });
        
        // Observar mudan√ßas no modal
        observer.observe(modal, { attributes: true, attributeFilter: ['aria-hidden'] });
        
        // üöÄ CORRE√á√ÉO: Configurar fechamento do modal de forma mais robusta
        const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close');
        closeButtons.forEach(btn => {
          // Remover listeners existentes
          btn.removeEventListener('click', handleModalClose);
          // Adicionar novo listener
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            handleModalClose(e);
          });
        });
        
        // üöÄ CORRE√á√ÉO: Fechar modal ao clicar no backdrop (mais robusto)
        modal.removeEventListener('click', handleModalBackdropClick);
        modal.addEventListener('click', handleModalBackdropClick);
        
        // üöÄ CORRE√á√ÉO: Fechar modal com ESC (mais robusto)
        document.removeEventListener('keydown', handleModalEscape);
        document.addEventListener('keydown', handleModalEscape);
        
        // üöÄ CORRE√á√ÉO: Event listener para quando o modal √© completamente fechado
        modal.removeEventListener('hidden.bs.modal', handleModalHidden);
        modal.addEventListener('hidden.bs.modal', handleModalHidden);
        modal.addEventListener('shown.bs.modal', handleModalShown);
      }
    }
    
    // Fun√ß√£o chamada quando o modal √© completamente mostrado
    function handleModalShown() {
      console.log('üîÑ Modal completamente mostrado - corrigindo acessibilidade');
      
        // CORRE√á√ÉO CR√çTICA: Corrigir aria-hidden que est√° bloqueando intera√ß√£o
        const modal = document.getElementById('modalNovaComum');
        if (modal) {
          // Remover aria-hidden quando modal est√° aberto
          modal.setAttribute('aria-hidden', 'false');
          modal.setAttribute('aria-modal', 'true');
          
          // CORRE√á√ÉO: Mostrar modal suavemente sem piscar
          modal.style.display = 'block';
          modal.style.opacity = '1';
          modal.style.visibility = 'visible';
          modal.classList.add('show');
          
          // CORRE√á√ÉO MOBILE: Configura√ß√µes espec√≠ficas para mobile
          if (window.innerWidth <= 768) {
            modal.style.touchAction = 'pan-y';
            modal.style.overflowY = 'auto';
            modal.style.webkitOverflowScrolling = 'touch';
          }
          
          // Garantir que o modal seja totalmente interativo
          modal.style.pointerEvents = 'auto';
          modal.style.zIndex = '1055';
          
          // Garantir que todos os elementos dentro do modal sejam interativos
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.zIndex = '1056';
            
            // CORRE√á√ÉO MOBILE: Configurar scroll no modal-content
            if (window.innerWidth <= 768) {
              modalContent.style.maxHeight = '90vh';
              modalContent.style.overflow = 'hidden';
              modalContent.style.display = 'flex';
              modalContent.style.flexDirection = 'column';
            }
          }
          
          // CORRE√á√ÉO MOBILE: Configurar modal-body para scroll
          const modalBody = modal.querySelector('.modal-body');
          if (modalBody && window.innerWidth <= 768) {
            modalBody.style.overflowY = 'auto';
            modalBody.style.webkitOverflowScrolling = 'touch';
            modalBody.style.flex = '1';
            modalBody.style.minHeight = '0';
            modalBody.style.touchAction = 'pan-y';
          }
          
          // Garantir que inputs sejam interativos
          const inputs = modal.querySelectorAll('input, select, textarea, button');
          inputs.forEach(input => {
            input.style.pointerEvents = 'auto';
            input.disabled = false;
            input.readOnly = false;
          });
          
          console.log('‚úÖ Modal corrigido - aria-hidden removido, interatividade restaurada');
        }
    }
    
    // Fun√ß√£o chamada quando o modal √© completamente fechado
    function handleModalHidden() {
      console.log('üîÑ Modal completamente fechado - limpando estado');
      
      // CORRE√á√ÉO: Ocultar modal suavemente
      const modalElement = document.getElementById('modalNovaComum');
      if (modalElement) {
        // Ocultar modal suavemente
        modalElement.style.display = 'none';
        modalElement.style.opacity = '0';
        modalElement.style.visibility = 'hidden';
        modalElement.classList.remove('show');
        
        // Corrigir acessibilidade - restaurar aria-hidden quando modal est√° fechado
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
        console.log('‚úÖ Modal ocultado suavemente');
      }
      
      // Garantir que o body n√£o fique com classes do modal
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      // Remover backdrop se ainda existir
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => backdrop.remove());
      
      // Limpar qualquer inst√¢ncia do modal
      const modalElement2 = document.getElementById('modalNovaComum');
      if (modalElement2 && typeof bootstrap !== 'undefined') {
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement2);
        if (modalInstance) {
          modalInstance.dispose();
        }
      }
    }
    
    // Fun√ß√£o espec√≠fica para backdrop click
    function handleModalBackdropClick(e) {
      if (e.target === e.currentTarget) {
        handleModalClose(e);
      }
    }
    
    // Fun√ß√£o espec√≠fica para ESC key
    function handleModalEscape(e) {
      const modal = document.getElementById('modalNovaComum');
      if (e.key === 'Escape' && modal && modal.classList.contains('show')) {
        handleModalClose(e);
      }
    }
    function handleModalOpen(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üîß Abrindo modal de forma robusta...');
      
      const modal = document.getElementById('modalNovaComum');
      if (!modal) {
        console.error('‚ùå Modal n√£o encontrado!');
        return;
      }
      
      // Aguardar Bootstrap carregar se necess√°rio
      if (typeof bootstrap === 'undefined') {
        console.warn('‚ö†Ô∏è Bootstrap n√£o dispon√≠vel, aguardando...');
        setTimeout(() => {
          if (typeof bootstrap !== 'undefined') {
            handleModalOpen(e);
          } else {
            console.error('‚ùå Bootstrap n√£o carregou ap√≥s timeout!');
            // Fallback manual
            openModalManually(modal);
          }
        }, 1000);
        return;
      }
      
      // Limpeza b√°sica
      modal.classList.remove('show');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
      
      // Remover backdrops existentes
      const existingBackdrops = document.querySelectorAll('.modal-backdrop');
      existingBackdrops.forEach(backdrop => backdrop.remove());
      
      // Destruir inst√¢ncias existentes
      try {
        const existingModal = bootstrap.Modal.getInstance(modal);
        if (existingModal) {
          existingModal.dispose();
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao destruir inst√¢ncia:', error);
      }
      
      // Abrir modal de forma robusta
      const newModal = new bootstrap.Modal(modal, {
        backdrop: true, // CORRE√á√ÉO: Usar backdrop padr√£o do Bootstrap
        keyboard: true,
        focus: true,
        // CORRE√á√ÉO MOBILE: Configura√ß√µes espec√≠ficas para mobile
        scroll: true
      });
      
        // Fun√ß√£o para carregar cargos e instrumentos
        const carregarDadosModal = () => {
          console.log('üîÑ Carregando dados do modal...');
          
          // Carregar cargos - FOR√áA chamada
          console.log('üîÑ Tentando carregar cargos...');
          if (typeof window.carregarCargosModal === 'function') {
            console.log('‚úÖ Chamando window.carregarCargosModal');
            window.carregarCargosModal();
          } else if (typeof carregarCargosModal === 'function') {
            console.log('‚úÖ Chamando carregarCargosModal');
            carregarCargosModal();
          } else {
            console.error('‚ùå Fun√ß√£o carregarCargosModal n√£o encontrada!');
            // Carrega diretamente
            const cargoSelect = document.getElementById('gsCargo');
            if (cargoSelect) {
              const cargos = window.CARGOS_COMPLETOS_MODAL || [
                'M√∫sico', 'Organista', 'Instrutor', 'Instrutora', 'Examinadora',
                'Encarregado Local', 'Encarregado Regional', 'Secret√°rio da M√∫sica', 'Secret√°ria da M√∫sica',
                'Irmandade', 'Anci√£o', 'Di√°cono', 'Cooperador do Of√≠cio', 'Cooperador de Jovens',
                'Porteiro (a)', 'Bombeiro (a)', 'M√©dico (a)', 'Enfermeiro (a)'
              ];
              cargoSelect.innerHTML = '<option value="">Selecione o cargo...</option>' +
                cargos.map(cargo => `<option value="${cargo}">${cargo}</option>`).join('');
              console.log('‚úÖ Cargos carregados diretamente:', cargos.length);
            }
          }
          
          // Carregar instrumentos
          if (typeof window.carregarInstrumentosModal === 'function') {
            window.carregarInstrumentosModal();
          } else if (typeof carregarInstrumentosModal === 'function') {
            carregarInstrumentosModal();
          }
          
          // Carregar outros dados
          if (typeof loadComunsForModal === 'function') {
            loadComunsForModal();
          }
        };
        
        // Detectar se √© mobile
        const isMobile = window.innerWidth <= 768 || /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
        
        // üöÄ CORRE√á√ÉO MOBILE: Carregar no evento show.bs.modal tamb√©m (antes de shown)
        modal.addEventListener('show.bs.modal', function modalShowHandler() {
          console.log('üì± Modal iniciando abertura (show.bs.modal)...');
          if (isMobile) {
            // No mobile, carrega imediatamente no show.bs.modal
            setTimeout(() => {
              console.log('üì± Mobile: Carregando dados no show.bs.modal...');
              carregarDadosModal();
            }, 50);
          }
        });
        
        // Carregar dados quando modal abrir (shown.bs.modal)
        modal.addEventListener('shown.bs.modal', function modalShownHandler() {
          modal.removeEventListener('shown.bs.modal', modalShownHandler);
          
          console.log('‚úÖ Modal aberto - carregando cargos e instrumentos...');
          
          // Carregar dados do modal
          const delay = isMobile ? 200 : 150; // Delay maior no mobile
          setTimeout(() => {
            carregarDadosModal();
          }, delay);
          
          // üöÄ CORRE√á√ÉO MOBILE: Carregar novamente ap√≥s delay maior no mobile
          if (isMobile) {
            setTimeout(() => {
              console.log('üì± Mobile: Verificando se cargos foram carregados...');
              const cargoSelect = document.getElementById('gsCargo');
              if (cargoSelect && cargoSelect.options.length <= 2) {
                console.log('üì± Mobile: Cargos n√£o carregados, tentando novamente...');
                carregarDadosModal();
              }
            }, 500);
          }
      });
      
      // Abrir o modal
      try {
        newModal.show();
        console.log('‚úÖ Modal aberto com sucesso!');
        
        // üöÄ CORRE√á√ÉO CR√çTICA: Carregar cargos IMEDIATAMENTE ap√≥s abrir o modal
        // N√£o depende do evento shown.bs.modal
        setTimeout(() => {
          console.log('üîÑ Carregando cargos IMEDIATAMENTE ap√≥s abertura do modal...');
          
          // Fun√ß√£o para carregar cargos diretamente
          const carregarCargosDireto = () => {
            const cargoSelect = document.getElementById('gsCargo');
            if (!cargoSelect) {
              console.error('‚ùå Elemento gsCargo n√£o encontrado!');
              return;
            }
            
            console.log('‚úÖ Elemento gsCargo encontrado, carregando cargos...');
            
            // Tenta obter cargos de m√∫ltiplas fontes
            let cargos = null;
            if (typeof window.CARGOS_COMPLETOS_MODAL !== 'undefined' && Array.isArray(window.CARGOS_COMPLETOS_MODAL)) {
              cargos = window.CARGOS_COMPLETOS_MODAL;
              console.log('‚úÖ Cargos obtidos de window.CARGOS_COMPLETOS_MODAL:', cargos.length);
            } else if (typeof CARGOS_COMPLETOS_MODAL !== 'undefined' && Array.isArray(CARGOS_COMPLETOS_MODAL)) {
              cargos = CARGOS_COMPLETOS_MODAL;
              console.log('‚úÖ Cargos obtidos de CARGOS_COMPLETOS_MODAL:', cargos.length);
            } else {
              // Array padr√£o
              cargos = [
                'M√∫sico', 'Organista', 'Instrutor', 'Instrutora', 'Examinadora',
                'Encarregado Local', 'Encarregado Regional', 'Secret√°rio da M√∫sica', 'Secret√°ria da M√∫sica',
                'Irmandade', 'Anci√£o', 'Di√°cono', 'Cooperador do Of√≠cio', 'Cooperador de Jovens',
                'Porteiro (a)', 'Bombeiro (a)', 'M√©dico (a)', 'Enfermeiro (a)'
              ];
              console.log('‚ö†Ô∏è Usando array padr√£o de cargos:', cargos.length);
            }
            
            // Limpa e popula o select
            cargoSelect.innerHTML = '<option value="">Selecione o cargo...</option>';
            cargos.forEach(cargo => {
              const option = document.createElement('option');
              option.value = cargo;
              option.textContent = cargo;
              cargoSelect.appendChild(option);
            });
            
            console.log('‚úÖ Cargos carregados diretamente no select:', cargos.length);
            console.log('‚úÖ Total de options no select:', cargoSelect.options.length);
          };
          
          // Tenta chamar a fun√ß√£o primeiro, sen√£o carrega diretamente
          if (typeof window.carregarCargosModal === 'function') {
            console.log('‚úÖ Chamando window.carregarCargosModal...');
            window.carregarCargosModal().catch(() => {
              console.warn('‚ö†Ô∏è Erro ao chamar carregarCargosModal, carregando diretamente...');
              carregarCargosDireto();
            });
          } else if (typeof carregarCargosModal === 'function') {
            console.log('‚úÖ Chamando carregarCargosModal...');
            carregarCargosModal().catch(() => {
              console.warn('‚ö†Ô∏è Erro ao chamar carregarCargosModal, carregando diretamente...');
              carregarCargosDireto();
            });
          } else {
            console.warn('‚ö†Ô∏è Fun√ß√£o carregarCargosModal n√£o encontrada, carregando diretamente...');
            carregarCargosDireto();
          }
          
          // Carregar instrumentos tamb√©m
          const instrumentoSelect = document.getElementById('gsInstrumento');
          if (instrumentoSelect && typeof window.carregarInstrumentosModal === 'function') {
            window.carregarInstrumentosModal();
          }
        }, 100);
        
        // üöÄ CORRE√á√ÉO: Garantir que o modal seja interativo ap√≥s abrir
        setTimeout(() => {
          // CORRE√á√ÉO CR√çTICA: Corrigir aria-hidden que est√° bloqueando intera√ß√£o
          const modal = document.getElementById('modalNovaComum');
          if (modal) {
            // CORRE√á√ÉO PRINCIPAL: Remover aria-hidden quando modal est√° aberto
            modal.setAttribute('aria-hidden', 'false');
            modal.setAttribute('aria-modal', 'true');
            
            // Garantir que o modal seja totalmente interativo
            modal.style.pointerEvents = 'auto';
            modal.style.zIndex = '1055';
            modal.style.display = 'block';
            
            // Garantir que todos os elementos dentro do modal sejam interativos
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.style.pointerEvents = 'auto';
              modalContent.style.zIndex = '1056';
            }
            
            // Garantir que inputs sejam interativos
            const inputs = modal.querySelectorAll('input, select, textarea, button');
            inputs.forEach(input => {
              input.style.pointerEvents = 'auto';
              input.disabled = false;
              input.readOnly = false;
            });
            
            console.log('‚úÖ Modal corrigido - aria-hidden removido, interatividade restaurada');
          }
          
        // CORRE√á√ÉO: Limpar backdrops duplicados e garantir configura√ß√£o correta
        const backdrops = document.querySelectorAll('.modal-backdrop');
        console.log('üîç Backdrops encontrados:', backdrops.length);
        
        // Se h√° mais de um backdrop, remover os extras
        if (backdrops.length > 1) {
          console.log('‚ö†Ô∏è M√∫ltiplos backdrops detectados - removendo extras');
          for (let i = 1; i < backdrops.length; i++) {
            backdrops[i].remove();
          }
        }
        
        // Configurar o backdrop restante
        backdrops.forEach(backdrop => {
          backdrop.style.pointerEvents = 'none';
          backdrop.style.zIndex = '1040'; // Backdrop deve ficar ATR√ÅS do modal
        });
          
          // Garantir que o modal seja clic√°vel e fique ACIMA do backdrop
          modal.style.pointerEvents = 'auto';
          modal.style.zIndex = '1055';
          
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.zIndex = '1056';
          }
          
          // Garantir que os campos sejam interativos
          const inputs = modal.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            input.style.pointerEvents = 'auto';
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
          });
          
          console.log('‚úÖ Modal configurado para intera√ß√£o');
        }, 100);
        
      } catch (error) {
        console.error('‚ùå Erro ao abrir modal:', error);
      }
    }

    function handleModalClose(e) {
      // Prevenir comportamento padr√£o se houver evento
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      try {
        const modal = document.getElementById('modalNovaComum');
        if (modal && typeof bootstrap !== 'undefined') {
          const modalInstance = bootstrap.Modal.getOrCreateInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          } else {
            // Se n√£o h√° inst√¢ncia, criar uma nova e fechar
            const newModal = new bootstrap.Modal(modal);
            newModal.hide();
          }
        }
        
        // Limpar campos do modal
        const campos = ['gsComum', 'gsCidade', 'gsCargo', 'gsInstrumento', 'gsClasse', 'gsNome'];
        campos.forEach(id => {
          const campo = document.getElementById(id);
          if (campo) {
            campo.value = '';
            campo.classList.remove('is-invalid', 'is-valid');
          }
        });
        
        // Resetar exibi√ß√£o dos campos baseado no cargo atual
        const instrumentoContainer = document.getElementById('instrumentoContainer');
        const classeContainer = document.getElementById('classeContainer');
        const cargoSelect = document.getElementById('gsCargo');
        
        if (cargoSelect && instrumentoContainer && classeContainer) {
          const cargo = cargoSelect.value.toUpperCase();
          const isOrganista = cargo === 'ORGANISTA';
          const isExaminadora = cargo === 'EXAMINADORA';
          const isInstrutora = cargo === 'INSTRUTORA';
          const isSecretariaMusica =
            cargo === 'SECRET√ÅRIA DA M√öSICA' ||
            cargo === 'SECRETARIA DA MUSICA' ||
            cargo === 'SECRET√ÅRIO DA M√öSICA' ||
            cargo === 'SECRETARIO DA MUSICA';
          
          // Cargos que tocam apenas √≥rg√£o (devem ocultar o campo instrumento)
          const cargosQueTocamApenasOrgao = isOrganista || isExaminadora || isInstrutora || isSecretariaMusica;
          
          if (cargosQueTocamApenasOrgao) {
            instrumentoContainer.style.display = 'none';
            classeContainer.style.display = 'block';
          } else {
            instrumentoContainer.style.display = 'block';
            classeContainer.style.display = 'none';
          }
        } else {
          // Fallback: resetar para estado padr√£o
          if (instrumentoContainer) instrumentoContainer.style.display = 'block';
          if (classeContainer) classeContainer.style.display = 'none';
        }
        
        // Limpar mensagens de erro
        const sheetsError = document.getElementById('sheetsError');
        if (sheetsError) {
          sheetsError.classList.add('d-none');
          sheetsError.textContent = '';
        }
        
        // Resetar checkbox
        const checkbox = document.getElementById('gsAdicionarManual');
        if (checkbox) checkbox.checked = false;
        
        console.log('‚úÖ Modal fechado com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao fechar modal:', error);
        // Fallback: remover classes do modal manualmente
        const modal = document.getElementById('modalNovaComum');
        if (modal) {
          modal.classList.remove('show');
          modal.style.display = 'none';
          document.body.classList.remove('modal-open');
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) backdrop.remove();
        }
      }
    }

    // üöÄ CORRE√á√ÉO: Fun√ß√£o de fallback para carregar comuns offline
    function loadComunsOffline() {
      console.log('üìµ Carregando comuns offline...');
      
      const input = document.getElementById('gsComum');
      if (!input) {
        console.error('‚ùå Campo gsComum n√£o encontrado no modal');
        return;
      }

      // Dados padr√£o para uso offline
      const defaultComuns = [
        'Apache', 'Aguassa√≠', 'Caucaia do Alto', 'Cotia', 'Itapevi', 'Jandira', 
        'Vargem Grande Paulista', 'Fazendinha', 'Pirapora', 'Jardim Miranda',
        'Vila S√£o Francisco', 'Granja Viana', 'Embu das Artes', 'Tabo√£o da Serra',
        'Central', 'Alphaville', 'Alto da Colina', 'Alto do Bela Vista', 'Alto do Paulista',
        'Jardim Hon√≥ria', 'Jardim S√£o Paulo', 'Jardim das Flores', 'Vila Nova',
        'Centro', 'Vila Madalena', 'Vila Ol√≠mpia', 'Moema', 'Vila Mariana'
      ];
      
      populateComunsInput(input, defaultComuns);
      console.log('‚úÖ Comuns offline carregadas:', defaultComuns.length);
    }

    // Flag para evitar m√∫ltiplas execu√ß√µes simult√¢neas
    let isLoadingComuns = false;
    
    // Fun√ß√£o para carregar comuns especificamente para o modal
    async function loadComunsForModal() {
      // Evitar m√∫ltiplas execu√ß√µes simult√¢neas
      if (isLoadingComuns) {
        console.log('‚ö†Ô∏è Carregamento de comuns j√° em andamento - ignorando chamada duplicada');
        return;
      }
      
      isLoadingComuns = true;
      console.log('üìö Carregando comuns para o modal...');
      
      try {
        const input = document.getElementById('gsComum');
        if (!input) {
          console.error('‚ùå Campo gsComum n√£o encontrado no modal');
          isLoadingComuns = false;
          return;
        }

        // Verifica se est√° offline ou Supabase n√£o dispon√≠vel
        const isOffline = !navigator.onLine || !window.supabaseLoaded || !window.sb;
        console.log('üìö isOffline:', isOffline);
        
        if (isOffline) {
          console.log('üìµ Modo offline - carregando comuns do cache');
          
          // Tenta carregar do cache primeiro
          const cachedComuns = getCache('comuns');
          console.log('üìö cachedComuns:', cachedComuns);
          if (cachedComuns && cachedComuns.length > 0) {
            populateComunsInput(input, cachedComuns);
            isLoadingComuns = false;
            return;
          }
          
          // Usar fun√ß√£o de fallback para dados padr√£o
          loadComunsOffline();
          isLoadingComuns = false;
          return;
        }

        // Carrega do Supabase
        console.log('üìö ===== INICIANDO CONSULTA SUPABASE =====');
        console.log('üìö Carregando comuns do Supabase...');
        console.log('üìö window.sb dispon√≠vel:', !!window.sb);
        console.log('üìö Tipo de window.sb:', typeof window.sb);
        console.log('üìö window.sb.from:', typeof window.sb?.from);
        
        if (!window.sb || typeof window.sb.from !== 'function') {
          console.error('‚ùå window.sb n√£o est√° dispon√≠vel ou n√£o tem m√©todo from');
          loadComunsOffline();
          isLoadingComuns = false;
          return;
        }
        
        console.log('üìö Executando consulta...');
        const { data, error } = await window.sb
          .from('musicos_unificado')
          .select('comum')
          .eq('ativo', true);
        
        console.log('üìö ===== RESULTADO DA CONSULTA =====');
        console.log('üìö Data recebida:', data);
        console.log('üìö Error recebido:', error);

        if (error) { 
          console.error('‚ùå Erro ao carregar comuns:', error); 
          console.log('üîÑ Tentando carregar do cache...');
          
          // Se der erro, tenta usar cache
          const cachedComuns = getCache('comuns');
          if (cachedComuns && cachedComuns.length > 0) {
            console.log('‚úÖ Usando comuns do cache:', cachedComuns.length);
            populateComunsInput(input, cachedComuns);
            isLoadingComuns = false;
            return;
          }
          
          // Usa dados padr√£o se n√£o houver cache
          console.log('üìö Usando comuns padr√£o como fallback');
          loadComunsOffline();
          isLoadingComuns = false;
          return; 
        }

        console.log('üìö Dados recebidos do Supabase:', data);
        console.log('üìö Quantidade de registros:', data ? data.length : 0);
        
        // üöÄ CORRE√á√ÉO: Verificar se os dados est√£o vazios
        if (!data || data.length === 0) {
          console.warn('‚ö†Ô∏è Dados vazios recebidos do Supabase - usando fallback');
          loadComunsOffline();
          isLoadingComuns = false;
          return;
        }
        
        const valores = Array.from(new Set((data||[])
          .map(r => r.comum)
          .filter(Boolean)))
          .map(s => s.toUpperCase())
          .sort((a,b)=>a.localeCompare(b,'pt-BR'));

        console.log('üìö Comuns processadas:', valores);
        console.log('üìö Quantidade de comuns √∫nicas:', valores.length);

        // üöÄ CORRE√á√ÉO: Verificar se processamento resultou em dados v√°lidos
        if (valores.length === 0) {
          console.warn('‚ö†Ô∏è Nenhuma comum v√°lida processada - usando fallback');
          loadComunsOffline();
          isLoadingComuns = false;
          return;
        }

        // Salva no cache para uso offline
        setCache('comuns', valores);
        populateComunsInput(input, valores);
        
      } catch (e) {
        console.error('‚ùå Erro geral ao carregar comuns:', e);
        // Em caso de erro, tenta usar cache
        const cachedComuns = getCache('comuns');
        if (cachedComuns) {
          console.log('üìö Usando comuns do cache devido ao erro geral');
          populateComunsInput(input, cachedComuns);
        } else {
          // Usa dados padr√£o como √∫ltimo recurso
          console.log('üìö Usando comuns padr√£o como √∫ltimo recurso');
          loadComunsOffline();
        }
      } finally {
        // CORRE√á√ÉO CR√çTICA: Sempre resetar flag
        isLoadingComuns = false;
        console.log('üîÑ Flag de carregamento resetada');
      }
    }

    function populateComunsInput(input, valores) {
      // Armazena os dados no dataset para o sistema de pesquisa
      input.dataset.comumList = JSON.stringify(valores);
      console.log('üìö Comuns carregadas no campo:', valores.length);
      
      // Implementar autocomplete funcional
      if (typeof setupAutocomplete === 'function') {
        setupAutocomplete(input, valores);
      }
    }

    function setupAutocomplete(input, valores) {
      // Remove event listeners existentes
      input.removeEventListener('input', handleComumInput);
      input.removeEventListener('blur', handleComumBlur);
      input.removeEventListener('keydown', handleComumKeydown);
      
      // Adiciona novos event listeners
      input.addEventListener('input', handleComumInput);
      input.addEventListener('blur', handleComumBlur);
      input.addEventListener('keydown', handleComumKeydown);
      
      // Armazena refer√™ncia aos valores
      input._comumValues = valores;
      input._selectedIndex = -1;
    }

    function handleComumInput(e) {
      const input = e.target;
      const query = input.value.toLowerCase().trim();
      
      console.log('üîç handleComumInput - query:', query);
      console.log('üîç input._comumValues:', input._comumValues);
      console.log('üîç input._comumValues length:', input._comumValues ? input._comumValues.length : 'undefined');
      
      // Reset do √≠ndice selecionado quando o usu√°rio digita
      input._selectedIndex = -1;
      
      if (query.length < 2) {
        hideComumResults();
        return;
      }
      
      if (!input._comumValues || input._comumValues.length === 0) {
        console.log('‚ùå Nenhuma comum carregada no input');
        showComumMessage(input, 'Comuns n√£o carregadas');
        return;
      }
      
      const matches = input._comumValues.filter(comum => 
        comum.toLowerCase().includes(query)
      );
      
      console.log('üîç matches encontradas:', matches);
      console.log('üîç quantidade de matches:', matches.length);
      
      if (matches.length > 0) {
        showComumResults(matches, query);
      } else {
        hideComumResults();
        // N√£o mostrar mensagem no modal de nova comum
        const isInModal = input.closest('#modalNovaComum');
        if (!isInModal) {
          showComumMessage(input, 'Nenhuma comum encontrada');
        }
      }
    }

    function handleComumBlur(e) {
      const input = e.target;
      // üîß CORRE√á√ÉO: Converte para mai√∫scula quando o campo perde o foco
      if (input.value) {
        input.value = input.value.toUpperCase();
      }
      
      // Delay para permitir clique nas sugest√µes
      setTimeout(() => {
        hideComumResults();
      }, 200);
    }

    function handleComumKeydown(e) {
      const input = e.target;
      const suggestions = input._suggestionsContainer;
      
      // Verifica se h√° sugest√µes vis√≠veis
      if (!suggestions || suggestions.children.length === 0) {
        return;
      }
      
      const items = suggestions.querySelectorAll('.suggestion-item');
      
      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          input._selectedIndex = Math.min(input._selectedIndex + 1, items.length - 1);
          updateSelection(items, input);
          // Scroll para o item selecionado
          if (items[input._selectedIndex]) {
            items[input._selectedIndex].scrollIntoView({ block: 'nearest' });
          }
          break;
        case 'ArrowUp':
          e.preventDefault();
          input._selectedIndex = Math.max(input._selectedIndex - 1, -1);
          updateSelection(items, input);
          // Scroll para o item selecionado
          if (input._selectedIndex >= 0 && items[input._selectedIndex]) {
            items[input._selectedIndex].scrollIntoView({ block: 'nearest' });
          }
          break;
        case 'Enter':
          e.preventDefault();
          if (input._selectedIndex >= 0 && items[input._selectedIndex]) {
            selectComum(input, items[input._selectedIndex].textContent);
          }
          break;
        case 'Escape':
          e.preventDefault();
          hideComumResults();
          break;
        case 'Tab':
          // Permite navega√ß√£o normal com Tab
          if (input._selectedIndex >= 0 && items[input._selectedIndex]) {
            e.preventDefault();
            selectComum(input, items[input._selectedIndex].textContent);
          }
          break;
        case 'Home':
          e.preventDefault();
          input._selectedIndex = 0;
          updateSelection(items, input);
          if (items[0]) {
            items[0].scrollIntoView({ block: 'nearest' });
          }
          break;
        case 'End':
          e.preventDefault();
          input._selectedIndex = items.length - 1;
          updateSelection(items, input);
          if (items[items.length - 1]) {
            items[items.length - 1].scrollIntoView({ block: 'nearest' });
          }
          break;
      }
    }

    // Fun√ß√£o removida - usando apenas showComumResults que tem pin de localiza√ß√£o

    function hideComumResults() {
      const dropdown = document.getElementById('comumResults');
      if (dropdown) {
        dropdown.classList.remove('show');
      }
      // Remove qualquer mensagem "Nenhuma comum encontrada" que tenha sido criada
      try {
        // Prefer√™ncia: remover container espec√≠fico se houver refer√™ncia
        const input = document.getElementById('comumInput');
        if (input && input._suggestionsContainer) {
          input._suggestionsContainer.remove();
          input._suggestionsContainer = null;
        }
        // Seguran√ßa: remover todos os remanescentes no documento
        document.querySelectorAll('.comum-suggestions').forEach(el => {
          if (el.parentNode) el.parentNode.removeChild(el);
        });
      } catch (err) { /* ignore */ }

      // Desativa anima√ß√£o da seta
      const searchIcon = document.querySelector('.search-icon');
      if (searchIcon) {
        searchIcon.classList.remove('active');
      }
    }

    function updateSelection(items, input) {
      items.forEach((item, index) => {
        if (index === input._selectedIndex) {
          item.classList.add('selected');
          item.classList.add('highlighted');
        } else {
          item.classList.remove('selected');
          item.classList.remove('highlighted');
        }
      });
    }

    function selectComum(input, comum) {
      // üö® CORRE√á√ÉO: Normalizar para mai√∫scula ao selecionar
      input.value = comum.toUpperCase();
          hideComumResults();
      input.dispatchEvent(new Event('change'));
    }

    function showComumMessage(input, message) {
          hideComumResults();
      
      const container = document.createElement('div');
      container.className = 'comum-suggestions';
      container.innerHTML = `<div class="suggestion-item no-results">${message}</div>`;
      
      // Posiciona o container
      const rect = input.getBoundingClientRect();
      container.style.position = 'absolute';
      container.style.top = (rect.bottom + window.scrollY) + 'px';
      container.style.left = (rect.left + window.scrollX) + 'px';
      container.style.width = rect.width + 'px';
      container.style.zIndex = '9999';
      
      document.body.appendChild(container);
      input._suggestionsContainer = container;
    }

    // Fun√ß√µes de cache locais para o modal
    function getCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        
        const { data, timestamp, ttl } = JSON.parse(cached);
        const now = Date.now();
        
        if (now - timestamp > ttl) {
          localStorage.removeItem(key);
          return null;
        }
        
        return data;
      } catch (e) {
        localStorage.removeItem(key);
        return null;
      }
    }

    function setCache(key, data, ttl = 24 * 60 * 60 * 1000) { // 24 horas por padr√£o
      const cacheData = {
        data,
        timestamp: Date.now(),
        ttl
      };
      localStorage.setItem(key, JSON.stringify(cacheData));
    }

    // Fun√ß√£o de teste para debug das comuns
    window.testarComunsModal = async function() {
      console.log('üß™ TESTANDO COMUNS DO MODAL');
      console.log('üß™ window.supabaseLoaded:', window.supabaseLoaded);
      console.log('üß™ window.sb:', window.sb);
      console.log('üß™ navigator.onLine:', navigator.onLine);
      
      const input = document.getElementById('gsComum');
      console.log('üß™ Campo gsComum encontrado:', !!input);
      
      if (input) {
        console.log('üß™ input._comumValues:', input._comumValues);
        console.log('üß™ input.dataset.comumList:', input.dataset.comumList);
      }
      
      // Testa carregamento manual
      await loadComunsForModal();
      
      if (input && input._comumValues) {
        console.log('üß™ Comuns carregadas:', input._comumValues.length);
        console.log('üß™ Primeiras 5 comuns:', input._comumValues.slice(0, 5));
      }
    };

    // Fun√ß√£o para verificar e corrigir o estado do campo de nome
    function verificarCampoNome() {
      const nomeInput = document.getElementById('nome');
      if (nomeInput) {
        // üö® CORRE√á√ÉO CR√çTICA MOBILE: SEMPRE garantir que o campo est√° habilitado e pode receber foco
        // Verificar se o campo est√° desabilitado ou bloqueado
        if (nomeInput.disabled || nomeInput.readOnly || 
            nomeInput.style.pointerEvents === 'none' || 
            nomeInput.style.opacity === '0.5') {
          
          console.log('üîß Corrigindo campo de nome bloqueado...');
          
          // For√ßar habilita√ß√£o
          nomeInput.disabled = false;
          nomeInput.readOnly = false;
          nomeInput.removeAttribute('readonly');
          nomeInput.removeAttribute('disabled');
          nomeInput.style.pointerEvents = 'auto';
          nomeInput.style.opacity = '1';
          nomeInput.style.backgroundColor = '';
          nomeInput.style.borderColor = '';
          
          // üö® CORRE√á√ÉO MOBILE: Garantir que o teclado possa abrir
          if (isMobileDevice()) {
            nomeInput.setAttribute('inputmode', 'text');
            nomeInput.setAttribute('autocomplete', 'off');
            nomeInput.setAttribute('autocorrect', 'off');
            nomeInput.setAttribute('autocapitalize', 'off');
            nomeInput.removeAttribute('list');
          }
          
          // Garantir que √© um input de texto
          if (nomeInput.tagName === 'SELECT') {
            console.log('üîÑ Convertendo SELECT para INPUT...');
            const parent = nomeInput.parentNode;
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.id = 'nome';
            newInput.name = 'nome';
            newInput.className = 'form-control';
            newInput.placeholder = 'Digite o nome ou selecione da lista...';
            newInput.autocomplete = 'off';
            newInput.required = true;
            
            // üö® CORRE√á√ÉO MOBILE: Garantir que o novo input tamb√©m permita teclado
            if (isMobileDevice()) {
              newInput.setAttribute('inputmode', 'text');
              newInput.setAttribute('autocorrect', 'off');
              newInput.setAttribute('autocapitalize', 'off');
            }
            
            parent.replaceChild(newInput, nomeInput);
          }
        } else {
          // üö® CORRE√á√ÉO MOBILE: Mesmo se n√£o estiver bloqueado, garantir inputmode='text' no mobile
          if (isMobileDevice()) {
            nomeInput.setAttribute('inputmode', 'text');
            nomeInput.removeAttribute('readonly');
            nomeInput.removeAttribute('disabled');
            nomeInput.disabled = false;
            nomeInput.readOnly = false;
          }
        }
      }
    }

    // Fun√ß√£o para for√ßar habilita√ß√£o do campo de nome
    function forcarHabilitacaoNome() {
      const nomeInput = document.getElementById('nome');
      if (nomeInput) {
        nomeInput.disabled = false;
        nomeInput.readOnly = false;
        nomeInput.style.pointerEvents = 'auto';
        nomeInput.style.opacity = '1';
        nomeInput.style.backgroundColor = '';
        nomeInput.style.borderColor = '';
        nomeInput.focus();
        
        console.log('‚úÖ Campo de nome for√ßadamente habilitado');
        // showStatusModal('CAMPO HABILITADO', 'CAMPO DE NOME FOI HABILITADO PARA DIGITA√á√ÉO', 'success');
      }
    }

    // Fun√ß√£o para testar entrada manual de nomes
    function testarEntradaManual() {
      console.log('üß™ Testando entrada manual de nomes...');
      
      // Simular preenchimento do formul√°rio
      document.getElementById('comumInput').value = 'Itapevi';
      document.getElementById('cargo').value = 'M√∫sico';
      document.getElementById('instrumento').value = 'Violino';
      
      // Simular digita√ß√£o de nome n√£o encontrado
      const nomeInput = document.getElementById('nome');
      nomeInput.value = 'Nome Que N√£o Existe';
      nomeInput.dispatchEvent(new Event('input'));
      
      // showStatusModal('TESTE INICIADO', 'DIGITE UM NOME QUE N√ÉO EXISTE NA LISTA PARA TESTAR A DIGITA√á√ÉO MANUAL AUTOM√ÅTICA', 'info');
    }
    
    // Fun√ß√£o simples para testar digita√ß√£o manual
    function testarDigita√ß√£oSimples() {
      const nomeInput = document.getElementById('nome');
      if (nomeInput) {
        // For√ßar convers√£o para INPUT
        if (nomeInput.tagName === 'SELECT') {
          const parent = nomeInput.parentNode;
          const newInput = document.createElement('input');
          newInput.type = 'text';
          newInput.id = 'nome';
          newInput.name = 'nome';
          newInput.className = 'form-control';
          newInput.placeholder = 'Digite o nome completo...';
          newInput.autocomplete = 'off';
          newInput.required = true;
          parent.replaceChild(newInput, nomeInput);
        }
        
        // Habilitar
        const updatedInput = document.getElementById('nome');
        updatedInput.disabled = false;
        updatedInput.readOnly = false;
        updatedInput.style.pointerEvents = 'auto';
        updatedInput.style.opacity = '1';
        updatedInput.focus();
        
        // showStatusModal('CAMPO HABILITADO', 'AGORA VOC√ä PODE DIGITAR NO CAMPO DE NOME', 'success');
      }
    }
    // Expor fun√ß√µes globalmente para debug
    window.processQueueManually = processQueueManually;
    window.clearQueue = clearQueue;
    window.updateQueueCountTest = updateQueueCountTest;
    window.diagnosticarFilaOffline = diagnosticarFilaOffline;
    window.testarFuncionalidades = testarFuncionalidades;
    window.testarToast = testarToast;
    window.testarEntradaManual = testarEntradaManual;
    window.testarDigita√ß√£oSimples = testarDigita√ß√£oSimples;
    window.forcarHabilitacaoNome = forcarHabilitacaoNome;
    window.verificarCampoNome = verificarCampoNome;
    window.habilitarDigitacaoManual = function() {
      // Fun√ß√£o global para habilitar digita√ß√£o manual
      const nomeInput = document.getElementById('nome');
      if (nomeInput) {
        // For√ßar convers√£o para INPUT se for SELECT
        if (nomeInput.tagName === 'SELECT') {
          const parent = nomeInput.parentNode;
          const newInput = document.createElement('input');
          newInput.type = 'text';
          newInput.id = 'nome';
          newInput.name = 'nome';
          newInput.className = 'form-control';
          newInput.placeholder = 'Digite o nome completo...';
          newInput.autocomplete = 'off';
          newInput.required = true;
          newInput.value = nomeInput.value || '';
          parent.replaceChild(newInput, nomeInput);
        }
        
        // Habilitar o campo
        const updatedInput = document.getElementById('nome');
        updatedInput.disabled = false;
        updatedInput.readOnly = false;
        updatedInput.style.pointerEvents = 'auto';
        updatedInput.style.opacity = '1';
        updatedInput.style.backgroundColor = '#f0f9ff';
        updatedInput.style.borderColor = '#3b82f6';
        updatedInput.focus();
        
        // showStatusModal('CAMPO HABILITADO', 'CAMPO DE NOME HABILITADO PARA DIGITA√á√ÉO MANUAL', 'success');
      }
    };
    window.setupModalControl = setupModalControl;
    window.loadComunsForModal = loadComunsForModal;
    window.testarComunsModal = window.testarComunsModal;
    window.handleModalOpen = handleModalOpen;
    window.handleModalClose = handleModalClose;
    window.verificarMusicoNaoEncontrado = verificarMusicoNaoEncontrado;
    window.adicionarMusicoManual = adicionarMusicoManual;
    window.adicionarMusicoManualDireto = adicionarMusicoManualDireto;
    window.enviarParaSheetsAnotacoes = enviarParaSheetsAnotacoes;
    
    // üöÄ FUN√á√ÉO DE TESTE: Verificar status do modal
    window.testarModal = function() {
      console.log('üß™ ===== TESTE DO MODAL =====');
      console.log('üß™ window.supabaseLoaded:', window.supabaseLoaded);
      console.log('üß™ window.sb:', !!window.sb);
      console.log('üß™ typeof loadComunsForModal:', typeof loadComunsForModal);
      console.log('üß™ typeof loadComunsOffline:', typeof loadComunsOffline);
      
      const modal = document.getElementById('modalNovaComum');
      console.log('üß™ Modal encontrado:', !!modal);
      
      const input = document.getElementById('gsComum');
      console.log('üß™ Campo gsComum encontrado:', !!input);
      
      // CORRE√á√ÉO AUTOM√ÅTICA: Verificar e corrigir interatividade
      if (modal) {
        console.log('üß™ Corrigindo interatividade do modal...');
        modal.style.pointerEvents = 'auto';
        modal.style.zIndex = '1055';
        
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          modalContent.style.pointerEvents = 'auto';
          modalContent.style.zIndex = '1056';
        }
        
        const inputs = modal.querySelectorAll('input, select, textarea, button');
        inputs.forEach(input => {
          input.style.pointerEvents = 'auto';
          input.disabled = false;
          input.readOnly = false;
        });
        
        console.log('üß™ Modal corrigido!');
      }
      
      if (input) {
        console.log('üß™ Dataset comumList:', input.dataset.comumList);
        console.log('üß™ Valor do campo:', input.value);
      }
      
      // Testar carregamento offline
      if (typeof loadComunsOffline === 'function') {
        console.log('üß™ Testando carregamento offline...');
        loadComunsOffline();
      }
      
      console.log('üß™ ===== FIM DO TESTE =====');
    };

    // Carregar comuns quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìö DOM carregado - inicializando sistema...');
      
      // CORRE√á√ÉO: Limpar backdrops √≥rf√£os que podem estar causando escurecimento
      setTimeout(() => {
        if (typeof limparBackdrops === 'function') {
          limparBackdrops();
        }
      }, 100);
      
      // CORRE√á√ÉO: Garantir que o modal fique oculto na inicializa√ß√£o
      // O CSS j√° garante que o modal esteja oculto desde o in√≠cio,
      // mas fazemos uma verifica√ß√£o adicional para garantir consist√™ncia
      const modal = document.getElementById('modalNovaComum');
      if (modal) {
        // Garantir que o modal est√° completamente oculto
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        modal.classList.remove('show');
        modal.classList.remove('fade');
        modal.classList.remove('in');
        
        // Remover qualquer backdrop que possa estar presente
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Remover classe modal-open do body
        document.body.classList.remove('modal-open');
        
        console.log('‚úÖ Modal completamente oculto na inicializa√ß√£o');
      }
      
      // Aguardar Bootstrap carregar
      const waitForBootstrap = () => {
        if (typeof bootstrap !== 'undefined') {
          console.log('‚úÖ Bootstrap carregado - configurando modal...');
          
          // Configurar controle do modal
          if (typeof setupModalControl === 'function') {
            setupModalControl();
          }
          
          // CORRE√á√ÉO: N√£o carregar dados do modal automaticamente na inicializa√ß√£o
          // Os dados ser√£o carregados apenas quando o modal for aberto
          console.log('‚úÖ Modal configurado - dados ser√£o carregados apenas quando aberto');
        } else {
          console.warn('‚ö†Ô∏è Bootstrap n√£o carregado, tentando novamente...');
          setTimeout(waitForBootstrap, 500);
        }
      };
      
      // Iniciar verifica√ß√£o
      waitForBootstrap();
      
      // Configurar controle de visibilidade dos campos do modal
      setupModalFieldVisibility();
    });
    
    // Fun√ß√£o para controlar visibilidade dos campos do modal
    function setupModalFieldVisibility() {
      const cargoSelect = document.getElementById('gsCargo');
      const instrumentoContainer = document.getElementById('modalInstrumentoContainer');
      const classeContainer = document.getElementById('classeContainer');
      
      if (cargoSelect && instrumentoContainer && classeContainer) {
        cargoSelect.addEventListener('change', function() {
          aplicarVisibilidadeCamposModal();
        });
      }
    }
    
    // Fun√ß√£o para configurar digita√ß√£o manual no modal
    function setupModalManualEntry() {
      const nomeInput = document.getElementById('gsNome');
      if (!nomeInput) {
        console.warn('‚ö†Ô∏è Campo gsNome n√£o encontrado para setupModalManualEntry');
        return;
      }
      
      console.log('üîß Configurando detec√ß√£o de entrada manual no modal');
      
      // Vari√°vel para controlar se √© entrada manual
      let isManualEntry = false;
      
      // Adicionar event listener para detectar quando o usu√°rio digita
      nomeInput.addEventListener('input', function() {
        const valor = this.value.trim();
        const timestamp = Date.now();
        
        // Marcar timestamp da √∫ltima entrada
        this.dataset.lastInput = timestamp.toString();
        
        if (valor.length > 0) {
          // Permitir entrada manual sem restri√ß√µes
          isManualEntry = true;
          
          // üéØ CORRE√á√ÉO: Marcar campo com atributo para facilitar detec√ß√£o
          this.setAttribute('data-nome-manual', 'true');
          
          console.log('‚úèÔ∏è Entrada manual detectada no modal:', valor);
          
          // Marcar visualmente que √© entrada manual (se for cargo musical)
          const cargoSelect = document.getElementById('gsCargo');
          if (cargoSelect) {
            const cargo = cargoSelect.value.toUpperCase();
            const isCargoMusical = cargo.includes('M√öSICO') || 
                                   cargo === 'ORGANISTA' ||
                                   cargo.includes('EXAMINADORA') ||
                                   cargo.includes('INSTRUTORA') ||
                                   (cargo.toLowerCase().includes('secret√°ria') && cargo.toLowerCase().includes('m√∫sica'));
            
            if (isCargoMusical) {
              // Estilo visual para indicar que ser√° marcado como SAM Desatualizado
              this.style.backgroundColor = '#fef3c7';
              this.style.borderColor = '#f59e0b';
              console.log('‚úèÔ∏è Campo marcado como entrada manual - ser√° enviado com "SAM Desatualizado"');
            }
          }
        } else {
          // Resetar quando campo estiver vazio
          isManualEntry = false;
          this.removeAttribute('data-nome-manual');
          this.style.backgroundColor = '';
          this.style.borderColor = '';
          console.log('üîÑ Campo resetado - n√£o √© mais entrada manual');
        }
      });
      
      // Adicionar event listener para detectar quando o usu√°rio clica no campo
      nomeInput.addEventListener('focus', function() {
        console.log('üîç Campo de nome recebeu foco');
        // Se o campo tem valor, marcar como entrada manual
        if (this.value.trim()) {
          isManualEntry = true;
          this.setAttribute('data-nome-manual', 'true');
          this.dataset.lastInput = Date.now().toString();
        }
      });
      
      // Armazenar fun√ß√£o para verificar se √© entrada manual
      window.isModalManualEntry = function() {
        const campo = document.getElementById('gsNome');
        if (!campo) return false;
        
        // Verificar atributo primeiro
        if (campo.hasAttribute('data-nome-manual')) {
          console.log('üîç Entrada manual detectada via atributo data-nome-manual');
          return true;
        }
        
        // Verificar vari√°vel local
        if (isManualEntry) {
          console.log('üîç Entrada manual detectada via vari√°vel isManualEntry');
          return true;
        }
        
        // Verificar se tem valor e foi modificado recentemente
        if (campo.value.trim() && campo.dataset.lastInput) {
          const timeDiff = Date.now() - parseInt(campo.dataset.lastInput);
          if (timeDiff < 10000) { // 10 segundos
            console.log('üîç Entrada manual detectada via timestamp recente');
            return true;
          }
        }
        
        console.log('üîç Nenhuma entrada manual detectada');
        return false;
      };
      
      console.log('‚úÖ setupModalManualEntry configurado com sucesso');
    }
    
    // Fun√ß√£o para aplicar a l√≥gica de visibilidade dos campos
    function aplicarVisibilidadeCamposModal() {
      const cargoSelect = document.getElementById('gsCargo');
      const instrumentoContainer = document.getElementById('modalInstrumentoContainer');
      const classeContainer = document.getElementById('classeContainer');
      
      if (cargoSelect && instrumentoContainer && classeContainer) {
        const cargo = cargoSelect.value.toUpperCase();
        const isOrganista = cargo === 'ORGANISTA';
        const isExaminadora = cargo === 'EXAMINADORA';
        const isInstrutora = cargo === 'INSTRUTORA';
        const isSecretariaMusica =
          cargo === 'SECRET√ÅRIA DA M√öSICA' ||
          cargo === 'SECRETARIA DA MUSICA' ||
          cargo === 'SECRET√ÅRIO DA M√öSICA' ||
          cargo === 'SECRETARIO DA MUSICA';
        
        // Cargos n√£o musicais que devem ocultar o campo instrumento
        const isMinisterio = cargo === 'MINIST√âRIO' || cargo === 'MINISTERIO';
        const isAnciao = cargo === 'ANCI√ÉO' || cargo === 'ANCIAO';
        const isDiacono = cargo === 'DI√ÅCONO' || cargo === 'DIACONO';
        
        // Cargos que devem ter classe automaticamente como OFICIALIZADA
        const cargosComClasseOficializada = isInstrutora || isExaminadora || isSecretariaMusica;
        
        // Cargos que tocam apenas √≥rg√£o (devem ocultar o campo instrumento)
        const cargosQueTocamApenasOrgao = isOrganista || isExaminadora || isInstrutora || isSecretariaMusica;
        
        // Cargos n√£o musicais
        const cargosNaoMusicais = isMinisterio || isAnciao || isDiacono;
        
        console.log('üîç Aplicando visibilidade para cargo:', cargo, 'cargosQueTocamApenasOrgao:', cargosQueTocamApenasOrgao, 'cargosNaoMusicais:', cargosNaoMusicais, 'cargosComClasseOficializada:', cargosComClasseOficializada);
        
        if (cargosComClasseOficializada) {
          // Para Instrutora, Examinadora e Secret√°ria da M√∫sica: ocultar instrumento e classe, mas registrar automaticamente como Oficializada
          instrumentoContainer.style.display = 'none';
          instrumentoContainer.style.visibility = 'hidden';
          instrumentoContainer.style.height = '0';
          instrumentoContainer.style.overflow = 'hidden';
          instrumentoContainer.style.margin = '0';
          instrumentoContainer.style.padding = '0';
          
          classeContainer.style.display = 'none';
          
          // Definir instrumento automaticamente como √ìRG√ÉO
          const instrumentoSelect = document.getElementById('gsInstrumento');
          if (instrumentoSelect) {
            instrumentoSelect.value = '√ìRG√ÉO';
          }
          
          // Definir classe automaticamente como Oficializada (ser√° usado no envio)
          const classeSelect = document.getElementById('gsClasse');
          if (classeSelect) {
            classeSelect.value = 'OFICIALIZADA';
          }
          
          console.log(`‚úÖ ${cargo} selecionado - campos ocultos, classe automaticamente definida como OFICIALIZADA`);
        } else if (cargo === 'ORGANISTA') {
          // Para Organista: ocultar instrumento, mostrar classe (usu√°rio escolhe)
          instrumentoContainer.style.display = 'none';
          instrumentoContainer.style.visibility = 'hidden';
          instrumentoContainer.style.height = '0';
          instrumentoContainer.style.overflow = 'hidden';
          instrumentoContainer.style.margin = '0';
          instrumentoContainer.style.padding = '0';
          
          classeContainer.style.display = 'block';
          
          // Adicionar classe CSS para for√ßar oculta√ß√£o
          const modalContent = document.querySelector('.modal.inmodal .modal-content');
          if (modalContent) {
            modalContent.classList.add('organista-mode');
          }
          
          // Definir instrumento automaticamente como √ìRG√ÉO
          const instrumentoSelect = document.getElementById('gsInstrumento');
          if (instrumentoSelect) {
            instrumentoSelect.value = '√ìRG√ÉO';
          }
          
          // Reabilitar campo de classe para usu√°rio escolher
          const classeSelect = document.getElementById('gsClasse');
          if (classeSelect) {
            classeSelect.disabled = false;
            classeSelect.style.backgroundColor = '';
            classeSelect.style.cursor = '';
          }
          
          console.log('‚úÖ Organista selecionado - campo de classe ativado para escolha do usu√°rio');
        } else if (cargosNaoMusicais) {
          // Para cargos n√£o musicais: ocultar instrumento e classe
          instrumentoContainer.style.display = 'none';
          instrumentoContainer.style.visibility = 'hidden';
          instrumentoContainer.style.height = '0';
          instrumentoContainer.style.overflow = 'hidden';
          instrumentoContainer.style.margin = '0';
          instrumentoContainer.style.padding = '0';
          
          classeContainer.style.display = 'none';
          
          // Adicionar classe CSS para for√ßar oculta√ß√£o
          const modalContent = document.querySelector('.modal.inmodal .modal-content');
          if (modalContent) {
            modalContent.classList.add('cargo-nao-musical');
            modalContent.classList.remove('organista-mode');
          }
          
          // Limpar instrumento
          const instrumentoSelect = document.getElementById('gsInstrumento');
          if (instrumentoSelect) {
            instrumentoSelect.value = '';
          }
          
          // Limpar classe
          const classeSelect = document.getElementById('gsClasse');
          if (classeSelect) {
            classeSelect.value = '';
          }
          
          console.log('‚úÖ Campo instrumento OCULTO para cargos n√£o musicais:', cargo);
        } else {
          // Para outros cargos (m√∫sicos, etc.): mostrar instrumento, ocultar classe
          instrumentoContainer.style.display = 'block';
          instrumentoContainer.style.visibility = 'visible';
          instrumentoContainer.style.height = 'auto';
          instrumentoContainer.style.overflow = 'visible';
          instrumentoContainer.style.margin = '';
          instrumentoContainer.style.padding = '';
          
          classeContainer.style.display = 'none';
          
          // Remover classe CSS
          const modalContent = document.querySelector('.modal.inmodal .modal-content');
          if (modalContent) {
            modalContent.classList.remove('organista-mode');
          }
          
          // Reabilitar campo de classe caso tenha sido desabilitado
          const classeSelect = document.getElementById('gsClasse');
          if (classeSelect) {
            classeSelect.disabled = false;
            classeSelect.style.backgroundColor = '';
            classeSelect.style.cursor = '';
            classeSelect.value = '';
          }
          
          console.log('‚úÖ Campo instrumento VIS√çVEL para outros cargos:', cargo);
        }
      }
    }

    // Fun√ß√£o para detectar m√∫sico n√£o encontrado e permitir adi√ß√£o manual
    async function verificarMusicoNaoEncontrado(comum, cargo, instrumento, nome) {
      console.log('üîç Verificando se m√∫sico n√£o foi encontrado:', { comum, cargo, instrumento, nome });
      
      // Verifica se o Supabase est√° dispon√≠vel
      if (!window.supabaseLoaded || !window.sb) {
        console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel para verifica√ß√£o');
        return false;
      }

      try {
        // Busca o m√∫sico no cat√°logo
        const { data, error } = await window.sb
          .from('musicos_unificado')
          .select('nome, comum, cargo, instrumento')
          .ilike('nome', `%${nome}%`)
          .ilike('comum', `%${comum}%`)
          .ilike('cargo', `%${cargo}%`)
          .eq('ativo', true);

        if (error) {
          console.error('‚ùå Erro ao verificar m√∫sico:', error);
          return false;
        }

        console.log('üîç Resultado da busca:', data);

        // Se n√£o encontrou o m√∫sico, permite adi√ß√£o manual
        if (!data || data.length === 0) {
          console.log('‚ùå M√∫sico n√£o encontrado no cat√°logo');
          return await adicionarMusicoManual(comum, cargo, instrumento, nome);
        }

        // Se encontrou, verifica se √© exatamente o mesmo
        const encontrado = data.find(musico => 
          musico.nome.toLowerCase().includes(nome.toLowerCase()) &&
          musico.comum.toLowerCase().includes(comum.toLowerCase()) &&
          musico.cargo.toLowerCase().includes(cargo.toLowerCase()) &&
          (instrumento ? musico.instrumento.toLowerCase().includes(instrumento.toLowerCase()) : true)
        );

        if (!encontrado) {
          console.log('‚ùå M√∫sico encontrado mas com dados diferentes');
          return await adicionarMusicoManual(comum, cargo, instrumento, nome);
        }

        console.log('‚úÖ M√∫sico encontrado no cat√°logo');
        return false; // M√∫sico encontrado, n√£o precisa adicionar manualmente

      } catch (e) {
        console.error('‚ùå Erro geral na verifica√ß√£o:', e);
        return false;
      }
    }

    // Fun√ß√£o para adicionar m√∫sico manualmente (com confirma√ß√£o)
    async function adicionarMusicoManual(comum, cargo, instrumento, nome) {
      console.log('üìù Adicionando m√∫sico manualmente:', { comum, cargo, instrumento, nome });

      // Mostra confirma√ß√£o para o usu√°rio
      const confirmacao = confirm(
        `M√∫sico n√£o encontrado no cat√°logo:\n\n` +
        `Nome: ${nome}\n` +
        `Comum: ${comum || 'Comum n√£o localizada'}\n` +
        `Cargo: ${cargo}\n` +
        `Instrumento: ${instrumento}\n\n` +
        `Deseja adicionar manualmente e marcar como "SAM Desatualizado"?`
      );

      if (!confirmacao) {
        console.log('‚ùå Usu√°rio cancelou a adi√ß√£o manual');
        return false;
      }

      return await adicionarMusicoManualDireto(comum, cargo, instrumento, nome, document.getElementById('gsCidade')?.value || '');
    }

    // Fun√ß√£o para adicionar m√∫sico manualmente (sem confirma√ß√£o - checkbox marcado)
    async function adicionarMusicoManualDireto(comum, cargo, instrumento, nome, cidade) {
      console.log('üìù Adicionando m√∫sico manualmente (direto):', { comum, cargo, instrumento, nome, cidade });

      try {
        // Prepara dados para envio
        const dadosMusico = {
          uuid: generateUUID(),
          nome: nome,
          comum: comum,
          cidade: cidade,
          cargo: cargo,
          instrumento: instrumento || '',
          naipe: '',
          nivel: '',
          local_ensaio: '',
          data_ensaio: new Date().toISOString().split('T')[0],
          registrado_por: localStorage.getItem('current_user_name') || localStorage.getItem('session_user') || 'Sistema',
          user_id: localStorage.getItem('user_id') || '',
          anotacoes: 'SAM Desatualizado'
        };

        console.log('üì§ Enviando dados do m√∫sico manual:', dadosMusico);

        // Envia para Google Sheets
        await enviarParaSheetsAnotacoes(dadosMusico);
        
        // üöÄ CORRE√á√ÉO: Cadastro manual (fora da regional) N√ÉO envia para Supabase
        // Apenas registros da regional s√£o enviados para o Supabase
        console.log('‚ÑπÔ∏è Cadastro manual: Fora da regional - n√£o enviando para Supabase');

        // Mostra mensagem de sucesso
        showFastAlert('success', 'M√∫sico Adicionado', 'M√∫sico adicionado manualmente com anota√ß√£o "SAM Desatualizado"');

        return true;

      } catch (e) {
        console.error('‚ùå Erro ao adicionar m√∫sico manualmente:', e);
        
        // Mostrar erro espec√≠fico baseado no tipo de erro
        let errorMessage = 'Erro ao adicionar m√∫sico manualmente';
        if (e.name === 'AbortError') {
          errorMessage = 'Timeout: Verifique sua conex√£o com a internet';
        } else if (e.message.includes('HTTP')) {
          errorMessage = `Erro do servidor: ${e.message}`;
        } else if (e.message.includes('fetch')) {
          errorMessage = 'Erro de conex√£o: Verifique sua internet';
        }
        
        showFastAlert('error', 'Erro', errorMessage);
        return false;
      }
    }

    // Fun√ß√£o para enviar dados para a aba "Anota√ß√µes" do Google Sheets
    async function enviarParaSheetsAnotacoes(dados) {
      // üöÄ CORRE√á√ÉO: Usa proxy local se dispon√≠vel, sen√£o usa URL direta
      const isLocalServer = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const url = isLocalServer 
        ? '/api/google-script'  // Proxy local
        : "https://script.google.com/macros/s/AKfycbxPtvi86jPy7y41neTpIPvn3hpycd3cMjbgjgifzLD6qRwrJVPlF9EDulaQp42nma-i/exec";
      
      console.log('üåê URL da API para anota√ß√µes:', url);
      
      // Gera hor√°rio de registro
      const agora = new Date();
      const horarioRegistro = agora.toLocaleString('pt-BR', {
        timeZone: 'America/Sao_Paulo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // Prepara dados para a aba "Anota√ß√µes"
      const sheetRow = {
        "UUID": dados.uuid,
        "NOME COMPLETO": dados.nome,
        "COMUM": dados.comum,
        "CIDADE": dados.cidade,
        "CARGO": dados.cargo,
        "INSTRUMENTO": dados.instrumento,
        "NAIPE_INSTRUMENTO": dados.naipe,
        "CLASSE_ORGANISTA": dados.nivel,
        "LOCAL_ENSAIO": dados.local_ensaio,
        "DATA_ENSAIO": dados.data_ensaio,
        "HOR√ÅRIO": horarioRegistro,
        "REGISTRADO_POR": dados.registrado_por,
        "USER_ID": dados.user_id,
        "ANOTACOES": dados.anotacoes,
        "SYNC_STATUS": "ATUALIZADO"
      };

      try {
        console.log('üì§ Enviando dados para aba Anota√ß√µes:', sheetRow);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify({
            op: 'append',
            sheet: 'Anota√ß√µes', // Envia para aba "Anota√ß√µes"
            data: sheetRow
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (response.ok) {
          const responseText = await response.text();
          console.log('‚úÖ Dados enviados para aba Anota√ß√µes com sucesso:', responseText);
          return true;
        } else {
          const errorText = await response.text();
          console.error('‚ùå Erro HTTP ao enviar para aba Anota√ß√µes:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

      } catch (error) {
        console.error('‚ùå Erro ao enviar para Google Sheets (aba Anota√ß√µes):', error);
        console.error('‚ùå Detalhes do erro:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
        throw error;
      }
    }

    // Fun√ß√£o para testar envio de anota√ß√µes
    async function testarEnvioAnotacoes() {
      console.log('üß™ Testando envio de anota√ß√µes...');
      
      const dadosTeste = {
        uuid: generateUUID(),
        nome: 'Teste SAM Desatualizado',
        comum: 'Teste',
        cidade: 'S√£o Paulo',
        cargo: 'M√∫sico',
        instrumento: '√ìrg√£o',
        naipe: '',
        nivel: '',
        local_ensaio: '',
        data_ensaio: new Date().toISOString().split('T')[0],
        registrado_por: 'Sistema Teste',
        user_id: 'teste',
        anotacoes: 'SAM Desatualizado - TESTE'
      };
      
      try {
        await enviarParaSheetsAnotacoes(dadosTeste);
        console.log('‚úÖ Teste de anota√ß√µes: SUCESSO');
        showFastAlert('success', 'Teste OK', 'Fun√ß√£o de anota√ß√µes est√° funcionando!');
        return true;
      } catch (error) {
        console.error('‚ùå Teste de anota√ß√µes: FALHOU', error);
        showFastAlert('error', 'Teste Falhou', `Erro: ${error.message}`);
        return false;
      }
    }
    
    // Expor fun√ß√£o de teste globalmente
    window.testarEnvioAnotacoes = testarEnvioAnotacoes;

    // Fun√ß√£o para mostrar alertas r√°pidos
    function showFastAlert(type, title, message) {
      // Usa SweetAlert2 se dispon√≠vel, sen√£o usa alert nativo
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: type,
          title: title,
          text: message,
          timer: 3000,
          showConfirmButton: false
        });
      } else {
        alert(`${title}: ${message}`);
      }
    }

    // Fun√ß√£o para configurar verifica√ß√£o de m√∫sico
    function setupVerificacaoMusico() {
      const btnSalvar = document.getElementById('btnSalvarGS');
      if (btnSalvar) {
        // Remove event listeners existentes
        btnSalvar.removeEventListener('click', handleSalvarComVerificacao);
        btnSalvar.removeEventListener('click', handleSalvarComVerificacao);
        
        // Adiciona novo event listener com verifica√ß√£o
        btnSalvar.addEventListener('click', handleSalvarComVerificacao);
        
        console.log('‚úÖ Event listener configurado para btnSalvarGS');
      }
    }

    // Flag para evitar m√∫ltiplas execu√ß√µes
    let isProcessing = false;

    // Fun√ß√£o para lidar com o salvamento com verifica√ß√£o
    async function handleSalvarComVerificacao(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Evitar m√∫ltiplas execu√ß√µes
      if (isProcessing) {
        console.log('‚ö†Ô∏è Processamento j√° em andamento - ignorando chamada');
        return;
      }
      
      isProcessing = true;
      console.log('üöÄ IN√çCIO: handleSalvarComVerificacao');
      
      // Fun√ß√£o auxiliar para resetar flag sempre
      const resetFlag = () => {
        isProcessing = false;
        console.log('üîÑ Processamento finalizado - flag resetado');
      };
      
      try {
        // Coleta dados do formul√°rio
        const comum = document.getElementById('gsComum')?.value?.trim();
        const cidade = document.getElementById('gsCidade')?.value?.trim();
        const cargo = document.getElementById('gsCargo')?.value?.trim();
        const instrumento = document.getElementById('gsInstrumento')?.value?.trim();
        const classe = document.getElementById('gsClasse')?.value?.trim();
        const nome = document.getElementById('gsNome')?.value?.trim();
        
        console.log('üìù Dados coletados:', { comum, cidade, cargo, instrumento, classe, nome });
        
        // Valida√ß√£o b√°sica
        if (!comum || !cidade || !cargo || !nome) {
          showFastAlert('error', 'Campos Obrigat√≥rios', 'Preencha todos os campos obrigat√≥rios');
          resetFlag();
          return;
        }
        
        // Verifica se √© um m√∫sico (cargo que precisa de instrumento)
        const cargoUpper = cargo.toUpperCase();
        const isMusico = cargoUpper.includes('M√öSICO') || cargoUpper.includes('INSTRUTOR');
        const isOrganista = cargoUpper === 'ORGANISTA';
        const isExaminadora = cargoUpper === 'EXAMINADORA';
        const isInstrutora = cargoUpper === 'INSTRUTORA';
        const isSecretariaMusica =
          cargoUpper === 'SECRET√ÅRIA DA M√öSICA' ||
          cargoUpper === 'SECRETARIA DA MUSICA' ||
          cargoUpper === 'SECRET√ÅRIO DA M√öSICA' ||
          cargoUpper === 'SECRETARIO DA MUSICA';
        
        // Cargos que tocam apenas √≥rg√£o
        const cargosQueTocamApenasOrgao = isOrganista || isExaminadora || isInstrutora || isSecretariaMusica;
        
        if (isMusico && !instrumento && !cargosQueTocamApenasOrgao) {
          showFastAlert('error', 'Instrumento Obrigat√≥rio', 'Para m√∫sicos, o instrumento √© obrigat√≥rio');
          resetFlag();
          return;
        }
        
        // Para cargos que tocam apenas √≥rg√£o, definir instrumento automaticamente
        if (cargosQueTocamApenasOrgao) {
          const instrumentoSelect = document.getElementById('gsInstrumento');
          if (instrumentoSelect) {
            instrumentoSelect.value = '√ìRG√ÉO';
          }
        }
        
        console.log('üì§ Enviando dados via enviarDadosModal...');
        await enviarDadosModal();
        console.log('‚úÖ Dados enviados com sucesso');
        
      } catch (error) {
        console.error('‚ùå Erro no envio:', error);
        showFastAlert('error', 'Erro', 'Erro ao processar o registro');
      } finally {
        // CORRE√á√ÉO CR√çTICA: Sempre resetar flag
        resetFlag();
      }
    }

    // Fun√ß√£o para envio normal do modal (sem verifica√ß√£o)
    // Fun√ß√£o para limpar o formul√°rio do modal
    function limparFormularioModal() {
      document.getElementById('gsComum').value = '';
      document.getElementById('gsCidade').value = '';
      document.getElementById('gsCargo').value = '';
      document.getElementById('gsInstrumento').value = '';
      document.getElementById('gsNome').value = '';
      
      // Fecha o modal
      const modal = document.getElementById('modalNovaComum');
      if (modal && typeof bootstrap !== 'undefined') {
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modal);
        if (modalInstance) {
          modalInstance.hide();
        }
      }
    }

    // Fun√ß√£o para configurar busca de comuns
    function setupComumSearch() {
      const comumInput = document.getElementById('comumInput');
      if (!comumInput) return;

      // Dados de exemplo para comuns
      const comunsData = [
        'Apache', 'Aguassa√≠', 'Caucaia do Alto', 'Cotia', 'Itapevi', 'Jandira', 
        'Vargem Grande Paulista', 'Fazendinha', 'Pirapora', 'Jardim Miranda',
        'Vila S√£o Francisco', 'Granja Viana', 'Embu das Artes', 'Tabo√£o da Serra',
        'Central', 'Alphaville', 'Alto da Colina', 'Alto do Bela Vista', 'Alto do Paulista',
        'Vila Nova', 'Jardim das Flores', 'Centro', 'Vila Rica', 'Parque dos P√°ssaros'
      ];

      let searchTimeout;
      let currentResults = [];

      // Fun√ß√£o de busca
      function searchComuns(query) {
        if (!query || query.length < 1) {
          return comunsData.slice(0, 10);
        }
        
        const term = query.toLowerCase();
        return comunsData.filter(comum => 
          comum.toLowerCase().includes(term)
        ).slice(0, 10);
      }

      // Fun√ß√£o para mostrar resultados
      function showComumResults(results, query) {
        const dropdown = document.getElementById('comumResults');
        if (!dropdown) return;
        // Remover mensagens antigas de "nenhuma comum" se existirem
        try {
          const input = document.getElementById('comumInput');
          if (input && input._suggestionsContainer) {
            input._suggestionsContainer.remove();
            input._suggestionsContainer = null;
          }
          document.querySelectorAll('.comum-suggestions').forEach(el => el.remove());
        } catch (e) { /* ignore */ }

        if (results.length === 0) {
          dropdown.innerHTML = '';
          dropdown.classList.remove('show');
          return;
        }

        // Usar a mesma estrutura do app.js com pin de localiza√ß√£o
        // üö® CORRE√á√ÉO: Normalizar comuns para mai√∫scula na exibi√ß√£o
        dropdown.innerHTML = results.map(comum => {
          const comumUpper = comum.toUpperCase();
          return `
          <div class="suggestion-item" data-value="${comum}">
            <i class="fa-solid fa-map-marker-alt"></i>
            <span>${comumUpper}</span>
          </div>
        `;
        }).join('');

        // Adicionar event listeners aos itens
        dropdown.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', () => {
            // üö® CORRE√á√ÉO: Normalizar para mai√∫scula ao selecionar
            const comumValue = item.dataset.value;
            comumInput.value = comumValue.toUpperCase();
            dropdown.classList.remove('show');
          });
        });

        dropdown.classList.add('show');

        // ‚úÖ Garantir que o campo e a lista fiquem vis√≠veis acima do teclado no mobile
        try {
          const container = comumInput.closest('.form-group') || comumInput;
          setTimeout(() => {
            container.scrollIntoView({ block: 'start', behavior: 'smooth' });
            // Ajuste fino para deixar espa√ßo para o dropdown
            const rect = comumInput.getBoundingClientRect();
            const topOffset = rect.top + window.scrollY - 12;
            window.scrollTo({ top: topOffset, behavior: 'smooth' });
          }, 0);
        } catch (e) { /* ignore */ }
      }

      // Event listener para input
      comumInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
          currentResults = searchComuns(searchTerm);
          showComumResults(currentResults, searchTerm);
        }, 150);
      });

      // Event listener para foco
      comumInput.addEventListener('focus', (e) => {
        const searchTerm = e.target.value.trim();
        if (searchTerm) {
          currentResults = searchComuns(searchTerm);
          showComumResults(currentResults, searchTerm);
        }
      });

      // Fechar dropdown ao clicar fora
      document.addEventListener('click', (e) => {
        if (!comumInput.contains(e.target) && !document.getElementById('comumResults').contains(e.target)) {
          document.getElementById('comumResults').classList.remove('show');
        }
      });
    }

    // üß™ FUN√á√ÉO DE TESTE PARA NAVEGA√á√ÉO POR TECLADO
    function testarNavegacaoTeclado() {
      console.log('üß™ TESTE DE NAVEGA√á√ÉO POR TECLADO');
      console.log('=====================================');
      console.log('üìã Instru√ß√µes:');
      console.log('1. Digite pelo menos 2 caracteres no campo de comum');
      console.log('2. Use as setas ‚Üë‚Üì para navegar');
      console.log('3. Use Enter para selecionar');
      console.log('4. Use Escape para fechar');
      console.log('5. Use Tab para selecionar e ir para o pr√≥ximo campo');
      console.log('6. Use Home/End para ir ao primeiro/√∫ltimo item');
      console.log('7. Use o mouse para hover nos itens');
      console.log('');
      console.log('‚úÖ Funcionalidades implementadas:');
      console.log('   - Setas ‚Üë‚Üì para navega√ß√£o');
      console.log('   - Enter para sele√ß√£o');
      console.log('   - Escape para fechar');
      console.log('   - Tab para sele√ß√£o e navega√ß√£o');
      console.log('   - Home/End para primeiro/√∫ltimo');
      console.log('   - Scroll autom√°tico para item selecionado');
      console.log('   - Hover do mouse atualiza sele√ß√£o');
      console.log('   - Visual destacado para item selecionado');
      console.log('');
      console.log('üéØ Teste agora digitando no campo de comum!');
    }
    
    // Disponibiliza a fun√ß√£o globalmente
    window.testarNavegacaoTeclado = testarNavegacaoTeclado;
    
    // üß™ FUN√á√ÉO DE TESTE PARA SUGEST√ïES DE NOMES MOBILE
    function testarSugestoesNomesMobile() {
      console.log('üß™ TESTE DE SUGEST√ïES DE NOMES MOBILE');
      console.log('=====================================');
      
      if (!isMobileDevice()) {
        console.log('‚ö†Ô∏è Este teste √© espec√≠fico para dispositivos m√≥veis');
        console.log('üì± Abra este site em um dispositivo m√≥vel para testar');
        return;
      }
      
      console.log('üìã Instru√ß√µes de teste:');
      console.log('1. Toque no campo "NOME E SOBRENOME"');
      console.log('2. Digite pelo menos 3 caracteres (ex: "mar")');
      console.log('3. Observe a lista de sugest√µes aparecer acima do teclado');
      console.log('4. Teste a navega√ß√£o:');
      console.log('   - Toque nas sugest√µes para selecionar');
      console.log('   - Use as setas ‚Üë‚Üì para navegar (se teclado f√≠sico)');
      console.log('   - Use Enter para selecionar');
      console.log('   - Use Escape para fechar');
      console.log('5. Teste a op√ß√£o "HABILITAR DIGITA√á√ÉO MANUAL"');
      console.log('6. Teste tocar fora para fechar');
      console.log('');
      
      console.log('‚úÖ Funcionalidades implementadas:');
      console.log('   - Lista flutuante acima do teclado virtual');
      console.log('   - Design otimizado para mobile');
      console.log('   - Navega√ß√£o por teclado (setas, Enter, Escape)');
      console.log('   - Indicador visual para fechar');
      console.log('   - Op√ß√£o de digita√ß√£o manual destacada');
      console.log('   - Fechamento por toque fora');
      console.log('   - Scroll suave na lista');
      console.log('   - Hover effects nos itens');
      console.log('');
      console.log('üéØ Teste agora digitando no campo de nome!');
    }
    
    window.testarSugestoesNomesMobile = testarSugestoesNomesMobile;

    // Fun√ß√£o para configurar reset do estado do nome
    function setupNomeStateReset() {
      // Detectar plataforma no escopo da fun√ß√£o
      const isAndroid = /Android/.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      const comumInput = document.getElementById('comumInput');
      const cargoSelect = document.getElementById('cargo');
      const instrumentoSelect = document.getElementById('instrumento');
      
      // Reset quando comum mudar
      if (comumInput) {
        comumInput.addEventListener('change', function() {
          if (window.resetNomeState) {
            window.resetNomeState();
          }
          // Carregar nomes quando comum mudar
          const cargo = document.getElementById('cargo')?.value?.trim();
          if (cargo && typeof loadNomes === 'function') {
            console.log('üö® ANDROID: Chamando loadNomes...');
            
            // Remover mensagem "Carregando nomes..." se existir
            const nomeEl = document.getElementById('nome');
            if (nomeEl && nomeEl.tagName === 'SELECT') {
              // Remover op√ß√£o de carregamento
              const loadingOption = nomeEl.querySelector('option[value=""][disabled]');
              if (loadingOption && loadingOption.textContent.includes('Carregando')) {
                loadingOption.remove();
              }
              // Limpar placeholder de carregamento
              nomeEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
            }
            
            // üö® CORRE√á√ÉO: Timeout REDUZIDO para 5 segundos
            const timeout = setTimeout(() => {
              console.warn('‚ö†Ô∏è Timeout ao carregar nomes (5s) - removendo mensagem e verificando cache...');
              
              // Remover mensagem "Carregando nomes..." SEMPRE
              const nomeEl = document.getElementById('nome');
              if (nomeEl) {
                if (nomeEl.tagName === 'SELECT') {
                  // Remover op√ß√£o de carregamento
                  const loadingOption = nomeEl.querySelector('option[value=""][disabled]');
                  if (loadingOption && loadingOption.textContent.includes('Carregando')) {
                    loadingOption.remove();
                  }
                  
                  // Se window.nomesData j√° tem dados, popular SELECT
                  if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                    console.log('‚úÖ window.nomesData encontrada - populando SELECT agora!');
                    popularSelectDireto(nomeEl, window.nomesData);
                  } else {
                    // Se n√£o tem dados, converter para INPUT
                    console.log('üìù Sem dados - convertendo para INPUT');
                    if (typeof window.converterParaInput === 'function') {
                      window.converterParaInput(nomeEl);
                    }
                  }
                } else {
                  // Se for INPUT, remover placeholder de carregamento
                  if (nomeEl.placeholder && nomeEl.placeholder.includes('Carregando')) {
                    nomeEl.placeholder = 'Digite o nome completo...';
                  }
                }
              }
              
              // Esconder indicador de carregamento do app.js
              if (typeof hideLoadingIndicator === 'function') {
                hideLoadingIndicator();
              }
              if (typeof hideLoadingAlert === 'function') {
                hideLoadingAlert();
              }
            }, 5000); // 5 segundos de timeout (reduzido de 10s)
            
            // Fun√ß√£o para popular SELECT diretamente
            function popularSelectDireto(selectEl, nomes) {
              if (!selectEl || selectEl.tagName !== 'SELECT') return;
              
              // üö® CORRE√á√ÉO CR√çTICA: N√ÉO popular se SELECT j√° foi populado no loadNomes
              if (selectEl.options.length > 1) {
                console.log('‚úÖ SELECT j√° foi populado - n√£o sobrescrevendo');
                return;
              }
              
              console.log('üîÑ ANDROID: Populando SELECT diretamente com', nomes.length, 'nomes');
              
              selectEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
              
              const nomesStrings = nomes.map(nome => {
                return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
              }).filter(Boolean);
              
              nomesStrings.forEach((nome, index) => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                selectEl.appendChild(option);
              });
              
              // Adicionar op√ß√£o manual
              const optionManual = document.createElement('option');
              optionManual.value = '__MANUAL_INPUT__';
              optionManual.textContent = '‚úèÔ∏è Adicionar novo nome manualmente';
              selectEl.appendChild(optionManual);
              
              // Event listener para op√ß√£o manual
              selectEl.removeEventListener('change', handleNomeSelectChangeManual);
              selectEl.addEventListener('change', handleNomeSelectChangeManual);
              
              function handleNomeSelectChangeManual(e) {
                if (e.target.value === '__MANUAL_INPUT__') {
                  const selectEl = e.target;
                  const inputEl = document.createElement('input');
                  inputEl.type = 'text';
                  inputEl.id = 'nome';
                  inputEl.name = 'nome';
                  inputEl.className = 'form-control';
                  inputEl.placeholder = 'Digite o nome completo...';
                  inputEl.required = true;
                  inputEl.setAttribute('data-nome-manual', 'true');
                  selectEl.parentNode.replaceChild(inputEl, selectEl);
                  inputEl.focus();
                }
              }
              
              console.log('‚úÖ ANDROID: SELECT populado com', nomesStrings.length, 'nomes (total options:', selectEl.options.length, ')');
              void selectEl.offsetHeight; // For√ßar reflow
            }
            
            // üö® SOLU√á√ÉO DEFINITIVA ANDROID: Chamar loadNomes e popular SELECT diretamente ap√≥s
            loadNomes().then(() => {
              clearTimeout(timeout);
              console.log('‚úÖ ANDROID: loadNomes completado - window.nomesData:', window.nomesData?.length || 0);
              
              // Verificar m√∫ltiplas vezes para garantir que window.nomesData foi populado
              let tentativas = 0;
              const maxTentativas = 10;
              
              const verificarEPopular = () => {
                tentativas++;
                console.log(`üîÑ ANDROID: Tentativa ${tentativas} de popular SELECT...`);
                
                const nomeEl = document.getElementById('nome');
                if (!nomeEl) {
                  console.error('‚ùå Campo nome n√£o encontrado');
                  return;
                }
                
                // Verificar se window.nomesData foi populado
                if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                  console.log('üö® ANDROID: window.nomesData encontrada! Populando SELECT AGORA...');
                  
                  // Garantir que √© SELECT
                  if (nomeEl.tagName !== 'SELECT') {
                    console.log('üîÑ Convertendo INPUT para SELECT...');
                    const selectEl = document.createElement('select');
                    selectEl.id = 'nome';
                    selectEl.name = 'nome';
                    selectEl.className = 'form-select';
                    selectEl.required = true;
                    nomeEl.parentNode.replaceChild(selectEl, nomeEl);
                    const newNomeEl = document.getElementById('nome');
                    if (newNomeEl) {
                      popularSelectDireto(newNomeEl, window.nomesData);
                    }
                  } else {
                    // Verificar se j√° foi populado
                    if (nomeEl.options.length <= 1) {
                      console.log('üîÑ SELECT n√£o populado - populando agora...');
                      popularSelectDireto(nomeEl, window.nomesData);
                    } else {
                      console.log('‚úÖ SELECT j√° foi populado com', nomeEl.options.length, 'op√ß√µes');
                    }
                  }
                } else if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length === 0) {
                  console.log('üìù Nenhum nome - convertendo para INPUT');
                  if (nomeEl.tagName === 'SELECT') {
                    if (typeof window.converterParaInput === 'function') {
                      window.converterParaInput(nomeEl);
                    }
                  }
                } else if (tentativas < maxTentativas) {
                  // Se window.nomesData ainda n√£o foi populado, tentar novamente
                  console.log(`‚è≥ window.nomesData ainda n√£o populado, tentando novamente em 300ms...`);
                  setTimeout(verificarEPopular, 300);
                } else {
                  console.error('‚ùå window.nomesData n√£o foi populado ap√≥s', maxTentativas, 'tentativas');
                }
              };
              
              // Iniciar verifica√ß√£o imediatamente
              verificarEPopular();
              
            }).catch((error) => {
              clearTimeout(timeout);
              console.error('‚ùå Erro ao carregar nomes:', error);
              const nomeEl = document.getElementById('nome');
              if (nomeEl && nomeEl.tagName === 'SELECT') {
                if (typeof window.converterParaInput === 'function') {
                  window.converterParaInput(nomeEl);
                }
              }
            });
          }
        });
      }
      
      // Reset quando cargo mudar
      if (cargoSelect) {
        cargoSelect.addEventListener('change', function() {
          if (window.resetNomeState) {
            window.resetNomeState();
          }
          // Carregar nomes quando cargo mudar
          const comum = document.getElementById('comumInput')?.value?.trim();
          if (comum && typeof loadNomes === 'function') {
            // Remover mensagem "Carregando nomes..." se existir
            const nomeEl = document.getElementById('nome');
            if (nomeEl && nomeEl.tagName === 'SELECT') {
              // Remover op√ß√£o de carregamento
              const loadingOption = nomeEl.querySelector('option[value=""][disabled]');
              if (loadingOption && loadingOption.textContent.includes('Carregando')) {
                loadingOption.remove();
              }
              // Limpar placeholder de carregamento
              nomeEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
            }
            
            // Fun√ß√£o para popular SELECT diretamente (mesma do listener de comum)
            function popularSelectDireto(selectEl, nomes) {
              if (!selectEl || selectEl.tagName !== 'SELECT') return;
              
              // üö® CORRE√á√ÉO CR√çTICA: N√ÉO popular se SELECT j√° foi populado no loadNomes
              if (selectEl.options.length > 1) {
                console.log('‚úÖ SELECT j√° foi populado - n√£o sobrescrevendo');
                return;
              }
              
              console.log('üîÑ ANDROID: Populando SELECT diretamente com', nomes.length, 'nomes');
              
              selectEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
              
              const nomesStrings = nomes.map(nome => {
                return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
              }).filter(Boolean);
              
              nomesStrings.forEach((nome, index) => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                selectEl.appendChild(option);
              });
              
              // Adicionar op√ß√£o manual
              const optionManual = document.createElement('option');
              optionManual.value = '__MANUAL_INPUT__';
              optionManual.textContent = '‚úèÔ∏è Adicionar novo nome manualmente';
              selectEl.appendChild(optionManual);
              
              // Event listener para op√ß√£o manual
              selectEl.removeEventListener('change', handleNomeSelectChangeManual);
              selectEl.addEventListener('change', handleNomeSelectChangeManual);
              
              function handleNomeSelectChangeManual(e) {
                if (e.target.value === '__MANUAL_INPUT__') {
                  const selectEl = e.target;
                  const inputEl = document.createElement('input');
                  inputEl.type = 'text';
                  inputEl.id = 'nome';
                  inputEl.name = 'nome';
                  inputEl.className = 'form-control';
                  inputEl.placeholder = 'Digite o nome completo...';
                  inputEl.required = true;
                  inputEl.setAttribute('data-nome-manual', 'true');
                  selectEl.parentNode.replaceChild(inputEl, selectEl);
                  inputEl.focus();
                }
              }
              
              console.log('‚úÖ ANDROID: SELECT populado com', nomesStrings.length, 'nomes');
              void selectEl.offsetHeight; // For√ßar reflow
            }
            
            // üö® CORRE√á√ÉO: Timeout REDUZIDO para 5 segundos
            const timeout = setTimeout(() => {
              console.warn('‚ö†Ô∏è Timeout ao carregar nomes (5s) - removendo mensagem e verificando cache...');
              
              // Remover mensagem "Carregando nomes..." SEMPRE
              const nomeEl = document.getElementById('nome');
              if (nomeEl) {
                if (nomeEl.tagName === 'SELECT') {
                  // Remover op√ß√£o de carregamento
                  const loadingOption = nomeEl.querySelector('option[value=""][disabled]');
                  if (loadingOption && loadingOption.textContent.includes('Carregando')) {
                    loadingOption.remove();
                  }
                  
                  // Se window.nomesData j√° tem dados, popular SELECT
                  if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                    console.log('‚úÖ window.nomesData encontrada - populando SELECT agora!');
                    popularSelectDireto(nomeEl, window.nomesData);
                  } else {
                    // Se n√£o tem dados, converter para INPUT
                    console.log('üìù Sem dados - convertendo para INPUT');
                    if (typeof window.converterParaInput === 'function') {
                      window.converterParaInput(nomeEl);
                    }
                  }
                } else {
                  // Se for INPUT, remover placeholder de carregamento
                  if (nomeEl.placeholder && nomeEl.placeholder.includes('Carregando')) {
                    nomeEl.placeholder = 'Digite o nome completo...';
                  }
                }
              }
              
              // Esconder indicador de carregamento do app.js
              if (typeof hideLoadingIndicator === 'function') {
                hideLoadingIndicator();
              }
              if (typeof hideLoadingAlert === 'function') {
                hideLoadingAlert();
              }
            }, 5000); // 5 segundos de timeout (reduzido de 10s)
            
            loadNomes().then(() => {
              clearTimeout(timeout);
              console.log('‚úÖ loadNomes completado - window.nomesData:', window.nomesData?.length || 0);
              
              // üö® ANDROID FIX: Popular imediatamente ap√≥s loadNomes completar
              if (isAndroid && typeof popularSelectSeNecessario === 'function') {
                console.log('üö® ANDROID: For√ßando popula√ß√£o imediata do SELECT...');
                // üö® CORRE√á√ÉO ANDROID: Aguardar um pouco para garantir que app.js terminou de popular
                setTimeout(() => {
                  const nomeElCheck = document.getElementById('nome');
                  // Verificar se app.js j√° populou o SELECT
                  if (nomeElCheck && nomeElCheck.tagName === 'SELECT' && 
                      (nomeElCheck.options.length > 1 || nomeElCheck.getAttribute('data-populado') === 'true')) {
                    console.log('‚úÖ app.js j√° populou o SELECT - n√£o populando novamente');
                    return;
                  }
                  // Se n√£o foi populado, popular agora
                  popularSelectSeNecessario();
                }, 200);
              }
              
              // Aguardar um pouco para garantir que populateNomesInput foi chamada
              setTimeout(() => {
                try {
                  // üö® CORRE√á√ÉO CR√çTICA ANDROID: Verificar se o campo foi populado
                  const nomeEl = document.getElementById('nome');
                  if (!nomeEl) {
                    console.error('‚ùå Campo nome n√£o encontrado');
                    return;
                  }
                  
                  console.log('üîç Verificando campo nome ap√≥s loadNomes:', {
                    tagName: nomeEl.tagName,
                    optionsLength: nomeEl.tagName === 'SELECT' ? nomeEl.options.length : 0,
                    nomesDataLength: window.nomesData?.length || 0
                  });
                  
                  // üö® CORRE√á√ÉO CR√çTICA ANDROID: Popular SELECT diretamente SEMPRE
                  if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                    console.log('üìã H√° nomes - populando SELECT diretamente (Android fix)');
                    console.log('üìã window.nomesData:', window.nomesData.slice(0, 5));
                    
                    // Garantir que o campo √© SELECT
                    if (nomeEl.tagName !== 'SELECT') {
                      console.log('üîÑ Campo n√£o √© SELECT, convertendo...');
                      if (nomeEl.tagName === 'INPUT') {
                        const selectEl = document.createElement('select');
                        selectEl.id = 'nome';
                        selectEl.name = 'nome';
                        selectEl.className = 'form-select';
                        selectEl.required = true;
                        nomeEl.parentNode.replaceChild(selectEl, nomeEl);
                        nomeEl = document.getElementById('nome');
                      }
                    }
                    
                    // üö® CORRE√á√ÉO CR√çTICA: N√ÉO popular se SELECT j√° foi populado no loadNomes
                    // Verificar ANTES de popular para evitar sobrescrever
                    if (nomeEl && nomeEl.tagName === 'SELECT') {
                      // Se SELECT j√° tem op√ß√µes, N√ÉO fazer nada (j√° foi populado no loadNomes)
                      if (nomeEl.options.length > 1) {
                        console.log('‚úÖ SELECT j√° foi populado no loadNomes - n√£o sobrescrevendo');
                        return;
                      }
                      
                      console.log('üîÑ Populando SELECT diretamente...');
                      
                      // Limpar e popular
                      nomeEl.innerHTML = '<option value="">Selecione um nome da lista...</option>';
                      
                      // Converter objetos para strings
                      const nomesStrings = window.nomesData.map(nome => {
                        return typeof nome === 'string' ? nome : (nome?.nome || String(nome));
                      }).filter(Boolean);
                      
                      console.log('üìã Nomes strings:', nomesStrings.slice(0, 5));
                      
                      // Adicionar op√ß√µes
                      nomesStrings.forEach((nome, index) => {
                        const option = document.createElement('option');
                        option.value = nome;
                        option.textContent = nome;
                        nomeEl.appendChild(option);
                        
                        // Log a cada 10 nomes para n√£o sobrecarregar
                        if (index < 5 || index % 10 === 0) {
                          console.log(`  ‚úÖ Op√ß√£o ${index + 1}: ${nome}`);
                        }
                      });
                      
                      // Adicionar op√ß√£o manual
                      const optionManual = document.createElement('option');
                      optionManual.value = '__MANUAL_INPUT__';
                      optionManual.textContent = '‚úèÔ∏è Adicionar novo nome manualmente';
                      nomeEl.appendChild(optionManual);
                      
                      // Event listener para op√ß√£o manual
                      nomeEl.removeEventListener('change', handleNomeSelectChangeManual);
                      nomeEl.addEventListener('change', handleNomeSelectChangeManual);
                      
                      function handleNomeSelectChangeManual(e) {
                        if (e.target.value === '__MANUAL_INPUT__') {
                          const selectEl = e.target;
                          const inputEl = document.createElement('input');
                          inputEl.type = 'text';
                          inputEl.id = 'nome';
                          inputEl.name = 'nome';
                          inputEl.className = 'form-control';
                          inputEl.placeholder = 'Digite o nome completo...';
                          inputEl.required = true;
                          inputEl.setAttribute('data-nome-manual', 'true');
                          selectEl.parentNode.replaceChild(inputEl, selectEl);
                          inputEl.focus();
                        }
                      }
                      
                      console.log('‚úÖ SELECT populado com', nomesStrings.length, 'nomes (total options:', nomeEl.options.length, ')');
                      
                      // For√ßar reflow para garantir renderiza√ß√£o no Android
                      void nomeEl.offsetHeight;
                    }
                  } else {
                    console.log('üìù Nenhum nome encontrado - convertendo para INPUT');
                    console.log('üìù window.nomesData:', window.nomesData);
                    // Se n√£o h√° nomes, converter para INPUT
                    if (nomeEl.tagName === 'SELECT') {
                      if (typeof window.converterParaInput === 'function') {
                        window.converterParaInput(nomeEl);
                      }
                    }
                  }
                } catch (error) {
                  console.error('‚ùå Erro ao popular campo nome:', error);
                  // Em caso de erro, converter para INPUT para permitir digita√ß√£o manual
                  const nomeEl = document.getElementById('nome');
                  if (nomeEl && nomeEl.tagName === 'SELECT') {
                    if (typeof window.converterParaInput === 'function') {
                      window.converterParaInput(nomeEl);
                    }
                  }
                }
              }, 800); // Aumentado para 800ms para dar tempo do app.js processar
            }).catch((error) => {
              clearTimeout(timeout);
              console.error('‚ùå Erro ao carregar nomes:', error);
              // Em caso de erro, converter para INPUT para permitir digita√ß√£o manual
              const nomeEl = document.getElementById('nome');
              if (nomeEl && nomeEl.tagName === 'SELECT') {
                if (typeof window.converterParaInput === 'function') {
                  window.converterParaInput(nomeEl);
                }
              }
            });
          }
        });
      }
      
      // Reset quando instrumento mudar
      if (instrumentoSelect) {
        instrumentoSelect.addEventListener('change', function() {
          if (window.resetNomeState) {
            window.resetNomeState();
          }
          // Carregar nomes quando instrumento mudar
          const comum = document.getElementById('comumInput')?.value?.trim();
          const cargo = document.getElementById('cargo')?.value?.trim();
          if (comum && cargo && typeof loadNomes === 'function') {
            loadNomes().then(() => {
              // Aguardar e popular SELECT diretamente ou converter para INPUT se n√£o houver nomes
              setTimeout(() => {
                if (window.nomesData && Array.isArray(window.nomesData)) {
                  // Sempre chamar popularSelectNome - ela vai decidir se popula SELECT ou converte para INPUT
                  if (typeof window.popularSelectNome === 'function') {
                    window.popularSelectNome(window.nomesData);
                  }
                } else {
                  // Se window.nomesData n√£o existe ou n√£o √© array, converter para INPUT
                  const nomeEl = document.getElementById('nome');
                  if (nomeEl && nomeEl.tagName === 'SELECT') {
                    if (typeof window.converterParaInput === 'function') {
                      window.converterParaInput(nomeEl);
                    }
                  }
                }
              }, 500);
            });
          }
        });
      }
    }

    // Fun√ß√£o para configurar busca de nomes
    function setupNomeSearch() {
      const nomeInput = document.getElementById('nome');
      if (!nomeInput) return;

      // Dados de exemplo para nomes
      const nomesData = [
        'Jo√£o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 'Carlos Pereira',
        'Lucia Ferreira', 'Roberto Alves', 'Fernanda Lima', 'Ricardo Grangeiro', 'Vanessa Santos',
        'Paulo Souza', 'Juliana Martins', 'Marcos Rodrigues', 'Camila Barbosa', 'Diego Silva',
        'Patricia Gomes', 'Rafael Santos', 'Larissa Oliveira', 'Thiago Costa', 'Beatriz Almeida'
      ];

      let searchTimeout;
      let currentResults = [];

      // Fun√ß√£o de busca
      function searchNomes(query) {
        if (!query || query.length < 2) {
          return [];
        }
        
        const term = query.toLowerCase();
        return nomesData.filter(nome => 
          nome.toLowerCase().includes(term)
        ).slice(0, 8);
      }

      // üö® REMOVIDO: Fun√ß√£o duplicada showNomeResults - usar apenas showSuggestionsWithManualOption
      // Event listeners duplicados tamb√©m removidos - j√° existem anteriormente no c√≥digo
    }

    // üö® REMOVIDO PERMANENTEMENTE: Fun√ß√£o loadSampleData n√£o deve ser usada
    // Os cargos devem ser carregados apenas via loadCargosFixed() do app.js
    // Os instrumentos devem ser carregados apenas via loadInstrumentosFixed() do app.js
    function loadSampleData() {
      console.warn('‚ö†Ô∏è loadSampleData foi desabilitada - use loadCargosFixed() e loadInstrumentosFixed() do app.js');
      // N√£o fazer nada - fun√ß√£o desabilitada permanentemente
      return;
    }

    // Fun√ß√£o para configurar detec√ß√£o de conectividade
    function setupConnectivityDetection() {
      // Event listener para quando voltar online
      window.addEventListener('online', () => {
        console.log('üåê Conex√£o restaurada');
        
        // Atualizar status visual
        const statusBtn = document.getElementById('statusBtn');
        if (statusBtn) {
          statusBtn.classList.add('status-online');
          statusBtn.classList.remove('status-offline');
          statusBtn.textContent = 'üì∂';
        }
        
        // Processar fila offline ap√≥s um pequeno delay
        setTimeout(() => {
          console.log('üîÑ Tentando processar fila offline...');
          processOfflineQueueTest();
        }, 2000);
      });

      // Event listener para quando ficar offline
      window.addEventListener('offline', () => {
        console.log('üì¥ Conex√£o perdida');
        
        // Atualizar status visual
        const statusBtn = document.getElementById('statusBtn');
        if (statusBtn) {
          statusBtn.classList.remove('status-online');
          statusBtn.classList.add('status-offline');
          statusBtn.textContent = 'üìµ';
        }
      });

      // Verificar status inicial
      if (navigator.onLine) {
        const statusBtn = document.getElementById('statusBtn');
        if (statusBtn) {
          statusBtn.classList.add('status-online');
          statusBtn.classList.remove('status-offline');
          statusBtn.textContent = 'üì∂';
        }
      } else {
        const statusBtn = document.getElementById('statusBtn');
        if (statusBtn) {
          statusBtn.classList.remove('status-online');
          statusBtn.classList.add('status-offline');
          statusBtn.textContent = 'üìµ';
        }
      }
    }

    // Inicializa√ß√£o do sistema
    $(document).ready(function() {
      // Usar configura√ß√µes centralizadas
      if (typeof initializeSystem === 'function') {
        initializeSystem();
      }

      // Inicializar status como online
      const statusBtn = document.getElementById('statusBtn');
      if (statusBtn) {
        statusBtn.classList.add('status-online');
      }

      // Configurar busca de comuns
      setupComumSearch();
      
      // Configurar busca de nomes
      setupNomeSearch();
      
      // üö® REMOVIDO PERMANENTEMENTE: loadSampleData() n√£o deve ser chamada
      // Os cargos devem ser carregados apenas via loadCargosFixed() do app.js
      // Os instrumentos devem ser carregados apenas via loadInstrumentosFixed() do app.js
      // loadSampleData(); // DESABILITADO PERMANENTEMENTE

      // Configurar detec√ß√£o de conectividade
      setupConnectivityDetection();

      // Inicializar contador da fila
      updateQueueCountTest();
      
      // Configurar controle do modal
      if (typeof setupModalControl === 'function') {
        setupModalControl();
      }
      
      // Configurar controle do modal (usando configura√ß√µes centralizadas)
      if (typeof ensureModalsClosed === 'function') {
        ensureModalsClosed();
      }
      
      // DESABILITADO: Iniciar processamento autom√°tico da fila
      // startAutomaticQueueProcessing(); // Comentado para evitar conflito com app.js
      
      // Testar funcionalidades ap√≥s 3 segundos
      setTimeout(() => {
        testarFuncionalidades();
      }, 3000);


      // Aguarda um pouco mais para garantir que o app.js carregou
      setTimeout(function() {
        // Controle de visibilidade do instrumento agora √© feito pelo app.js
        
        // Configura entrada manual de nomes
        setupNomeManual();
        
      // Configurar reset do estado do nome quando comum/cargo/instrumento mudarem
      setupNomeStateReset();
      
      // üö® CORRE√á√ÉO CR√çTICA: Interceptar clearForm para resetar campo nome corretamente
      const originalClearForm = window.clearForm;
      if (typeof originalClearForm === 'function') {
        window.clearForm = function() {
          console.log('üîÑ clearForm chamado - resetando campo nome...');
          
          // Resetar campo nome ANTES de limpar o formul√°rio
          if (typeof window.resetarCampoNome === 'function') {
            window.resetarCampoNome();
          }
          
          // Chamar fun√ß√£o original
          originalClearForm.call(this);
          
          // Garantir que ap√≥s limpar, o campo nome esteja pronto
          setTimeout(() => {
            const nomeSelect = document.getElementById('nome');
            if (nomeSelect && nomeSelect.tagName === 'SELECT') {
              // Garantir que o SELECT est√° vazio e pronto
              if (nomeSelect.options.length === 0 || nomeSelect.options[0].value === '') {
                nomeSelect.innerHTML = '<option value="">Selecione um nome da lista...</option>';
              }
            }
          }, 100);
        };
      } else {
        // Se clearForm n√£o existir, criar uma vers√£o que reseta o campo nome
        window.clearForm = function() {
          console.log('üîÑ clearForm chamado (criado) - resetando campo nome...');
          if (typeof window.resetarCampoNome === 'function') {
            window.resetarCampoNome();
          }
        };
      }
      
      // üö® CORRE√á√ÉO: Monitorar mudan√ßas em comum/cargo ap√≥s envio
      const comumInput = document.getElementById('comumInput');
      const cargoSelect = document.getElementById('cargo');
      
      if (comumInput && cargoSelect) {
        // Observar mudan√ßas ap√≥s limpar formul√°rio
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
              const comum = comumInput.value.trim();
              const cargo = cargoSelect.value.trim();
              
              // Se ambos estiverem preenchidos, carregar nomes
              if (comum && cargo && typeof loadNomes === 'function') {
                setTimeout(() => {
                  loadNomes().then(() => {
                    setTimeout(() => {
                      if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                        if (typeof window.popularSelectNome === 'function') {
                          window.popularSelectNome(window.nomesData);
                        }
                      }
                    }, 300);
                  });
                }, 200);
              }
            }
          });
        });
        
        // Observar mudan√ßas de valor
        comumInput.addEventListener('change', function() {
          const comum = comumInput.value.trim();
          const cargo = cargoSelect.value.trim();
          if (comum && cargo && typeof loadNomes === 'function') {
            loadNomes().then(() => {
              setTimeout(() => {
                if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                  if (typeof window.popularSelectNome === 'function') {
                    window.popularSelectNome(window.nomesData);
                  }
                }
              }, 300);
            });
          }
        });
        
        cargoSelect.addEventListener('change', function() {
          const comum = comumInput.value.trim();
          const cargo = cargoSelect.value.trim();
          if (comum && cargo && typeof loadNomes === 'function') {
            loadNomes().then(() => {
              setTimeout(() => {
                if (window.nomesData && Array.isArray(window.nomesData) && window.nomesData.length > 0) {
                  if (typeof window.popularSelectNome === 'function') {
                    window.popularSelectNome(window.nomesData);
                  }
                }
              }, 300);
            });
          }
        });
      }
      
      // Verifica√ß√£o de emerg√™ncia para garantir que o campo de nome est√° habilitado
      verificarCampoNome();
      }, 1000);
      
      // Verifica√ß√£o cont√≠nua para garantir que o campo de nome est√° sempre habilitado
      setInterval(verificarCampoNome, 2000);
      
      // DESABILITAR processamento autom√°tico do index.html para evitar conflito com app.js
      // O app.js j√° tem seu pr√≥prio sistema de processamento mais robusto
      console.log('‚ö†Ô∏è Processamento autom√°tico do index.html desabilitado - usando sistema do app.js');
    });
    
    // Fun√ß√£o de debug para verificar conflitos do modal
    function debugModalIssues() {
      console.log('üîç DEBUG: Verificando poss√≠veis conflitos...');
      
      // Verificar se h√° CSS que pode estar bloqueando
      const modal = document.getElementById('modalNovaComum');
      if (modal) {
        const computedStyle = window.getComputedStyle(modal);
        console.log('üîç Estilo computado do modal:', {
          display: computedStyle.display,
          visibility: computedStyle.visibility,
          pointerEvents: computedStyle.pointerEvents,
          zIndex: computedStyle.zIndex,
          position: computedStyle.position
        });
        
        // Verificar se h√° elementos sobrepostos
        const rect = modal.getBoundingClientRect();
        console.log('üîç Posi√ß√£o do modal:', {
          top: rect.top,
          left: rect.left,
          width: rect.width,
          height: rect.height
        });
        
        // Verificar se h√° elementos com z-index maior
        const allElements = document.querySelectorAll('*');
        const highZIndexElements = Array.from(allElements).filter(el => {
          const zIndex = window.getComputedStyle(el).zIndex;
          return zIndex !== 'auto' && parseInt(zIndex) > 1050; // Bootstrap modal z-index
        });
        
        console.log('üîç Elementos com z-index maior que modal:', highZIndexElements.length);
        highZIndexElements.forEach((el, index) => {
          if (index < 5) { // Mostrar apenas os primeiros 5
            console.log(`   - ${el.tagName}#${el.id || el.className}: z-index ${window.getComputedStyle(el).zIndex}`);
          }
        });
      }
      
      // Verificar se h√° JavaScript bloqueando eventos
      const body = document.body;
      console.log('üîç Event listeners no body:', {
        onclick: body.onclick ? 'presente' : 'ausente',
        onmousedown: body.onmousedown ? 'presente' : 'ausente',
        onmouseup: body.onmouseup ? 'presente' : 'ausente'
      });
    }
    
    // Expor fun√ß√£o de debug globalmente
    window.debugModalIssues = debugModalIssues;
    
    // CORRE√á√ÉO DE EMERG√äNCIA: Fun√ß√£o para corrigir modal manualmente
    window.corrigirModal = function() {
      console.log('üö® CORRE√á√ÉO DE EMERG√äNCIA DO MODAL');
      
      const modal = document.getElementById('modalNovaComum');
      if (modal) {
        // For√ßar corre√ß√£o do aria-hidden
        modal.setAttribute('aria-hidden', 'false');
        modal.setAttribute('aria-modal', 'true');
        
        // For√ßar interatividade
        modal.style.pointerEvents = 'auto';
        modal.style.zIndex = '1055';
        modal.style.display = 'block';
        
        // Corrigir todos os elementos internos
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          modalContent.style.pointerEvents = 'auto';
          modalContent.style.zIndex = '1056';
        }
        
        // Corrigir inputs
        const inputs = modal.querySelectorAll('input, select, textarea, button');
        inputs.forEach(input => {
          input.style.pointerEvents = 'auto';
          input.disabled = false;
          input.readOnly = false;
        });
        
        // Remover backdrops problem√°ticos
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
          backdrop.style.pointerEvents = 'none';
        });
        
        console.log('‚úÖ Modal corrigido de emerg√™ncia!');
        return true;
      } else {
        console.error('‚ùå Modal n√£o encontrado!');
        return false;
      }
    };
    
    // CORRE√á√ÉO: Fun√ß√£o para limpar backdrops √≥rf√£os que causam escurecimento
    window.limparBackdrops = function() {
      console.log('üßπ Limpando backdrops √≥rf√£os...');
      
      const backdrops = document.querySelectorAll('.modal-backdrop');
      console.log('üîç Backdrops encontrados:', backdrops.length);
      
      // Se h√° backdrops mas nenhum modal aberto, remover todos
      const modalsAbertos = document.querySelectorAll('.modal.show');
      if (modalsAbertos.length === 0 && backdrops.length > 0) {
        console.log('‚ö†Ô∏è Backdrops √≥rf√£os detectados - removendo todos');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Limpar classes do body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        console.log('‚úÖ Backdrops √≥rf√£os removidos!');
        return true;
      }
      
      return false;
    };
    
    // CORRE√á√ÉO MOBILE: Fun√ß√£o para configurar modal no mobile
    window.configurarModalMobile = function() {
      if (window.innerWidth <= 768) {
        console.log('üì± Configurando modal para mobile...');
        
        const modal = document.getElementById('modalNovaComum');
        if (modal) {
          // Configurar modal principal
          modal.style.touchAction = 'pan-y';
          modal.style.overflowY = 'auto';
          modal.style.webkitOverflowScrolling = 'touch';
          
          // Configurar modal-content
          const modalContent = modal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.style.maxHeight = '90vh';
            modalContent.style.overflow = 'hidden';
            modalContent.style.display = 'flex';
            modalContent.style.flexDirection = 'column';
          }
          
          // Configurar modal-body
          const modalBody = modal.querySelector('.modal-body');
          if (modalBody) {
            modalBody.style.overflowY = 'auto';
            modalBody.style.webkitOverflowScrolling = 'touch';
            modalBody.style.flex = '1';
            modalBody.style.minHeight = '0';
            modalBody.style.touchAction = 'pan-y';
          }
          
          console.log('‚úÖ Modal configurado para mobile');
        }
      }
    };
  </script>
<script>
// üîß CORRE√á√ÉO DEFINITIVA PARA MODAL NO AMBIENTE ONLINE
(function() {
  console.log('üîß Aplicando corre√ß√µes para modal online/mobile...');
  
  // 1. Limpar event listeners duplicados
  function setupModalSafely() {
    const btnAbrirModal = document.getElementById('btnAbrirModal');
    const modal = document.getElementById('modalNovaComum');
    
    if (!btnAbrirModal || !modal) {
      console.error('‚ùå Elementos do modal n√£o encontrados');
      return;
    }
    
    // Remover TODOS os event listeners existentes clonando o elemento
    const newBtn = btnAbrirModal.cloneNode(true);
    btnAbrirModal.parentNode.replaceChild(newBtn, btnAbrirModal);
    
    // Adicionar apenas UM event listener limpo
    newBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openModalSafely();
    });
    
    console.log('‚úÖ Event listener √∫nico configurado');
  }
  
  // 2. Fun√ß√£o segura para abrir modal
  function openModalSafely() {
    const modal = document.getElementById('modalNovaComum');
    if (!modal) return;
    
    console.log('üìÇ Abrindo modal de forma segura...');
    
    // Limpar estado anterior
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    
    // Remover backdrops existentes
    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
    
    // Aguardar limpeza antes de abrir
    setTimeout(() => {
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        try {
          // Destruir inst√¢ncia anterior
          const oldInstance = bootstrap.Modal.getInstance(modal);
          if (oldInstance) oldInstance.dispose();
          
          // Criar nova inst√¢ncia
          const modalInstance = new bootstrap.Modal(modal, {
            backdrop: true, // Permitir clique fora para fechar
            keyboard: true,
            focus: true
          });
          
          // Abrir modal
          modalInstance.show();
          
          // ‚úÖ CORRE√á√ÉO CR√çTICA: Garantir interatividade ap√≥s abrir
          modal.addEventListener('shown.bs.modal', function onceShown() {
            console.log('‚úÖ Modal aberto - aplicando corre√ß√µes de interatividade...');
            
            // Garantir que modal e conte√∫do sejam clic√°veis
            modal.style.pointerEvents = 'auto';
            modal.style.zIndex = '1055';
            
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.style.pointerEvents = 'auto';
              modalContent.style.zIndex = '1056';
            }
            
            // Garantir que inputs sejam interativos
            modal.querySelectorAll('input, select, textarea, button').forEach(el => {
              el.style.pointerEvents = 'auto';
              el.disabled = false;
              el.readOnly = false;
            });
            
            // Carregar dados
            setTimeout(() => {
              if (typeof loadComunsForModal === 'function') {
                loadComunsForModal();
              }
            }, 200);
            
            // Remover listener para evitar duplica√ß√£o
            modal.removeEventListener('shown.bs.modal', onceShown);
          }, { once: true });
          
          console.log('‚úÖ Modal aberto com sucesso');
          
        } catch (error) {
          console.error('‚ùå Erro ao abrir modal:', error);
          alert('Erro ao abrir o formul√°rio. Por favor, recarregue a p√°gina.');
        }
      } else {
        console.error('‚ùå Bootstrap n√£o dispon√≠vel');
        alert('Sistema n√£o carregado. Por favor, recarregue a p√°gina.');
      }
    }, 100);
  }
  
  // 3. Corrigir backdrop bloqueando intera√ß√£o
  function fixBackdrop() {
    const observer = new MutationObserver(() => {
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        // Backdrop deve apenas escurecer o fundo, n√£o bloquear cliques
        backdrop.style.pointerEvents = 'none';
      });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
  }
  
  // 4. Resetar flag de processamento em caso de erro
  window.addEventListener('error', function() {
    if (typeof isProcessing !== 'undefined') {
      isProcessing = false;
      console.log('üîÑ Flag de processamento resetada ap√≥s erro');
    }
  });
  
  // 5. Inicializar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        setupModalSafely();
        fixBackdrop();
        console.log('‚úÖ Corre√ß√µes aplicadas com sucesso');
      }, 1000);
    });
  } else {
    setTimeout(() => {
      setupModalSafely();
      fixBackdrop();
      console.log('‚úÖ Corre√ß√µes aplicadas com sucesso');
    }, 1000);
  }
  
  // 6. Expor fun√ß√£o globalmente para debug
  window.forceOpenModal = openModalSafely;
  window.debugModal = function() {
    const modal = document.getElementById('modalNovaComum');
    console.log('üîç Debug do modal:', {
      existe: !!modal,
      display: modal?.style.display,
      classList: modal?.classList.toString(),
      pointerEvents: modal?.style.pointerEvents,
      zIndex: modal?.style.zIndex,
      bootstrapDisponivel: typeof bootstrap !== 'undefined'
    });
  };
  
})();
</script>

<!-- Removido: chamadas de debug/for√ßar abertura do modal em produ√ß√£o -->

</body>
</html>
</body>
</html>
</html>